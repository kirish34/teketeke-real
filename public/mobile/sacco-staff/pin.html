<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>SACCO Staff PIN - TekeTeke Go</title>
  <link rel="manifest" href="../shared/manifest.json"/>
  <link rel="stylesheet" href="/public/mobile/theme.css"/>
  <script src="/public/js/app-config.js"></script>
  <style>
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:linear-gradient(180deg,#0ea5e9 0,#e0f2fe 40%,#f9fafb 80%);
      color:#0f172a;
      -webkit-font-smoothing:antialiased;
    }
    .pin-app{
      max-width:480px;
      margin:0 auto;
      padding:40px 16px 28px;
      min-height:100vh;
      display:flex;
      flex-direction:column;
      gap:18px;
    }
    .pin-hero{
      border-radius:28px;
      padding:20px 18px 22px;
      background:linear-gradient(135deg,#0ea5e9,#0284c7);
      color:#f9fafb;
      box-shadow:0 26px 60px rgba(15,23,42,.45);
    }
    .pin-hero h1{
      margin:0;
      font-size:22px;
      font-weight:750;
    }
    .pin-hero p{
      margin:6px 0 0;
      font-size:13px;
      opacity:.92;
    }
    .pin-card{
      border-radius:22px;
      padding:16px 14px 18px;
      background:rgba(255,255,255,.96);
      box-shadow:0 18px 40px rgba(15,23,42,.18);
    }
    .pin-card h2{
      margin:0 0 8px;
      font-size:17px;
      font-weight:700;
    }
    .pin-hint{
      margin:0 0 12px;
      font-size:13px;
      color:#6b7280;
    }
    .pin-input{
      display:flex;
      justify-content:center;
      margin:4px 0 10px;
    }
    .pin-input input{
      letter-spacing:0.4em;
      text-align:center;
      font-size:20px;
      padding:10px 6px;
      border-radius:14px;
      border:1px solid #e5e7eb;
      width:160px;
      background:#ffffff;
    }
    .pin-actions{
      display:flex;
      gap:8px;
      margin-top:6px;
    }
    .btn-primary,
    .btn-ghost,
    .btn-danger{
      flex:1;
      border-radius:999px;
      border:1px solid transparent;
      padding:9px 14px;
      font-size:13px;
      font-weight:650;
      cursor:pointer;
    }
    .btn-primary{
      background:linear-gradient(135deg,#22c55e,#16a34a);
      color:#022c22;
      box-shadow:0 12px 30px rgba(22,163,74,.6);
    }
    .btn-ghost{
      background:#f1f5f9;
      color:#0f172a;
      border-color:#e2e8f0;
    }
    .btn-danger{
      background:#b91c1c;
      color:#fef2f2;
    }
    .pin-msg{
      margin-top:6px;
      min-height:16px;
      font-size:13px;
      color:#b91c1c;
    }
    .pin-msg.ok{
      color:#16a34a;
    }
  </style>
</head>
<body>
  <div class="pin-app">
    <header class="pin-hero">
      <h1>SACCO device PIN</h1>
      <p>Protect this SACCO staff console with a 4‑digit PIN on this device.</p>
    </header>

    <section class="pin-card" id="unlockCard">
      <h2>Unlock</h2>
      <p class="pin-hint">Enter the 4‑digit PIN for this device to open the SACCO Staff console.</p>
      <div class="pin-input">
        <input id="pin_unlock" type="password" inputmode="numeric" pattern="[0-9]*" maxlength="4" autocomplete="off"/>
      </div>
      <div class="pin-actions">
        <button id="btn_unlock" class="btn-primary" type="button">Unlock</button>
      </div>
      <div id="unlock_msg" class="pin-msg"></div>
    </section>

    <section class="pin-card" id="setupCard">
      <h2>Set / change PIN</h2>
      <p class="pin-hint">Choose a 4‑digit PIN for this device. It does not replace your account password.</p>
      <div class="pin-input">
        <input id="pin_new" type="password" inputmode="numeric" pattern="[0-9]*" maxlength="4" placeholder="New PIN"/>
      </div>
      <div class="pin-input">
        <input id="pin_confirm" type="password" inputmode="numeric" pattern="[0-9]*" maxlength="4" placeholder="Confirm PIN"/>
      </div>
      <div class="pin-actions">
        <button id="btn_save" class="btn-ghost" type="button">Save PIN</button>
        <button id="btn_clear" class="btn-danger" type="button">Clear PIN</button>
      </div>
      <div id="setup_msg" class="pin-msg"></div>
    </section>
  </div>

  <script>
    (async function(){
      const PIN_STORAGE_KEY = 'tt_sacco_device_pin_v1';
      const PIN_SESSION_KEY = 'tt_sacco_device_pin_ok';
      const NEXT_URL = '/public/mobile/sacco-staff/index.html';

      async function hashPin(pin){
        try{
          if (window.crypto && window.crypto.subtle && window.TextEncoder){
            const data = new TextEncoder().encode(pin);
            const buf = await window.crypto.subtle.digest('SHA-256', data);
            return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
          }
        }catch(_){}
        return 'pin:' + pin;
      }

      function fmtMsg(el, text, ok){
        if (!el) return;
        el.textContent = text || '';
        el.classList.toggle('ok', !!ok);
      }

      function redirectToApp(){
        window.location.replace(NEXT_URL);
      }

      // If already unlocked this session, skip straight to console.
      (function checkSession(){
        try{
          const stored = localStorage.getItem(PIN_STORAGE_KEY);
          const ok = sessionStorage.getItem(PIN_SESSION_KEY);
          if (stored && ok && stored === ok){
            redirectToApp();
          }
        }catch(_){}
      })();

      const unlockInput = document.getElementById('pin_unlock');
      const unlockBtn = document.getElementById('btn_unlock');
      const unlockMsg = document.getElementById('unlock_msg');

      const newInput = document.getElementById('pin_new');
      const confirmInput = document.getElementById('pin_confirm');
      const saveBtn = document.getElementById('btn_save');
      const clearBtn = document.getElementById('btn_clear');
      const setupMsg = document.getElementById('setup_msg');

      const unlockCard = document.getElementById('unlockCard');
      const setupCard = document.getElementById('setupCard');

      function refreshVisibility(){
        const hasPin = !!localStorage.getItem(PIN_STORAGE_KEY);
        if (unlockCard) unlockCard.style.display = hasPin ? '' : 'none';
        if (setupCard) setupCard.style.display = '';
      }
      refreshVisibility();

      async function tryUnlock(){
        const val = (unlockInput.value || '').trim();
        if (!/^[0-9]{4}$/.test(val)){
          fmtMsg(unlockMsg, 'PIN must be 4 digits');
          return;
        }
        const stored = localStorage.getItem(PIN_STORAGE_KEY);
        if (!stored){
          fmtMsg(unlockMsg, 'No PIN set on this device yet');
          return;
        }
        const hash = await hashPin(val);
        if (hash === stored){
          try{
            sessionStorage.setItem(PIN_SESSION_KEY, stored);
          }catch(_){}
          fmtMsg(unlockMsg, '');
          redirectToApp();
        }else{
          fmtMsg(unlockMsg, 'Incorrect PIN');
          unlockInput.value = '';
          unlockInput.focus();
        }
      }

      if (unlockBtn && unlockInput){
        unlockBtn.addEventListener('click', (e)=>{ e.preventDefault(); tryUnlock(); });
        unlockInput.addEventListener('keydown', (e)=>{ if (e.key === 'Enter'){ e.preventDefault(); tryUnlock(); } });
      }

      async function savePin(){
        const a = (newInput.value || '').trim();
        const b = (confirmInput.value || '').trim();
        if (!/^[0-9]{4}$/.test(a)){
          fmtMsg(setupMsg, 'PIN must be exactly 4 digits.');
          return;
        }
        if (a !== b){
          fmtMsg(setupMsg, 'PIN values do not match.');
          return;
        }
        const hash = await hashPin(a);
        try{
          localStorage.setItem(PIN_STORAGE_KEY, hash);
          sessionStorage.removeItem(PIN_SESSION_KEY);
        }catch(_){}
        newInput.value = '';
        confirmInput.value = '';
        fmtMsg(setupMsg, 'PIN saved for this device.', true);
        refreshVisibility();
      }

      function clearPin(){
        try{
          localStorage.removeItem(PIN_STORAGE_KEY);
          sessionStorage.removeItem(PIN_SESSION_KEY);
        }catch(_){}
        fmtMsg(setupMsg, 'PIN cleared for this device.', true);
        refreshVisibility();
      }

      if (saveBtn) saveBtn.addEventListener('click', (e)=>{ e.preventDefault(); savePin(); });
      if (clearBtn) clearBtn.addEventListener('click', (e)=>{ e.preventDefault(); clearPin(); });
    })();
  </script>
</body>
</html>

