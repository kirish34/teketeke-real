<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TekeTeke - Boda Boda Console</title>

  <link rel="stylesheet" href="/public/css/dashboard-theme.css"/>
  <script src="/public/js/app-config.js"></script>
  <script src="/public/js/api.js"></script>
  <script src="/public/js/role-guard.js"></script>
</head>
<body>
<header class="hero-card">

  <div class="hero-stack brand-stack">

    <p class="eyebrow">Boda Console</p>

    <h1 style="margin:0">Boda Boda Console</h1>

    <div class="hello" id="welcomeLine">Hello, Rider</div>

    <div class="timestamp" id="dateTimeLine">--</div>

  </div>

  <div class="hero-actions">

    <span id="auth_state" class="pill" style="max-width:40vw;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">Checking sign-in.</span>

    <button id="logoutBtn" class="btn bad">Logout</button>

  </div>

</header>

  <div class="tabs">
    <button class="tab active" type="button" data-panel="today">Today</button>
    <button class="tab" type="button" data-panel="cashin">Cash In</button>
    <button class="tab" type="button" data-panel="expenses">Expenses</button>
    <button class="tab" type="button" data-panel="insights">Insights</button>
    <button class="tab" type="button" data-panel="goals">Goals</button>
    <button class="tab" type="button" data-panel="automation">Automation</button>
  </div>

  <section id="panel-today" class="panel active">
    <h2>Today</h2>
    <div class="kpis">
      <div class="kpi"><div class="v" id="kpiTill">-</div><div class="l">Till (M-Pesa) Today</div></div>
      <div class="kpi"><div class="v" id="kpiCash">-</div><div class="l">Cash Today</div></div>
      <div class="kpi"><div class="v" id="kpiExp">-</div><div class="l">Expenses Today</div></div>
      <div class="kpi"><div class="v" id="kpiNet">-</div><div class="l">Net Today</div></div>
    </div>
    <div class="hint" id="sumHint">Refreshing...</div>
  </section>

  <section id="panel-cashin" class="panel">
    <h2>Cash In</h2>
    <div class="section">
      <h3>Collect Cash</h3>
      <div class="grid-2">
        <div>
          <label for="cashAmount">Amount (KES)</label>
          <input id="cashAmount" type="number" min="0" placeholder="e.g., 150" />
          <label for="payerName">Payer Name</label>
          <input id="payerName" type="text" placeholder="optional" />
          <label for="payerPhone">Phone</label>
          <input id="payerPhone" type="tel" inputmode="numeric" placeholder="07xx (optional)" />
          <label for="cashNotes">Notes</label>
          <textarea id="cashNotes" placeholder="optional"></textarea>
          <button id="btnCash">Collect Cash</button>
          <div id="cashMsg" class="hint"></div>
        </div>
      </div>
    </div>

    <div class="section">
      <h3>Recent Cash Receipts</h3>
      <table>
        <thead><tr><th>Time</th><th>Payer</th><th>Phone</th><th>Amount</th><th>Notes</th></tr></thead>
        <tbody id="cashBody"></tbody>
      </table>
    </div>
  </section>

  <section id="panel-expenses" class="panel">
    <h2>Expenses</h2>
    <div class="section">
      <h3>Enter Expense</h3>
      <div class="grid-2">
        <div>
          <label for="expCat">Category</label>
          <select id="expCat">
            <option value="Fuel">Fuel</option>
            <option value="Maintenance">Maintenance</option>
            <option value="Parking">Parking</option>
            <option value="Airtime">Airtime</option>
            <option value="Food">Food</option>
            <option value="Liquor">Liquor</option>
            <option value="Other">Other</option>
          </select>
          <label for="expAmount">Amount (KES)</label>
          <input id="expAmount" type="number" min="0" placeholder="e.g., 50" />
          <label for="expNotes">Notes</label>
          <textarea id="expNotes" placeholder="optional"></textarea>
          <button id="btnExpense">Save Expense</button>
          <div id="expMsg" class="hint"></div>
        </div>
      </div>
    </div>

    <div class="section">
      <h3>Recent Expenses</h3>
      <table>
        <thead><tr><th>Time</th><th>Category</th><th>Amount</th><th>Notes</th></tr></thead>
        <tbody id="expBody"></tbody>
      </table>
    </div>
  </section>

  <section id="panel-insights" class="panel">
    <h2>Insights</h2>
    <div class="section">
      <h3>Finance Overview</h3>
      <div class="kpis">
        <div class="kpi">
          <div class="l">This Week (KSh)</div>
          <div class="v" id="kWeekNet">?</div>
          <div class="hint" id="kWeekDetail">Income ?, Expenses ?</div>
        </div>
        <div class="kpi">
          <div class="l">This Month (KSh)</div>
          <div class="v" id="kMonthNet">?</div>
          <div class="hint" id="kMonthDetail">Income ?, Expenses ?</div>
        </div>
        <div class="kpi">
          <div class="l">Avg Net / Day</div>
          <div class="v" id="kAvgNet">?</div>
          <div class="hint" id="kAvgNetDetail">Based on recent days</div>
        </div>
        <div class="kpi">
          <div class="l">Expense Ratio</div>
          <div class="v" id="kExpRatio">?</div>
          <div class="hint" id="kExpRatioDetail">Expenses as % of income</div>
        </div>
      </div>
    </div>
    <div class="section">
      <h3>Expense Breakdown (today)</h3>
      <table>
        <thead><tr><th>Category</th><th>Amount (KES)</th></tr></thead>
        <tbody id="expSummaryBody">
          <tr><td colspan="2" class="hint">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </section>

  <section id="panel-goals" class="panel">
    <h2>Goals</h2>
    <div class="card">
      <div class="grid-2">
        <div>
          <label for="savingsTarget">Monthly savings target (KSh)</label>
          <input id="savingsTarget" type="number" min="0" placeholder="e.g. 20000" />
          <button id="btnSaveTarget">Save Target</button>
          <div id="savingsMsg" class="hint"></div>
        </div>
        <div>
          <p class="hint" id="savingsSummary">Loading target...</p>
        </div>
      </div>
    </div>
  </section>

  <section id="panel-automation" class="panel">
    <h2>Automation (Android app)</h2>
    <div class="card">
      <p class="hint">
        On the Android app, TekeTeke can (with your permission) read M-Pesa SMS on this device,
        then suggest cash and expense entries automatically. This does not work in the browser.
      </p>
      <div class="row" style="align-items:center;gap:8px">
        <button id="btnMpesaEnable" class="btn" type="button">Enable M-Pesa auto-import</button>
        <button id="btnMpesaSync" class="btn ghost" type="button">Sync new M-Pesa SMS now</button>
      </div>
      <div id="mpesaStatus" class="hint" style="margin-top:6px;">Status: Not available (web browser).</div>
    </div>
  </section>

  <footer style="max-width:1100px;margin:24px auto 0;">
    <div class="card" style="text-align:center;">
      <p class="hint" style="margin:0 0 8px;">Prefer the Android app?</p>
      <a class="btn" href="/public/downloads/teketeke-go-boda.apk" download>Download Boda App (APK)</a>
    </div>
  </footer>

  <script>
    (function(){
      function $(id){ return document.getElementById(id); }
      const fmt = (n)=> new Intl.NumberFormat('en-KE',{maximumFractionDigits:0}).format(Number(n||0));

      function friendlyName(user){
        if(!user) return 'Rider';
        const meta = user.user_metadata || {};
        const email = user.email || '';
        return meta.full_name || meta.name || meta.display_name || meta.displayName || (email ? email.split('@')[0] : 'Rider');
      }

      function startClock(){
        const el = $('dateTimeLine');
        if(!el) return;
        const update = ()=>{ el.textContent = new Date().toLocaleString(); };
        update();
        setInterval(update, 1000);
      }

      async function getAuthHeader(){
        try{
          if (window.TT && typeof TT.getAuth === 'function'){
            const t = TT.getAuth(); if (t) return { Authorization:'Bearer '+t };
          }
          if (window.TT && typeof TT.getSupabase === 'function'){
            const supa = await TT.getSupabase();
            const { data:{ session } } = await supa.auth.getSession();
            if (session?.access_token) return { Authorization:'Bearer '+session.access_token };
          }
        }catch(_){ }
        return {};
      }

      async function authFetch(url, opts={}){
        const headers = { 'Content-Type':'application/json', ...(opts.headers||{}), ...(await getAuthHeader()) };
        const res = await fetch(url, { ...opts, headers });
        if(!res.ok){
          let msg = res.status+' '+res.statusText; try{ const j = await res.clone().json(); msg = j.error||j.message||msg; }catch{ }
          throw new Error(msg);
        }
        const ct = res.headers.get('content-type')||'';
        return ct.includes('application/json') ? res.json() : res.text();
      }

      function bindTabs(){
        const tabs = document.querySelectorAll('.tabs .tab');
        const panels = document.querySelectorAll('.panel');
        tabs.forEach(tab=>{
          tab.addEventListener('click', ()=>{
            const key = tab.getAttribute('data-panel');
            tabs.forEach(t=>t.classList.remove('active'));
            tab.classList.add('active');
            panels.forEach(p=>{
              if (p.id === 'panel-' + key) p.classList.add('active');
              else p.classList.remove('active');
            });
          });
        });
      }

      async function refreshSummary(){
        $('sumHint').textContent = 'Refreshing...';
        try{
          const today = new Date().toISOString().slice(0,10);
          const data = await authFetch(`/api/boda/summary?date=${today}`);
          const s = data?.summary || data || {};
          const till = s.till_today || 0;
          const cash = s.cash_today || 0;
          const exp  = s.expenses_today || s.exp_today || 0;
          $('kpiTill').textContent = fmt(till);
          $('kpiCash').textContent = fmt(cash);
          $('kpiExp').textContent  = fmt(exp);
          $('kpiNet').textContent  = fmt(Number(till) + Number(cash) - Number(exp));
          $('sumHint').textContent = '';
        }catch(e){
          $('sumHint').textContent = 'No summary (check permissions).';
        }
      }

      function filterToday(rows){
        const today = new Date();
        const start = new Date(today.toISOString().slice(0,10) + 'T00:00:00.000Z').getTime();
        const end = start + 24*3600*1000;
        return (rows||[]).filter(r=>{
          const t = r.created_at || r.time || r.timestamp;
          if(!t) return false;
          const x = new Date(t).getTime();
          return x >= start && x < end;
        });
      }

      function renderTableRows(rows, tbody, mapRow, emptyMessage, colSpan){
        if (!tbody) return;
        if (!rows.length){
          tbody.innerHTML = `<tr><td colspan="${colSpan}" class="hint">${emptyMessage}</td></tr>`;
          return;
        }
        tbody.innerHTML = rows.map(mapRow).join('');
      }

      async function refreshCash(){
        try{
          const res = await authFetch('/api/boda/cash?limit=200');
          const rows = filterToday(Array.isArray(res?.items) ? res.items : (Array.isArray(res) ? res : []));
          renderTableRows(rows, $('cashBody'), (x)=>{
            const t = x.created_at || x.time || x.timestamp;
            return `<tr>
              <td>${t ? new Date(t).toLocaleTimeString() : '--'}</td>
              <td>${x.payer_name || ''}</td>
              <td>${x.phone || ''}</td>
              <td>${fmt(x.amount || 0)}</td>
              <td>${x.notes || ''}</td>
            </tr>`;
          }, 'No cash receipts today', 5);
        }catch(_){
          $('cashBody').innerHTML = '<tr><td colspan="5" class="error">Unable to load cash receipts</td></tr>';
        }
      }

      let latestMonthNet = 0;

      function isoDate(d){
        return d.toISOString().slice(0,10);
      }

      async function refreshInsights(){
        try{
          const today = new Date();
          const todayISO = isoDate(today);

          const weekStart = new Date(today);
          weekStart.setDate(weekStart.getDate() - 6);
          const weekStartISO = isoDate(weekStart);

          const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
          const monthStartISO = isoDate(monthStart);

          const [week, month] = await Promise.all([
            authFetch(`/api/boda/insights?start=${weekStartISO}&end=${todayISO}`),
            authFetch(`/api/boda/insights?start=${monthStartISO}&end=${todayISO}`)
          ]);

          // Week totals
          const wt = week?.totals || {};
          const weekIncome = Number(wt.income || 0);
          const weekExp = Number(wt.expenses || 0);
          const weekNet = Number(wt.net || 0);
          $('kWeekNet').textContent = fmt(weekNet);
          $('kWeekDetail').textContent = `Income ${fmt(weekIncome)}, Expenses ${fmt(weekExp)}`;

          // Month totals
          const mt = month?.totals || {};
          const monthIncome = Number(mt.income || 0);
          const monthExp = Number(mt.expenses || 0);
          const monthNet = Number(mt.net || 0);
          latestMonthNet = monthNet;
          $('kMonthNet').textContent = fmt(monthNet);
          $('kMonthDetail').textContent = `Income ${fmt(monthIncome)}, Expenses ${fmt(monthExp)}`;

          // Average net per day (use week window)
          const avgNet = Number(wt.avg_net_per_day || 0);
          $('kAvgNet').textContent = fmt(avgNet);
          const trendDays = Array.isArray(week?.trend) ? week.trend.length : 0;
          $('kAvgNetDetail').textContent = trendDays ? `Based on ${trendDays} day(s)` : 'No recent data';

          // Expense ratio (use month)
          const ratio = mt.expense_pct_of_income;
          if (ratio == null || isNaN(ratio)){
            $('kExpRatio').textContent = 'â€“';
            $('kExpRatioDetail').textContent = 'Add income + expenses to see ratio.';
          } else {
            const pct = Math.round(Number(ratio));
            $('kExpRatio').textContent = pct + '%';
            $('kExpRatioDetail').textContent = 'Expenses as share of income this month.';
          }

          // Expense breakdown by category (today) remains handled in refreshExpenses
          updateSavingsSummary();
        }catch(e){
          // keep insights section quiet on error
        }
      }

      async function refreshExpenses(){
        try{
          const res = await authFetch('/api/boda/expenses?limit=200');
          const rows = filterToday(Array.isArray(res?.items) ? res.items : (Array.isArray(res) ? res : []));
          renderTableRows(rows, $('expBody'), (x)=>{
            const t = x.created_at || x.time || x.timestamp;
            return `<tr>
              <td>${t ? new Date(t).toLocaleTimeString() : '--'}</td>
              <td>${x.category || x.cat || '-'}</td>
              <td>${fmt(x.amount || 0)}</td>
              <td>${x.notes || ''}</td>
            </tr>`;
          }, 'No expenses today', 4);

          // Summary by category for insights tab
          const summary = {};
          rows.forEach(x=>{
            const cat = (x.category || x.cat || 'Other').toString();
            summary[cat] = (summary[cat] || 0) + Number(x.amount || 0);
          });
          const body = $('expSummaryBody');
          const entries = Object.entries(summary);
          if (!entries.length){
            body.innerHTML = '<tr><td colspan="2" class="hint">No expenses today to summarise.</td></tr>';
          }else{
            body.innerHTML = entries.map(([cat, amt])=> `<tr><td>${cat}</td><td>${fmt(amt)}</td></tr>`).join('');
          }
        }catch(_){
          $('expBody').innerHTML = '<tr><td colspan="4" class="error">Unable to load expenses</td></tr>';
        }
      }

      async function collectCash(){
        const amount = Number(($('cashAmount').value || '').trim());
        const payer_name = ($('payerName').value || '').trim();
        const phone = ($('payerPhone').value || '').trim();
        const notes = ($('cashNotes').value || '').trim();
        const out = $('cashMsg'); out.textContent = 'Saving...'; out.className = 'hint';
        try{
          if (!(amount > 0)) throw new Error('Enter amount');
          await authFetch('/api/boda/cash', { method: 'POST', body: JSON.stringify({ amount, payer_name, phone, notes }) });
          out.textContent = 'Saved!'; out.className = 'success';
          $('cashAmount').value = ''; $('payerName').value = ''; $('payerPhone').value = ''; $('cashNotes').value = '';
          refreshSummary(); refreshCash();
        }catch(err){
          out.textContent = `Error: ${err.message || err}`; out.className = 'error';
        }
      }

      async function saveExpense(){
        const category = $('expCat').value;
        const amount = Number(($('expAmount').value || '').trim());
        const notes = ($('expNotes').value || '').trim();
        const out = $('expMsg'); out.textContent = 'Saving...'; out.className = 'hint';
        try{
          if (!(amount > 0)) throw new Error('Enter amount');
          await authFetch('/api/boda/expenses', { method: 'POST', body: JSON.stringify({ category, amount, notes }) });
          out.textContent = 'Saved!'; out.className = 'success';
          $('expAmount').value = ''; $('expNotes').value = '';
          refreshSummary(); refreshExpenses();
        }catch(err){
          out.textContent = `Error: ${err.message || err}`; out.className = 'error';
        }
      }

      async function loadSettings(){
        try{
          const data = await authFetch('/api/boda/settings');
          const target = Number(data?.monthly_savings_target_kes || 0);
          const input = $('savingsTarget');
          if (input){
            input.value = target ? String(target) : '';
          }
          updateSavingsSummary();
        }catch(e){
          const msgEl = $('savingsMsg');
          if (msgEl) msgEl.textContent = 'Could not load savings target.';
        }
      }

      function updateSavingsSummary(){
        const input = $('savingsTarget');
        const summary = $('savingsSummary');
        if (!summary) return;
        const target = Number(input?.value || 0);
        const monthNet = Number(latestMonthNet || 0);
        const now = new Date();
        const year = now.getFullYear();
        const monthIndex = now.getMonth();
        const daysInMonth = new Date(year, monthIndex + 1, 0).getDate();
        const todayDay = now.getDate();
        const remainingDays = Math.max(0, daysInMonth - todayDay);

        if (!target){
          summary.textContent = 'No savings target set. Enter a monthly goal to track progress.';
          return;
        }

        const remainingTarget = Math.max(0, target - monthNet);
        if (remainingTarget <= 0){
          summary.textContent = `Great! Net income this month (${fmt(monthNet)}) meets or exceeds your savings target (${fmt(target)}).`;
          return;
        }

        const perDay = remainingDays > 0 ? remainingTarget / remainingDays : remainingTarget;
        const progressPct = Math.round((monthNet / target) * 100);
        summary.textContent = `Target: ${fmt(target)}. Net so far: ${fmt(monthNet)} (${isFinite(progressPct)?progressPct:0}% of target). ` +
          (remainingDays > 0
            ? `You need about ${fmt(perDay)} net per day for the remaining ${remainingDays} day(s) to hit the target.`
            : 'This month is ending; any extra net will help close the gap.');
      }

      async function saveTarget(){
        const input = $('savingsTarget');
        const msgEl = $('savingsMsg');
        if (!input) return;
        const raw = Number(input.value || 0);
        msgEl.textContent = 'Saving target...';
        try{
          const data = await authFetch('/api/boda/settings', {
            method:'POST',
            body: JSON.stringify({ monthly_savings_target_kes: raw })
          });
          const val = Number(data?.monthly_savings_target_kes || 0);
          input.value = val ? String(val) : '';
          msgEl.textContent = 'Target saved.';
          updateSavingsSummary();
        }catch(e){
          msgEl.textContent = `Error saving target: ${e.message||e}`;
        }
      }

      function getMpesaPlugin(){
        return (window.Capacitor && window.Capacitor.Plugins && window.Capacitor.Plugins.MpesaSms) ? window.Capacitor.Plugins.MpesaSms : null;
      }

      async function initMpesaSection(){
        const statusEl = $('mpesaStatus');
        const enableBtn = $('btnMpesaEnable');
        const syncBtn = $('btnMpesaSync');
        const plugin = getMpesaPlugin();
        if (!plugin){
          if (statusEl) statusEl.textContent = 'Status: Available only in the Android app (install the Boda APK).';
          if (enableBtn) enableBtn.disabled = true;
          if (syncBtn) syncBtn.disabled = true;
          return;
        }
        if (statusEl) statusEl.textContent = 'Status: Ready. You can enable M-Pesa SMS auto-import on this device.';

        enableBtn?.addEventListener('click', async ()=>{
          try{
            if (!plugin.requestPermission){
              alert('M-Pesa plugin missing requestPermission implementation.');
              return;
            }
            const perm = await plugin.requestPermission();
            const granted = perm && (perm.granted === true || perm.status === 'granted');
            if (!granted){
              if (statusEl) statusEl.textContent = 'Status: Permission not granted. Enable SMS access in Android settings to use auto-import.';
              return;
            }
            if (plugin.setEnabled){
              await plugin.setEnabled({ enabled:true });
            }
            if (statusEl) statusEl.textContent = 'Status: Enabled. New M-Pesa SMS will be scanned on this device.';
          }catch(e){
            alert(e.message || String(e));
          }
        });

        syncBtn?.addEventListener('click', async ()=>{
          try{
            if (!plugin.pullNewMessages){
              alert('M-Pesa plugin missing pullNewMessages implementation.');
              return;
            }
            if (statusEl) statusEl.textContent = 'Status: Scanning M-Pesa SMS...';
            const res = await plugin.pullNewMessages();
            const items = Array.isArray(res?.items) ? res.items : [];
            if (!items.length){
              if (statusEl) statusEl.textContent = 'Status: No new M-Pesa messages to import.';
              return;
            }
            await authFetch('/api/boda/mpesa-import',{
              method:'POST',
              body: JSON.stringify({ items })
            });
            if (statusEl) statusEl.textContent = `Status: Imported ${items.length} M-Pesa transaction(s).`;
            await refreshSummary();
            await refreshExpenses();
          }catch(e){
            if (statusEl) statusEl.textContent = 'Status: Error during M-Pesa sync.';
            alert(e.message || String(e));
          }
        });
      }

      function clearStoredTokens(){
        try{ ['auth_token','tt_root_token','tt_admin_token'].forEach(k => localStorage.removeItem(k)); }catch(_){ }
        try{ sessionStorage.removeItem('auth_token'); }catch(_){ }
      }

      async function logoutToLogin(opts = {}){
        const { keepNext = false } = opts;
        try{
          const supa = await window.TT?.getSupabase?.();
          await supa?.auth?.signOut();
        }catch(_){ }
        clearStoredTokens();
        const next = keepNext ? `?next=${encodeURIComponent(location.pathname + location.search)}` : '';
        location.href = '/public/auth/login.html' + next;
      }

      (async function init(){
        startClock();
        bindTabs();
        try{
          await requireRole('BODA', { statusEl: 'authState', roleLabel: 'Boda' });
        }catch(_){
          return;
        }
        try{
          if(window.TT && window.TT.getSupabase){
            const supa = await window.TT.getSupabase();
            const {data:{session}} = await supa.auth.getSession();
            const el = document.getElementById('auth_state');
            if(el) el.textContent = session?.user?.email ? (`Signed in as ${session.user.email}`) : 'Not signed in';
            const welcome = document.getElementById('welcomeLine');
            if (welcome) welcome.textContent = `Hello, ${friendlyName(session?.user)}`;
            const b = document.getElementById('logoutBtn');
            b?.addEventListener('click', (e)=>{
              e.preventDefault();
              logoutToLogin({ keepNext:false });
            });
          }
        }catch(_){ }

        await refreshSummary();
        await refreshCash();
        await refreshExpenses();
        await refreshInsights();
        await loadSettings();

        $('btnCash').addEventListener('click', collectCash);
        $('btnExpense').addEventListener('click', saveExpense);
        const btnSaveTarget = $('btnSaveTarget'); btnSaveTarget?.addEventListener('click', saveTarget);
        initMpesaSection();

        setInterval(()=>{
          refreshSummary();
          refreshInsights();
        }, 30000);
      })();
    })();
  </script>
</body>
</html>
