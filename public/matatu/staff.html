<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TekeTeke — Matatu Staff (Trips & Cash)</title>
  <script src="/public/js/app-config.js"></script>
  <script src="/public/js/api.js"></script>
  <style>
    :root{ --brand:#1976d2; --brand-700:#135ba1; --bg:#f6f7fb; --panel:#fff; --border:#e5e7eb; --muted:#6b7280; --ink:#0b0f19; }
    *{box-sizing:border-box}
    body{font-family:system-ui, Segoe UI, Arial; background:var(--bg); color:var(--ink); margin:0; padding:20px}
    h2{color:var(--brand); margin:0 0 12px}
    h3{margin:0 0 10px}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .right{margin-left:auto}
    input,select,button{padding:10px; border:1px solid var(--border); border-radius:8px}
    button{background:var(--brand); color:#fff; border:none; cursor:pointer}
    button.ghost{background:#fff; color:#1976d2}
    .card{background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:14px; margin-bottom:12px}
    .muted{color:var(--muted)}
    .mono{font-family:ui-monospace,Consolas,monospace}
    table{width:100%; border-collapse:collapse}
    th,td{padding:8px 10px; border:1px solid var(--border); text-align:left}
    th{background:var(--brand); color:#fff}
    .pill{background:#eef2ff; color:#3730a3; border:1px solid #c7d2fe; padding:4px 10px; border-radius:999px; font-size:12px; max-width:40vw; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
    .table-wrap{max-height:360px; overflow:auto; border:1px solid var(--border); border-radius:10px}
    #toast{position:fixed; bottom:14px; right:14px; background:#111827; color:#fff; padding:10px 12px; border-radius:8px; opacity:0; pointer-events:none; transition:.2s; box-shadow:0 4px 18px rgba(0,0,0,.2)}
    #toast.show{opacity:1; pointer-events:auto}
    /* Admin-style tabs */
    .tabs{display:flex; gap:8px; margin:12px 0 16px}
    .tab{padding:10px 14px; background:#1976d2; color:#fff; border-radius:8px; cursor:pointer}
    .tab.active{background:#135ba1}
    .panel{display:none; background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:14px; box-shadow:0 2px 8px rgba(0,0,0,.04)}
    .panel.active{display:block}
    .amount{width:130px}
    .w-2{min-width:220px}
      button.small{padding:6px 8px;font-size:12px}
  </style>
</head>
<body>
  <div class="row" style="justify-content:space-between; align-items:center; margin-bottom:8px">
    <a href="/public/auth/role-select.html">← Back</a>
    <div class="row" style="gap:8px">
      <span id="auth_state" class="pill">Checking sign-in…</span>
      <button id="logoutBtn" style="padding:8px 10px; border-radius:8px; border:1px solid #cfe3ff; background:#0b5cab; color:#fff">Logout</button>
    </div>
  </div>
  <h2>Matatu Staff — Trips & Cash</h2>

  <div class="card">
    <div class="row">
      <label>SACCO <select id="sacco"></select></label>
      <label>Matatu <select id="matatu"></select></label>
      <button id="reload" class="ghost">Reload</button>
      <span class="right muted" id="stat"></span>
    </div>
  </div>

  <div class="tabs" role="tablist" aria-label="Conductor Sections">
    <div class="tab active" data-panel="p_trips" role="tab" aria-selected="true">Trips</div>
    <div class="tab" data-panel="p_tx" role="tab">Transactions</div>
  </div>

  <!-- Trips Panel -->
  <section id="p_trips" class="panel active">
    <div class="card">
      <h3>Start New Trip</h3>
      <div class="row">
        <input id="tripRoute" placeholder="Route / Destination" class="w-2"/>
        <input id="tripFare" type="number" placeholder="Expected Fare (KES)" class="amount"/>
        <button id="startTrip">Start Trip</button>
        <span class="muted right" id="tripMsg"></span>
      </div>
    </div>

    <div class="card" id="activeTripCard" style="display:none">
      <h3>Active Trip</h3>
      <div class="row" style="gap:16px">
        <div><div class="muted">Started</div><div id="tripStarted" class="mono">-</div></div>
        <div><div class="muted">Route</div><div id="tripRouteShow">-</div></div>
        <div><div class="muted">Auto via Till</div><div id="autoAmt" class="mono">0.00</div></div>
        <div><div class="muted">Manual (this trip)</div><div id="manualAmt" class="mono">0.00</div></div>
        <div class="right"><button id="refreshAuto" class="ghost">Refresh Auto</button> <button id="endTrip" class="bad" style="background:#b91c1c">End Trip</button></div>
      </div>

      <h4 style="margin-top:12px">Manual Cash for this Trip</h4>
      <div class="row">
        <input id="manAmt" type="number" placeholder="Amount (KES)" class="amount"/>
        <input id="manName" placeholder="Payer name"/>
        <input id="manPhone" placeholder="07XXXXXXXX"/>
        <button id="postManual">Record Manual Cash</button>
      </div>
      <pre id="tripOut" class="mono" style="margin-top:8px"></pre>
    </div>

    <div class="card" style="margin-top:12px">
      <h3>Today’s Trips</h3>
      <div class="table-wrap">
        <table>
          <thead><tr><th>Started</th><th>Ended</th><th>Route</th><th>Auto (KES)</th><th>Manual (KES)</th><th>Total</th><th>Actions</th><th>ID</th></tr></thead>
          <tbody id="tripsTbody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Transactions Panel -->
  <section id="p_tx" class="panel">
    <div class="row"><h3 style="margin:0">Transactions (FARE)</h3><button id="reloadTx" class="ghost right">Reload</button></div>
    <div class="table-wrap" style="margin-top:8px">
      <table>
        <thead><tr><th>Time</th><th>MSISDN</th><th>Kind</th><th>Amount</th><th>Status</th><th>ID</th></tr></thead>
        <tbody id="txTbody"></tbody>
      </table>
    </div>
  </section>

  <div id="toast" role="status" aria-live="polite"></div>

<script>
(function(){
  const $ = id => document.getElementById(id);
  const fmtKES = n => Number(n||0).toLocaleString('en-KE',{minimumFractionDigits:2,maximumFractionDigits:2});
  const toIsoDate = d => new Date(d).toISOString().slice(0,10);
  const isToday = ts => toIsoDate(ts) === toIsoDate(new Date());
  const toast = (msg)=>{ const t=$('toast'); t.textContent=msg; t.classList.add('show'); clearTimeout(window._t); window._t=setTimeout(()=>t.classList.remove('show'),1800); };

  async function parse(r){ const t=await r.text(); let j={}; try{ j=t?JSON.parse(t):{} }catch{ j={error:t||r.statusText} } if(!r.ok) throw new Error(j.error||j.message||r.statusText); return j; }
  async function jget(p, headers){ return parse(await fetch(p,{headers:headers||{}})); }
  async function jpost(p,b,headers){ return parse(await fetch(p,{method:'POST',headers:Object.assign({'Content-Type':'application/json'},headers||{}),body:JSON.stringify(b||{})})); }

  // --- State ---
  let SACCO_ID=null; let MATATU_ID=null; let MATATU=null; let CURRENT_TRIP=null; let FALLBACK_SACCO=null;

  // Persist trips per matatu locally (for UX even if network fails)
  const storeKey = () => `tt_conductor_trips_${MATATU_ID||'na'}`;
  const loadLocalTrips = () => { try{ return JSON.parse(localStorage.getItem(storeKey())||'[]'); }catch{ return []; } };
  const saveLocalTrips = (arr) => { try{ localStorage.setItem(storeKey(), JSON.stringify(arr)); }catch(_){} };

  // --- Tabs ---
  document.querySelectorAll('.tab').forEach(t=>{
    t.onclick=()=>{
      document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
      document.querySelectorAll('.panel').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      const p = document.getElementById(t.dataset.panel);
      if (p) p.classList.add('active');
    };
  });

  // --- Loaders ---
  async function loadSaccos(){
    const res=await jget('/u/my-saccos');
    const sel=$('sacco'); sel.innerHTML='';
    (res.items||[]).forEach(s=>{ const o=document.createElement('option'); o.value=s.sacco_id; o.textContent=s.name||s.sacco_id; sel.appendChild(o); });
    if(res.items?.length){ sel.value=res.items[0].sacco_id; SACCO_ID=sel.value; }
  }
  async function loadMatatus(){
    if(!SACCO_ID) return;
    const res=await jget(`/u/sacco/${SACCO_ID}/matatus`);
    const items=res.items||[];
    const sel=$('matatu'); sel.innerHTML='';
    items.forEach(m=>{ const o=document.createElement('option'); o.value=m.id; o.textContent=m.number_plate||m.id; sel.appendChild(o); });
    if(items.length){ sel.value=items[0].id; setMatatu(items[0]); }
    $('stat').textContent = `${items.length} matatu(s)`;
  }

  function setMatatu(obj){
    MATATU_ID = obj.id; MATATU = obj; CURRENT_TRIP = getActiveTrip();
    $('activeTripCard').style.display = CURRENT_TRIP? 'block':'none';
    if(CURRENT_TRIP){
      $('tripStarted').textContent = new Date(CURRENT_TRIP.started_at).toLocaleString();
      $('tripRouteShow').textContent = CURRENT_TRIP.route||'-';
      $('manualAmt').textContent = fmtKES(CURRENT_TRIP.manual_kes||0);
      updateAutoAmount();
    }
    renderTripsTable();
    loadTransactions();
  }

  $('matatu').addEventListener('change', async ()=>{
    const id = $('matatu').value;
    try{
      const r = await jget(`/u/sacco/${SACCO_ID}/matatus`);
      const found = (r.items||[]).find(x=>x.id===id);
      setMatatu(found||{id});
    }catch{ setMatatu({id}); }
  });

  // --- Trip logic ---
  function getActiveTrip(){
    const list = loadLocalTrips();
    return list.find(t=>!t.ended_at) || null;
  }
  function putTrip(obj){
    const list = loadLocalTrips();
    const idx = list.findIndex(t=>t.id===obj.id);
    if(idx>=0) list[idx]=obj; else list.unshift(obj);
    saveLocalTrips(list);
    return obj;
  }
  function renderTripsTable(){
    const T = $('tripsTbody'); T.innerHTML='';
    const list = loadLocalTrips().filter(t=> isToday(t.started_at));
    list.forEach(t=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${new Date(t.started_at).toLocaleTimeString()}</td>`+
        `<td>${t.ended_at? new Date(t.ended_at).toLocaleTimeString():'—'}</td>`+
        `<td>${t.route||''}</td>`+
        `<td class='mono'>${fmtKES(t.auto_kes||0)}</td>`+
        `<td class='mono'>${fmtKES(t.manual_kes||0)}</td>`+
        `<td class='mono'>${fmtKES((t.auto_kes||0)+(t.manual_kes||0))}</td>`+
        `<td><button class="small" data-act="addcash" data-id="${t.id}">Add Cash</button></td>`+
        `<td class='mono'>${t.id}</td>`;
      T.appendChild(tr);
    });
  }

  // Quick add-cash per trip (inline action)
  document.getElementById('tripsTbody')?.addEventListener('click', async (e)=>{
    const b = e.target.closest('button'); if(!b) return;
    if (b.dataset.act==='addcash'){
      const tripId = b.dataset.id;
      const amtStr = prompt('Enter cash amount (KES) for this trip:');
      const amt = Number(amtStr||0); if(!amt) return;
      try{
        await jpost('/api/staff/cash', { sacco_id:SACCO_ID, matatu_id:MATATU_ID, kind:'FARE', amount:amt, payer_name:'Conductor Manual', payer_phone:'' });
        const list = loadLocalTrips();
        const t = list.find(x=>x.id===tripId);
        if(t){ t.manual_kes = (t.manual_kes||0) + amt; saveLocalTrips(list); if(CURRENT_TRIP && CURRENT_TRIP.id===tripId){ CURRENT_TRIP = t; const el=$('manualAmt'); if(el) el.textContent = fmtKES(t.manual_kes||0); } }
        toast('Manual cash recorded');
        renderTripsTable();
      }catch(err){ toast(err.message||String(err)); }
    }
  });

  async function updateAutoAmount(){
    const out = $('tripOut'); out.textContent='';
    if(!CURRENT_TRIP) return;
    let tx=[]; let usedMatatuApi=false;
    try{
      const r = await jget(`/u/matatu/${MATATU_ID}/transactions?limit=500`);
      tx = r.items||[]; usedMatatuApi=true;
    }catch(_){ }
    if(!tx.length){
      const s = await jget(`/u/sacco/${SACCO_ID}/transactions?limit=1000`);
      tx = (s.items||[]).filter(x=>x.matatu_id===MATATU_ID);
    }
    const from = new Date(CURRENT_TRIP.started_at).getTime();
    const to = Date.now();
    const fareTx = tx.filter(x=> x.kind==='FARE' && x.status==='SUCCESS' && new Date(x.created_at).getTime()>=from && new Date(x.created_at).getTime()<=to);
    const auto = fareTx.reduce((a,b)=> a + Number(b.fare_amount_kes||0), 0);
    CURRENT_TRIP.auto_kes = auto;
    putTrip(CURRENT_TRIP);
    $('autoAmt').textContent = fmtKES(auto);
    out.textContent = JSON.stringify({source: usedMatatuApi? 'matatu':'sacco', matched: fareTx.length, auto_kes: auto}, null, 2);
    renderTripsTable();
  }

  // manual trip actions
  $('startTrip').addEventListener('click', ()=>{
    if(!MATATU_ID) return toast('Pick a matatu');
    if(getActiveTrip()) return toast('A trip is already active');
    const route = $('tripRoute').value.trim();
    const fare = Number($('tripFare').value||0);
    const trip = { id: `TRIP_${Date.now()}`, matatu_id: MATATU_ID, route, expected_fare: fare, started_at: new Date().toISOString(), auto_kes:0, manual_kes:0 };
    putTrip(trip); CURRENT_TRIP = trip;
    $('activeTripCard').style.display='block';
    $('tripStarted').textContent = new Date(trip.started_at).toLocaleString();
    $('tripRouteShow').textContent = route||'-';
    $('manualAmt').textContent = fmtKES(0);
    $('tripMsg').textContent = 'Trip started';
    updateAutoAmount();
  });

  $('endTrip').addEventListener('click', ()=>{
    if(!CURRENT_TRIP) return;
    CURRENT_TRIP.ended_at = new Date().toISOString();
    putTrip(CURRENT_TRIP);
    $('activeTripCard').style.display='none';
    toast('Trip ended');
    renderTripsTable();
  });

  $('refreshAuto').addEventListener('click', updateAutoAmount);

  $('postManual').addEventListener('click', async ()=>{
    if(!CURRENT_TRIP) return toast('Start a trip first');
    const amt = Number($('manAmt').value||0); if(!amt) return toast('Enter amount');
    const body = {sacco_id:SACCO_ID, matatu_id:MATATU_ID, kind:'FARE', amount:amt, payer_name: $('manName').value.trim()||'Conductor Manual', payer_phone: $('manPhone').value.trim()||''};
    try{
      const r = await jpost('/api/staff/cash', body);
      CURRENT_TRIP.manual_kes = (CURRENT_TRIP.manual_kes||0) + amt;
      putTrip(CURRENT_TRIP); $('manAmt').value=''; $('manualAmt').textContent = fmtKES(CURRENT_TRIP.manual_kes||0);
      $('tripOut').textContent = JSON.stringify(r,null,2);
      toast('Manual cash recorded');
      renderTripsTable();
    }catch(e){ $('tripOut').textContent = e.message; toast(e.message); }
  });

  async function loadTransactions(){
    const T=$('txTbody'); T.innerHTML=''; if(!MATATU_ID) return;
    let r=null; try{ r = await jget(`/u/matatu/${MATATU_ID}/transactions?limit=200`); }catch(_){ }
    let items = (r&&r.items)||[];
    if(!items.length){
      const s = await jget(`/u/sacco/${SACCO_ID}/transactions?limit=1000`);
      items = (s.items||[]).filter(x=>x.matatu_id===MATATU_ID);
    }
    items.filter(x=>x.kind==='FARE').sort((a,b)=> new Date(b.created_at)-new Date(a.created_at)).forEach(tx=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${new Date(tx.created_at).toLocaleString()}</td>`+
        `<td class='mono'>${tx.passenger_msisdn||''}</td>`+
        `<td>${tx.kind||''}</td>`+
        `<td>${fmtKES(tx.fare_amount_kes)}</td>`+
        `<td>${tx.status||''}</td>`+
        `<td class='mono'>${tx.id}</td>`;
      T.appendChild(tr);
    });
  }

  // init
  (async function init(){
    try{
      await loadSaccos();
      await loadMatatus();
      renderTripsTable();
      if(MATATU_ID && getActiveTrip()){ $('activeTripCard').style.display='block'; updateAutoAmount(); }
      await loadTransactions();
    }catch(e){ console.error(e); toast(e.message); }
  })();

  // self-tests
  (function tests(){
    try{
      console.group('Matatu Staff — tests');
      console.assert(isToday(new Date())===true, 'isToday today');
      console.assert(isToday(new Date(Date.now()-24*3600*1000))===false, 'isToday yesterday');
      console.groupEnd();
    }catch(e){ console.error('Tests failed', e); }
  })();
})();
</script>

<script>
// Auth pill
(async function(){
  try{
    if(window.TT && window.TT.getSupabase){
      const supa = await window.TT.getSupabase();
      const {data:{session}} = await supa.auth.getSession();
      const el = document.getElementById('auth_state');
      if(el) el.textContent = session?.user?.email ? (`Signed in as ${session.user.email}`) : 'Not signed in';
      const b = document.getElementById('logoutBtn');
      b?.addEventListener('click', async ()=>{ try{ await supa.auth.signOut(); }catch(_){} localStorage.removeItem('auth_token'); localStorage.removeItem('tt_root_token'); localStorage.removeItem('tt_admin_token'); location.reload(); }, {passive:true});
    }
  }catch(_){ }
})();
</script>
</body>
</html>
