<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TekeTeke — Matatu Staff</title>
  <style>
    :root{ --brand:#0b5cab; --bg:#f6f7fb; --panel:#fff; --border:#e5e7eb; }
    *{box-sizing:border-box} body{font-family:system-ui,Segoe UI,Arial;background:var(--bg);margin:0;padding:20px}
    h2{color:var(--brand);margin:0 0 12px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,select,button{padding:10px;border:1px solid var(--border);border-radius:8px}
    button{background:var(--brand);color:#fff;border:none;cursor:pointer}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border:1px solid var(--border);text-align:left}
    th{background:var(--brand);color:#fff}
    .mono{font-family:ui-monospace,Consolas,monospace}
  </style>
</head>
<body>
  <a href="/public/auth/role-select.html">← Back</a>
  <h2>Matatu Staff — Cash</h2>

  <div class="card">
    <div class="row">
      <label>SACCO <select id="sacco"></select></label>
      <label>Matatu <select id="matatu"></select></label>
      <button id="reload">Reload</button>
    </div>
  </div>

  <div class="card">
    <h3>Collect Daily Fee</h3>
    <div class="row">
      <input id="amount" type="number" placeholder="Amount (KES)" />
      <input id="name" placeholder="Payer name" />
      <input id="phone" placeholder="07XXXXXXXX" />
      <button id="post">Post</button>
    </div>
    <pre id="out" class="mono" style="margin-top:10px"></pre>
  </div>

  <div class="card">
    <h3>Recent</h3>
    <table>
      <thead><tr><th>When</th><th>Matatu</th><th>Amount</th><th>Status</th><th>ID</th></tr></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

<script>
(async function(){
  const $=id=>document.getElementById(id);
  const j=async r=>{const t=await r.text();try{const j=t?JSON.parse(t):{};if(!r.ok)throw new Error(j.error||j.message||r.statusText);return j}catch{if(!r.ok)throw new Error(t||r.statusText);return {raw:t}}};
  async function g(p){return j(await fetch(p))}
  async function p(p,b){return j(await fetch(p,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(b)}))}

  let SACCO_ID=null, MATATU_ID=null;
  async function loadSaccos(){
    const res=await g('/u/my-saccos');
    const sel=$('sacco'); sel.innerHTML='';
    (res.items||[]).forEach(s=>{const o=document.createElement('option');o.value=s.sacco_id;o.textContent=s.name;sel.appendChild(o)});
    if(res.items?.length){sel.value=res.items[0].sacco_id;SACCO_ID=sel.value}
  }
  async function loadMatatus(){
    if(!SACCO_ID) return;
    const res=await g(`/u/sacco/${SACCO_ID}/matatus`);
    const sel=$('matatu'); sel.innerHTML='';
    (res.items||[]).forEach(m=>{const o=document.createElement('option');o.value=m.id;o.textContent=m.number_plate;sel.appendChild(o)});
    if(res.items?.length){sel.value=res.items[0].id;MATATU_ID=sel.value}
  }
  async function loadTx(){
    if(!SACCO_ID) return;
    const res=await g(`/u/sacco/${SACCO_ID}/transactions?limit=30`);
    const T=$('tbody'); T.innerHTML='';
    (res.items||[]).filter(x=>!MATATU_ID||x.matatu_id===MATATU_ID).forEach(tx=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${new Date(tx.created_at).toLocaleString()}</td><td class='mono'>${tx.matatu_id||''}</td><td>${Number(tx.fare_amount_kes||0).toLocaleString('en-KE')}</td><td>${tx.status||''}</td><td class='mono'>${tx.id}</td>`;
      T.appendChild(tr);
    });
  }
  $('sacco').onchange=async()=>{SACCO_ID=$('sacco').value;await loadMatatus();await loadTx()};
  $('matatu').onchange=loadTx;
  $('reload').onclick=async()=>{await loadSaccos();await loadMatatus();await loadTx()};
  $('post').onclick=async()=>{
    if(!SACCO_ID||!MATATU_ID) return alert('Select SACCO & Matatu');
    const body={sacco_id:SACCO_ID,matatu_id:MATATU_ID,kind:'DAILY_FEE',amount:Number($('amount').value||0),payer_name:$('name').value.trim(),payer_phone:$('phone').value.trim()};
    try{const r=await p('/api/staff/cash',body);$('out').textContent=JSON.stringify(r,null,2);await loadTx();alert('Recorded ✅')}catch(e){$('out').textContent=e.message;alert(e.message)}
  };
  await loadSaccos(); await loadMatatus(); await loadTx();
})();
<\/script>
<script src="/public/js/app-config.js"></script>
<script src="/public/js/api.js"></script>
<script>
  (async function(){
    try{
      if (window.TT && window.TT.getSupabase){
        const supa = await window.TT.getSupabase();
        const { data:{ session } } = await supa.auth.getSession();
        var bar = document.createElement('div');
        bar.className='row'; bar.style.cssText='justify-content:space-between;align-items:center;margin:8px 0 12px';
        var pill=document.createElement('span'); pill.id='auth_state'; pill.style.cssText='background:#eef2ff;color:#3730a3;border:1px solid #c7d2fe;padding:4px 10px;border-radius:999px;font-size:12px';
        pill.textContent = session?.user?.email ? ('Signed in as '+session.user.email) : 'Not signed in';
        var btn=document.createElement('button'); btn.id='logoutBtn'; btn.textContent='Logout'; btn.style.cssText='padding:8px 10px;border-radius:8px;border:1px solid #cfe3ff;background:#0b5cab;color:#fff';
        bar.appendChild(document.createElement('span')).innerHTML = '<a href="/public/auth/role-select.html">Back</a>';
        var box=document.createElement('div'); box.className='row'; box.style.gap='8px'; box.appendChild(pill); box.appendChild(btn);
        bar.appendChild(box); document.body.insertBefore(bar, document.body.firstChild);
        btn.addEventListener('click', async ()=>{ try{ await supa.auth.signOut(); }catch(_){} localStorage.removeItem('auth_token'); localStorage.removeItem('tt_root_token'); localStorage.removeItem('tt_admin_token'); location.reload(); }, {passive:true});
      }
    }catch(_){ }
  })();
</script>
</body>
</html>
