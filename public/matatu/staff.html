<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TekeTeke � Matatu Staff (Trips & Cash)</title>

  <link rel="stylesheet" href="/public/css/dashboard-theme.css"/>
  <script src="/public/js/app-config.js"></script>
  <script src="/public/js/api.js"></script>
  <script src="/public/js/role-guard.js"></script>
</head>
<body>
<div class="hero-card">
  <div class="hero-stack">
    <p class="eyebrow">Matatu Staff</p>
    <div class="hello" id="welcomeLine">Hello!</div>
    <div class="timestamp" id="dateTimeLine">--</div>
  </div>
  <div class="hero-actions">
    <a class="btn ghost" href="/public/auth/role-select.html">Role Select</a>
    <span id="auth_state" class="pill">Checking sign-in?</span>
    <button id="logoutBtn" class="btn bad">Logout</button>
  </div>
</div>

  <h2>Matatu Staff � Trips & Cash</h2>

  <div class="card">
    <div class="row">
      <label>Route
        <select id="route"></select>
      </label>
      <label>SACCO <select id="sacco"></select></label>
      <label>Matatu <select id="matatu"></select></label>
      <button id="reload" class="ghost">Reload</button>
      <span class="right muted" id="stat"></span>
    </div>
  </div>

  <div class="tabs" role="tablist" aria-label="Conductor Sections">
    <div class="tab active" data-panel="p_trips" role="tab" aria-selected="true">Trips</div>
    <div class="tab" data-panel="p_tx" role="tab">Transactions</div>
    <div class="tab" data-panel="p_manual" role="tab">Manual Cash</div>
    <div class="tab" data-panel="p_totals" role="tab">Totals</div>
  </div>

  <div class="card" style="background:#f3f5ff;border:1px dashed #c7d2fe">
    <div class="row" style="align-items:center;gap:12px">
      <div style="flex:1">
        <h3 style="margin:0 0 4px">Need offline access?</h3>
        <p class="muted" style="margin:0">Install the Matatu Staff Android app for full offline mode.</p>
      </div>
      <a class="btn" href="/public/downloads/teketeke-go-matatu-staff.apk" download>Download APK</a>
    </div>
  </div>

  <!-- Trips Panel -->
  <section id="p_trips" class="panel active">
    <div class="card">
      <h3>Start New Trip</h3>
      <div class="row">
        <button id="startTrip">Start Trip</button>
        <span class="muted right" id="tripMsg"></span>
      </div>
    </div>

    <div class="card" id="activeTripCard" style="display:none">
      <h3>Active Trip</h3>
      <div class="row" style="gap:16px">
        <div><div class="muted">Started</div><div id="tripStarted" class="mono">-</div></div>
        <div><div class="muted">Route</div><div id="tripRouteShow">-</div></div>
        <div><div class="muted">Auto via Till</div><div id="autoAmt" class="mono">0.00</div></div>
        <div><div class="muted">Manual (this trip)</div><div id="manualAmt" class="mono">0.00</div></div>
        <div class="right"><button id="refreshAuto" class="ghost">Refresh Auto</button> <button id="endTrip" class="bad" style="background:#b91c1c">End Trip</button></div>
      </div>

      <h4 style="margin-top:12px">Trip Cash Total</h4>
      <div class="row">
        <input id="manAmt" type="number" placeholder="Full trip cash (KES)" class="amount"/>
        <button id="recordTripCash">Save Trip Cash</button>
      </div>
      <pre id="tripOut" class="mono" style="margin-top:8px"></pre>
    </div>

    <div class="card" style="margin-top:12px">
      <h3>Today�s Trips</h3>
      <div class="table-wrap">
        <table>
          <thead><tr><th>Started</th><th>Ended</th><th>Route</th><th>Auto (KES)</th><th>Manual (KES)</th><th>Total</th><th>ID</th></tr></thead>
          <tbody id="tripsTbody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Transactions Panel -->
  <section id="p_tx" class="panel">
    <div class="row"><h3 style="margin:0">Transactions (FARE)</h3><button id="reloadTx" class="ghost right">Reload</button></div>
    <div class="table-wrap" style="margin-top:8px">
      <table>
        <thead><tr><th>Time</th><th>MSISDN</th><th>Kind</th><th>Amount</th><th>Status</th><th>ID</th></tr></thead>
        <tbody id="txTbody"></tbody>
      </table>
    </div>
  </section>

  <section id="p_manual" class="panel">
    <div class="card">
      <h3 style="margin-top:0">Manual Cash Collection</h3>
      <div class="row">
        <input id="manualTabAmount" type="number" placeholder="Amount (KES)" class="amount"/>
        <input id="manualTabNote" placeholder="Note (optional)"/>
        <button id="manualTabSave">Record Cash</button>
        <span class="muted" id="manualTabMsg"></span>
      </div>
      <p class="note">Records cash directly against the current matatu without affecting trip states.</p>
    </div>
  </section>

  <section id="p_totals" class="panel">
    <div class="card">
      <h3 style="margin-top:0">Current Trip Totals</h3>
      <div class="stat-grid">
        <div class="stat">
          <div class="stat-label">Mpesa (Auto)</div>
          <div class="stat-value" id="tot_trip_auto">0.00</div>
        </div>
        <div class="stat">
          <div class="stat-label">Manual Cash</div>
          <div class="stat-value" id="tot_trip_manual">0.00</div>
        </div>
        <div class="stat">
          <div class="stat-label">Trip Total</div>
          <div class="stat-value" id="tot_trip_total">0.00</div>
        </div>
      </div>
    </div>
    <div class="card">
      <h3>Today&rsquo;s Collections</h3>
      <div class="stat-grid">
        <div class="stat">
          <div class="stat-label">Mpesa (Auto)</div>
          <div class="stat-value" id="tot_day_auto">0.00</div>
        </div>
        <div class="stat">
          <div class="stat-label">Manual Cash</div>
          <div class="stat-value" id="tot_day_manual">0.00</div>
        </div>
        <div class="stat">
          <div class="stat-label">Daily Total</div>
          <div class="stat-value" id="tot_day_total">0.00</div>
        </div>
      </div>
    </div>
  </section>

  <div id="toast" role="status" aria-live="polite"></div>

<script>
requireRole('STAFF', { statusEl: 'auth_state', roleLabel: 'Matatu Staff' }).then(()=>{
(function(){
  const $ = id => document.getElementById(id);
  const fmtKES = n => Number(n||0).toLocaleString('en-KE',{minimumFractionDigits:2,maximumFractionDigits:2});
  const toIsoDate = d => new Date(d).toISOString().slice(0,10);
  const isToday = ts => toIsoDate(ts) === toIsoDate(new Date());
  const toast = (msg)=>{ const t=$('toast'); t.textContent=msg; t.classList.add('show'); clearTimeout(window._t); window._t=setTimeout(()=>t.classList.remove('show'),1800); };

  async function parse(r){ const t=await r.text(); let j={}; try{ j=t?JSON.parse(t):{} }catch{ j={error:t||r.statusText} } if(!r.ok) throw new Error(j.error||j.message||r.statusText); return j; }
  async function jget(p, headers){ return parse(await fetch(p,{headers:headers||{}})); }
  async function jpost(p,b,headers){ return parse(await fetch(p,{method:'POST',headers:Object.assign({'Content-Type':'application/json'},headers||{}),body:JSON.stringify(b||{})})); }

  // --- State ---
  let SACCO_ID=null; let MATATU_ID=null; let MATATU=null; let CURRENT_TRIP=null; let FALLBACK_SACCO=null;
  let ROUTES=[];
  let GEO_WATCH_ID=null;
  let GEO_BUF=[];
  const GEO_BUF_LIMIT = 5;

  // Persist trips per matatu locally (for UX even if network fails)
  const storeKey = () => `tt_conductor_trips_${MATATU_ID||'na'}`;
  const loadLocalTrips = () => { try{ return JSON.parse(localStorage.getItem(storeKey())||'[]'); }catch{ return []; } };
  const saveLocalTrips = (arr) => { try{ localStorage.setItem(storeKey(), JSON.stringify(arr)); }catch(_){} };

  const manualStoreKey = () => `tt_conductor_manual_${MATATU_ID||'na'}`;
  const loadManualEntries = () => { try{ return JSON.parse(localStorage.getItem(manualStoreKey())||'[]'); }catch{ return []; } };
  const saveManualEntries = (arr) => { try{ localStorage.setItem(manualStoreKey(), JSON.stringify(arr)); }catch(_){} };

  // --- Tabs ---
  document.querySelectorAll('.tab').forEach(t=>{
    t.onclick=()=>{
      document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
      document.querySelectorAll('.panel').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      const p = document.getElementById(t.dataset.panel);
      if (p) p.classList.add('active');
    };
  });

  // --- Loaders ---
  async function loadSaccos(){
    const res=await jget('/u/my-saccos');
    const sel=$('sacco'); sel.innerHTML='';
    (res.items||[]).forEach(s=>{ const o=document.createElement('option'); o.value=s.sacco_id; o.textContent=s.name||s.sacco_id; sel.appendChild(o); });
    if(res.items?.length){ sel.value=res.items[0].sacco_id; SACCO_ID=sel.value; }
  }
  async function loadMatatus(){
    if(!SACCO_ID) return;
    const res=await jget(`/u/sacco/${SACCO_ID}/matatus`);
    const items=res.items||[];
    const sel=$('matatu'); sel.innerHTML='';
    items.forEach(m=>{ const o=document.createElement('option'); o.value=m.id; o.textContent=m.number_plate||m.id; sel.appendChild(o); });
    if(items.length){ sel.value=items[0].id; setMatatu(items[0]); }
    $('stat').textContent = `${items.length} matatu(s)`;
    await loadRoutes();
  }

  async function loadRoutes(){
    const sel = $('route');
    if (!sel){ return; }
    sel.innerHTML = '';
    ROUTES = [];
    if (!SACCO_ID) return;
    try{
      const res = await jget(`/u/sacco/${SACCO_ID}/routes`);
      ROUTES = res.items || res || [];
      if (!ROUTES.length){
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = 'No routes defined';
        sel.appendChild(opt);
        return;
      }
      ROUTES.forEach(r=>{
        const opt = document.createElement('option');
        opt.value = r.id;
        opt.textContent = r.code ? `${r.code} – ${r.name}` : r.name;
        sel.appendChild(opt);
      });
    }catch(_){
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = 'Routes unavailable';
      sel.appendChild(opt);
    }
  }

  function setMatatu(obj){
    MATATU_ID = obj.id; MATATU = obj; CURRENT_TRIP = getActiveTrip();
    $('activeTripCard').style.display = CURRENT_TRIP? 'block':'none';
    if(CURRENT_TRIP){
      $('tripStarted').textContent = new Date(CURRENT_TRIP.started_at).toLocaleString();
      $('tripRouteShow').textContent = CURRENT_TRIP.route||'-';
      $('manualAmt').textContent = fmtKES(CURRENT_TRIP.manual_kes||0);
      updateAutoAmount();
    }
    renderTripsTable();
    updateTotalsPanel();
    loadTransactions();
  }

  $('matatu').addEventListener('change', async ()=>{
    const id = $('matatu').value;
    try{
      const r = await jget(`/u/sacco/${SACCO_ID}/matatus`);
      const found = (r.items||[]).find(x=>x.id===id);
      setMatatu(found||{id});
    }catch{ setMatatu({id}); }
  });

  // --- Trip logic ---
  function getActiveTrip(){
    const list = loadLocalTrips();
    return list.find(t=>!t.ended_at) || null;
  }
  function putTrip(obj){
    const list = loadLocalTrips();
    const idx = list.findIndex(t=>t.id===obj.id);
    if(idx>=0) list[idx]=obj; else list.unshift(obj);
    saveLocalTrips(list);
    return obj;
  }
  function getTodayTrips(){
    return loadLocalTrips().filter(t=> isToday(t.started_at));
  }
  function updateTotalsPanel(){
    const tripAutoEl = $('tot_trip_auto');
    if (tripAutoEl){
      const auto = CURRENT_TRIP ? Number(CURRENT_TRIP.auto_kes||0) : 0;
      const manual = CURRENT_TRIP ? Number(CURRENT_TRIP.manual_kes||0) : 0;
      tripAutoEl.textContent = fmtKES(auto);
      $('tot_trip_manual').textContent = fmtKES(manual);
      $('tot_trip_total').textContent = fmtKES(auto + manual);
    }
    const todayTrips = getTodayTrips();
    const dayAuto = todayTrips.reduce((sum,t)=>sum + Number(t.auto_kes||0),0);
    const dayManualTrips = todayTrips.reduce((sum,t)=>sum + Number(t.manual_kes||0),0);
    const extraManual = loadManualEntries().filter(e => isToday(e.created_at)).reduce((sum,e)=> sum + Number(e.amount||0), 0);
    const dayManual = dayManualTrips + extraManual;
    const dayAutoEl = $('tot_day_auto');
    if(dayAutoEl){
      dayAutoEl.textContent = fmtKES(dayAuto);
      $('tot_day_manual').textContent = fmtKES(dayManual);
      $('tot_day_total').textContent = fmtKES(dayAuto + dayManual);
    }
  }
  function renderTripsTable(){
    const T = $('tripsTbody'); T.innerHTML='';
    const list = loadLocalTrips().filter(t=> isToday(t.started_at));
    list.forEach(t=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${new Date(t.started_at).toLocaleTimeString()}</td>`+
        `<td>${t.ended_at? new Date(t.ended_at).toLocaleTimeString():'-'}</td>`+
        `<td>${t.route||''}</td>`+
        `<td class='mono'>${fmtKES(t.auto_kes||0)}</td>`+
        `<td class='mono'>${fmtKES(t.manual_kes||0)}</td>`+
        `<td class='mono'>${fmtKES((t.auto_kes||0)+(t.manual_kes||0))}</td>`+
        `<td class='mono'>${t.id}</td>`;
      T.appendChild(tr);
    });
    updateTotalsPanel();
  }

  async function updateAutoAmount(){
    const out = $('tripOut'); out.textContent='';
    if(!CURRENT_TRIP) return;
    let tx=[]; let usedMatatuApi=false;
    try{
      const r = await jget(`/u/matatu/${MATATU_ID}/transactions?limit=500`);
      tx = r.items||[]; usedMatatuApi=true;
    }catch(_){ }
    if(!tx.length){
      const s = await jget(`/u/sacco/${SACCO_ID}/transactions?limit=1000`);
      tx = (s.items||[]).filter(x=>x.matatu_id===MATATU_ID);
    }
    const from = new Date(CURRENT_TRIP.started_at).getTime();
    const to = Date.now();
    const fareTx = tx.filter(x=> x.kind==='FARE' && x.status==='SUCCESS' && new Date(x.created_at).getTime()>=from && new Date(x.created_at).getTime()<=to);
    const auto = fareTx.reduce((a,b)=> a + Number(b.fare_amount_kes||0), 0);
    CURRENT_TRIP.auto_kes = auto;
    putTrip(CURRENT_TRIP);
    $('autoAmt').textContent = fmtKES(auto);
    out.textContent = JSON.stringify({source: usedMatatuApi? 'matatu':'sacco', matched: fareTx.length, auto_kes: auto}, null, 2);
    renderTripsTable();
    updateTotalsPanel();
  }

  // manual trip actions
  $('startTrip').addEventListener('click', ()=>{
    if(!MATATU_ID) return toast('Pick a matatu');
    if(getActiveTrip()) return toast('A trip is already active');
    const routeSel = $('route');
    let routeId = null;
    let routeName = '';
    if (routeSel && routeSel.value){
      routeId = routeSel.value;
      const match = ROUTES.find(r => String(r.id) === String(routeId));
      routeName = match?.name || routeSel.options[routeSel.selectedIndex]?.text || '';
    }
    if (!routeName){
      routeName = `Trip ${new Date().toLocaleTimeString()}`;
    }
    const trip = { id: `TRIP_${Date.now()}`, matatu_id: MATATU_ID, route: routeName, route_id: routeId, expected_fare: 0, started_at: new Date().toISOString(), auto_kes:0, manual_kes:0 };
    putTrip(trip); CURRENT_TRIP = trip;
    $('activeTripCard').style.display='block';
    $('tripStarted').textContent = new Date(trip.started_at).toLocaleString();
    $('tripRouteShow').textContent = route;
    $('manualAmt').textContent = fmtKES(0);
    $('tripMsg').textContent = 'Trip started';
    updateTotalsPanel();
    updateAutoAmount();
    startGeoTracking();
  });

  $('endTrip').addEventListener('click', ()=>{
    if(!CURRENT_TRIP) return;
    CURRENT_TRIP.ended_at = new Date().toISOString();
    putTrip(CURRENT_TRIP);
    $('activeTripCard').style.display='none';
    toast('Trip ended');
    renderTripsTable();
    updateTotalsPanel();
    stopGeoTracking();
  });

  $('refreshAuto').addEventListener('click', updateAutoAmount);

  $('recordTripCash').addEventListener('click', async ()=>{
    if(!CURRENT_TRIP) return toast('Start a trip first');
    const input = Number($('manAmt').value||0);
    if(!(input>0)) return toast('Enter amount');
    const previous = Number(CURRENT_TRIP.manual_kes||0);
    const delta = input - previous;
    try{
      if (delta > 0){
        await jpost('/api/staff/cash', { sacco_id:SACCO_ID, matatu_id:MATATU_ID, kind:'CASH', amount:delta, payer_name:'Trip Cash Total', payer_phone:'' });
      }
      CURRENT_TRIP.manual_kes = input;
      putTrip(CURRENT_TRIP);
      $('manAmt').value='';
      $('manualAmt').textContent = fmtKES(input);
      $('tripOut').textContent = delta>0 ? `Synced ${fmtKES(delta)} to cash ledger` : 'Updated trip cash locally';
      toast('Trip cash saved');
      renderTripsTable();
    }catch(e){
      $('tripOut').textContent = e.message;
      toast(e.message);
    }
  });

  async function loadTransactions(){
    const T=$('txTbody'); T.innerHTML=''; if(!MATATU_ID) return;
    let r=null; try{ r = await jget(`/u/matatu/${MATATU_ID}/transactions?limit=200`); }catch(_){ }
    let items = (r&&r.items)||[];
    if(!items.length){
      const s = await jget(`/u/sacco/${SACCO_ID}/transactions?limit=1000`);
      items = (s.items||[]).filter(x=>x.matatu_id===MATATU_ID);
    }
    items.filter(x=>x.kind==='FARE').sort((a,b)=> new Date(b.created_at)-new Date(a.created_at)).forEach(tx=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${new Date(tx.created_at).toLocaleString()}</td>`+
        `<td class='mono'>${tx.passenger_msisdn||''}</td>`+
        `<td>${tx.kind||''}</td>`+
        `<td>${fmtKES(tx.fare_amount_kes)}</td>`+
        `<td>${tx.status||''}</td>`+
        `<td class='mono'>${tx.id}</td>`;
      T.appendChild(tr);
    });
  }

  const manualTabBtn = document.getElementById('manualTabSave');
  if (manualTabBtn){
    manualTabBtn.addEventListener('click', async ()=>{
      if(!MATATU_ID) return toast('Pick a matatu first');
      const amtEl = $('manualTabAmount');
      const noteEl = $('manualTabNote');
      const msgEl = $('manualTabMsg');
      const amt = Number(amtEl?.value || 0);
      if(!(amt>0)) return toast('Enter amount');
      if(msgEl){ msgEl.textContent = 'Saving...'; msgEl.className='muted'; }
      try{
        await jpost('/api/staff/cash', { sacco_id:SACCO_ID, matatu_id:MATATU_ID, kind:'CASH', amount:amt, payer_name:(noteEl?.value.trim()||'Manual cash entry'), payer_phone:'' });
        // keep a lightweight local record so today's totals include this manual cash
        const list = loadManualEntries();
        list.unshift({ id:`MAN_${Date.now()}`, amount:amt, note:noteEl?.value||'', created_at:new Date().toISOString() });
        saveManualEntries(list);
        if(amtEl) amtEl.value='';
        if(noteEl) noteEl.value='';
        if(msgEl){ msgEl.textContent='Saved'; msgEl.className='ok'; }
        renderTripsTable();
        updateTotalsPanel();
        toast('Manual cash recorded');
      }catch(err){
        if(msgEl){ msgEl.textContent = err.message||String(err); msgEl.className='err'; }
        toast(err.message||err);
      }
    });
  }

  function startGeoTracking(){
    if (!navigator.geolocation) return;
    if (GEO_WATCH_ID != null) return;
    GEO_BUF = [];
    GEO_WATCH_ID = navigator.geolocation.watchPosition(
      pos => {
        if (!MATATU_ID || !SACCO_ID) return;
        const point = {
          lat: pos.coords.latitude,
          lng: pos.coords.longitude,
          ts: new Date(pos.timestamp || Date.now()).toISOString()
        };
        GEO_BUF.push(point);
        if (GEO_BUF.length >= GEO_BUF_LIMIT){
          flushGeoBuffer();
        }
      },
      err => {
        console.warn('geo error', err);
      },
      { enableHighAccuracy:true, maximumAge:10000, timeout:15000 }
    );
  }

  function stopGeoTracking(){
    if (GEO_WATCH_ID != null && navigator.geolocation){
      navigator.geolocation.clearWatch(GEO_WATCH_ID);
      GEO_WATCH_ID = null;
    }
    flushGeoBuffer();
  }

  async function flushGeoBuffer(){
    if (!GEO_BUF.length || !SACCO_ID || !MATATU_ID) return;
    const batch = GEO_BUF.slice();
    GEO_BUF = [];
    try{
      await jpost('/api/staff/trips/positions', {
        sacco_id: SACCO_ID,
        matatu_id: MATATU_ID,
        route_id: CURRENT_TRIP?.route_id || null,
        trip_id: CURRENT_TRIP?.id || null,
        points: batch
      });
    }catch(e){
      console.warn('Failed to send trip positions', e);
    }
  }

  // init
  (async function init(){
    try{
      await loadSaccos();
      await loadMatatus();
      renderTripsTable();
      if(MATATU_ID && getActiveTrip()){ $('activeTripCard').style.display='block'; updateAutoAmount(); }
      await loadTransactions();
      updateTotalsPanel();
    }catch(e){ console.error(e); toast(e.message); }
  })();

  // self-tests
  (function tests(){
    try{
      console.group('Matatu Staff � tests');
      console.assert(isToday(new Date())===true, 'isToday today');
      console.assert(isToday(new Date(Date.now()-24*3600*1000))===false, 'isToday yesterday');
      console.groupEnd();
    }catch(e){ console.error('Tests failed', e); }
  })();
})();
});
</script>

<script>
const friendlyName = (user)=>{
  if(!user) return 'Matatu Staff';
  const meta = user.user_metadata || {};
  const email = user.email || '';
  return meta.full_name || meta.name || meta.display_name || meta.displayName || (email ? email.split('@')[0] : 'Matatu Staff');
};
function startCornerClock(){
  const el = document.getElementById('dateTimeLine');
  if(!el) return;
  const update = ()=>{ el.textContent = new Date().toLocaleString(); };
  update();
  setInterval(update, 1000);
}
startCornerClock();

// Auth pill
(async function(){
  try{
    if(window.TT && window.TT.getSupabase){
      const supa = await window.TT.getSupabase();
      const {data:{session}} = await supa.auth.getSession();
      const el = document.getElementById('auth_state');
      if(el) el.textContent = session?.user?.email ? (`Signed in as ${session.user.email}`) : 'Not signed in';
      const welcome = document.getElementById('welcomeLine');
      if (welcome) welcome.textContent = `Hello, ${friendlyName(session?.user)}`;
      const b = document.getElementById('logoutBtn');
      b?.addEventListener('click', async ()=>{ try{ await supa.auth.signOut(); }catch(_){} localStorage.removeItem('auth_token'); localStorage.removeItem('tt_root_token'); localStorage.removeItem('tt_admin_token'); location.reload(); }, {passive:true});
    }
  }catch(_){ }
})();
</script>
</body>
</html>


