<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>TekeTeke ï¿½ Matatu Owner Dashboard</title>
  <style>
    :root{
      --brand:#0ea5e9; --brand-700:#0284c7;
      --bg:#f8fafc; --panel:#ffffff; --border:#e5e7eb; --ink:#0f172a; --muted:#6b7280;
      --bad:#b91c1c; --ok:#065f46; --warn:#b45309;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif;margin:0;padding:24px;background:var(--bg);color:var(--ink)}
    a{color:#1976d2;text-decoration:none}
    h2{margin:0 0 10px;color:var(--brand)}
    h3{margin:0 0 10px}
    .wrap{max-width:1100px;margin:0 auto}
    .hero{background:linear-gradient(135deg,#0ea5e9,#0284c7);color:#fff;border-radius:24px;padding:26px;display:flex;flex-wrap:wrap;gap:20px;align-items:flex-start;box-shadow:0 35px 80px rgba(8,47,73,.25);margin-bottom:20px}
    .hero-text{flex:1 1 320px}
    .hero-text .eyebrow{letter-spacing:.32em;text-transform:uppercase;font-size:11px;font-weight:700;margin:0 0 10px;color:rgba(255,255,255,.85)}
    .hero-text h1{margin:0;font-size:32px;font-weight:800;color:#fff}
    .hero-text .timestamp{margin:6px 0 0;font-size:14px;font-weight:600;color:rgba(255,255,255,.85)}
    .hero-meta{display:flex;gap:10px;flex-wrap:wrap;margin-top:16px}
    .hero-actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .hero-actions .btn{background:rgba(255,255,255,.15);color:#fff;border:1px solid rgba(255,255,255,.4)}
    .hero-actions .btn.bad{background:#dc2626;border-color:#dc2626;color:#fff}
    .badge{background:rgba(255,255,255,.18);color:#fff;border:1px solid rgba(255,255,255,.35);padding:4px 16px;border-radius:999px;font-size:13px;font-weight:700}
    .pill{display:inline-flex;align-items:center;padding:4px 14px;border-radius:999px;border:1px solid var(--border);font-weight:600}
    .pill.invert{border-color:rgba(255,255,255,.5);background:rgba(255,255,255,.15);color:#fff}
    .muted{color:var(--muted)}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .field{display:flex;flex-direction:column;gap:6px}
    .field input,.field select{padding:10px;border:1px solid var(--border);border-radius:8px;background:#fff}
    .btn{background:var(--brand);color:#fff;border:none;border-radius:8px;padding:9px 12px;cursor:pointer}
    .btn:hover{background:var(--brand-700)}
    .btn.ghost{background:#fff;color:var(--brand);border:1px solid var(--brand)}
    .btn.bad{background:var(--bad)}
    .btn.ok{background:var(--ok)}
    .btn.warn{background:var(--warn)}
    .tabs{display:flex;gap:8px;margin:16px 0 22px;flex-wrap:wrap;background:#fff;border:1px solid var(--border);border-radius:999px;padding:6px 8px;box-shadow:0 10px 24px rgba(15,23,42,.08)}
    .tab{background:transparent;color:var(--muted);border-radius:999px;padding:8px 16px;cursor:pointer;font-weight:600;transition:all .15s ease}
    .tab.active{background:var(--brand);color:#fff;box-shadow:0 10px 20px rgba(14,165,233,.35)}
    .panel{display:none}
    .panel.active{display:block}
    .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
    .kv{border:1px solid var(--border);border-radius:10px;padding:12px;background:#fff}
    .kv .k{font-size:12px;color:var(--muted)}
    .kv .v{font-weight:600;margin-top:4px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid var(--border);padding:8px;text-align:left;vertical-align:top}
    th{background:#eff6ff}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .note{margin-top:8px;background:#fef3c7;color:#92400e;border:1px solid #fde68a;border-radius:8px;padding:8px 10px}
    .table-wrap{max-height:360px;overflow:auto;border:1px solid var(--border);border-radius:10px;background:#fff}
    #log{background:#0b1020;color:#cfe3ff;border-radius:8px;padding:10px;max-height:200px;overflow:auto}
    .chooser-overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:20px;z-index:30}
    .chooser-overlay.show{display:flex}
    .chooser-card{background:#fff;border-radius:12px;box-shadow:0 24px 70px rgba(15,23,42,.28);padding:20px;max-width:520px;width:100%;display:flex;flex-direction:column;gap:12px}
    .chooser-head{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .chooser-list{display:flex;flex-direction:column;gap:10px;max-height:60vh;overflow:auto}
    .chooser-item{display:flex;justify-content:space-between;align-items:flex-start;padding:12px;border:1px solid var(--border);border-radius:10px;background:#f8fbff;cursor:pointer;text-align:left}
    .chooser-item strong{font-size:16px;color:var(--ink)}
    .chooser-item.active{border-color:var(--brand);background:#e6f0ff}
    .chooser-meta{font-size:13px;color:var(--muted)}
    .staff-editor-overlay{position:fixed;inset:0;background:rgba(15,23,42,.45);display:none;align-items:center;justify-content:center;padding:20px;z-index:40}
    .staff-editor-overlay.show{display:flex}
    .staff-editor-card{background:#fff;border-radius:16px;box-shadow:0 24px 80px rgba(2,6,23,.35);padding:24px;max-width:500px;width:100%;display:flex;flex-direction:column;gap:12px}
    .staff-editor-head{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
    .staff-editor-actions{display:flex;justify-content:flex-end;gap:10px;margin-top:4px}
    .staff-editor-card .field{margin-top:8px}
  </style>
  <!-- App bootstrap (unchanged paths) -->
<script>
    // Safe shims so preview won't break if your global guards exist
    window.ensureAuthOrRoot = window.ensureAuthOrRoot || function(){};
    window.protect = window.protect || function(){};
  </script>
  <script src="/public/js/app-config.js"></script>
  <script src="/public/js/api.js"></script>
  <script src="/public/js/role-guard.js"></script>
</head>
<body>
  <div class="wrap">
    <div id="matatuChooser" class="chooser-overlay" aria-hidden="true">
      <div class="chooser-card">
        <div class="chooser-head">
          <h3 style="margin:0">Select Matatu</h3>
          <button id="chooserClose" class="btn ghost" type="button">Close</button>
        </div>
        <div id="chooserList" class="chooser-list"></div>
      </div>
    </div>
    <div id="staffEditor" class="staff-editor-overlay" aria-hidden="true">
      <div class="staff-editor-card" role="dialog" aria-modal="true" aria-labelledby="st_edit_title">
        <div class="staff-editor-head">
          <div>
            <h3 id="st_edit_title" style="margin:0">Edit Staff Member</h3>
            <p id="st_edit_plate_line" class="muted" style="margin:2px 0 0;font-size:13px">Matatu not selected</p>
          </div>
          <button id="staffEditorClose" class="btn ghost" type="button">Close</button>
        </div>
        <div class="field">
          <label>Full name
            <input id="st_edit_name" placeholder="Full name"/>
          </label>
        </div>
        <div class="field">
          <label>Phone
            <input id="st_edit_phone" placeholder="07XXXXXXXX"/>
          </label>
        </div>
        <div class="field">
          <label>Email
            <input id="st_edit_email" placeholder="email@example.com"/>
          </label>
        </div>
        <div class="field">
          <label>Role
            <select id="st_edit_role">
              <option value="MATATU_STAFF">MATATU_STAFF</option>
              <option value="DRIVER">DRIVER</option>
              <option value="SACCO_STAFF">SACCO_STAFF</option>
            </select>
          </label>
        </div>
        <div id="st_edit_msg" class="muted" style="min-height:18px;font-size:13px;"></div>
        <div class="staff-editor-actions">
          <button id="st_edit_cancel" class="btn ghost" type="button">Cancel</button>
          <button id="st_edit_save" class="btn ok" type="button">Save changes</button>
        </div>
      </div>
    </div>
    <header class="hero">
      <div class="hero-text">
        <p class="eyebrow">Matatu Owner Console</p>
        <h1 id="welcomeLine">Hello, Matatu Owner</h1>
        <p class="timestamp" id="dateTimeLine">--</p>
        <div class="hero-meta">
          <span id="currentMatatuLabel" class="badge">No matatu selected</span>
          <span id="auth_state" class="pill invert">Checking sign-inï¿½</span>
        </div>
      </div>
      <div class="hero-actions">
        <a class="btn ghost" href="/public/auth/role-select.html">Role Select</a>
        <button id="switchMatatu" class="btn ghost" type="button">Choose Matatu</button>
        <button id="logoutLink" class="btn bad" type="button">Logout</button>
      </div>
    </header>
<div class="card" style="background:#e0f2fe;border:1px dashed #60a5fa;margin-bottom:18px">
      <div class="row" style="align-items:center;gap:12px">
        <div style="flex:1">
          <h3 style="margin:0 0 4px">Install the Matatu Owner app</h3>
          <p class="muted" style="margin:0">Get offline reports and faster access on Android.</p>
        </div>
        <a class="btn" href="/public/downloads/teketeke-go-matatu-owner.apk" download>Download APK</a>
      </div>
    </div>
    <script>
      const friendlyName = (user)=>{
        if(!user) return 'Matatu Owner';
        const meta = user.user_metadata || {};
        const email = user.email || '';
        return meta.full_name || meta.name || meta.display_name || meta.displayName || (email ? email.split('@')[0] : 'Matatu Owner');
      };
      function startCornerClock(){
        const el = document.getElementById('dateTimeLine');
        if(!el) return;
        const update = ()=>{ el.textContent = new Date().toLocaleString(); };
        update();
        setInterval(update, 1000);
      }
      startCornerClock();
      function clearSessionTokens(){
        ['auth_token','tt_root_token','tt_admin_token'].forEach(k=>{ try{ localStorage.removeItem(k); }catch(_){ } });
        try{ sessionStorage.removeItem('auth_token'); }catch(_){ }
      }
      async function logoutToLogin(opts = {}){
        const { keepNext = false } = opts;
        try{
          const supa = await window.TT?.getSupabase?.();
          await supa?.auth?.signOut();
        }catch(_){ }
        clearSessionTokens();
        const next = keepNext ? `?next=${encodeURIComponent(location.pathname + location.search)}` : '';
        location.href = '/public/auth/login.html' + next;
      }
      // Auth pill + logout (no manual tokens)
      (async function(){
        try{
          if(window.TT && window.TT.getSupabase){
            const supa = await window.TT.getSupabase();
            const { data:{ session } } = await supa.auth.getSession();
            const badge = document.getElementById('auth_state');
            if (badge) badge.textContent = session?.user?.email ? ('Signed in as '+session.user.email) : 'Not signed in';
            const welcome = document.getElementById('welcomeLine');
            if (welcome) welcome.textContent = `Hello, ${friendlyName(session?.user)}`;
            const logoutBtn = document.getElementById('logoutLink');
            logoutBtn?.addEventListener('click',(e)=>{ e.preventDefault(); logoutToLogin({ keepNext:false }); });
          }
        }catch(_){ }
      })();
    </script>
    <!-- Tabs -->
    <div class="tabs">
      <div class="tab active" data-for="overview">Overview</div>
      <div class="tab" data-for="vehicle">My Matatu</div>
      <div class="tab" data-for="staff">Staff</div>
      <div class="tab" data-for="tx">Transactions</div>
      <div class="tab" data-for="tools">Tools</div>
    </div>
    <!-- Overview -->
    <section id="panel-overview" class="panel active">
      <div class="card">
        <h3 style="margin-top:0">Quick Snapshot</h3>
        <div class="row" style="margin:10px 0">
          <div class="field" style="flex:1;min-width:240px">
            <label>Find Matatu by Plate
              <input id="ov_plate" placeholder="e.g. KDA123A"/>
            </label>
          </div>
          <button class="btn" id="ov_find">Find</button>
          <span id="ov_found" class="muted"></span>
          <button class="btn ghost" id="ov_refresh" style="margin-left:auto">Refresh</button>
        </div>
        <div class="grid">
          <div class="kv"><div class="k">Plate</div><div class="v" id="ov_plate_v">ï¿½</div></div>
          <div class="kv"><div class="k">SACCO</div><div class="v" id="ov_sacco_v">ï¿½</div></div>
          <div class="kv"><div class="k">Matatu ID</div><div class="v mono" id="ov_id_v">ï¿½</div></div>
        </div>        </div>
        <div class="grid" style="margin-top:10px">
          <div class="kv"><div class="k">Plate</div><div class="v" id="mt_plate_v">ï¿½</div></div>
          <div class="kv"><div class="k">Owner</div><div class="v" id="mt_owner_v">ï¿½</div></div>
          <div class="kv"><div class="k">Type</div><div class="v" id="mt_type_v">ï¿½</div></div>
          <div class="kv"><div class="k">TLB</div><div class="v" id="mt_tlb_v">ï¿½</div></div>
          <div class="kv"><div class="k">Till</div><div class="v" id="mt_till_v">ï¿½</div></div>
          <div class="kv"><div class="k">Matatu ID</div><div class="v mono" id="mt_id_v">ï¿½</div></div>
        </div>
        <div class="note">Details are read-only here. For staff actions, go to the <strong>Staff</strong> tab.</div>
      </div>
    </section>
    <!-- Staff -->
    <section id="panel-staff" class="panel">
      <div class="card">
        <h3 style="margin-top:0">Manage Staff</h3>
        <!-- Find matatu -->
        <div class="row">
          <div class="field" style="flex:1;min-width:260px">
            <label>Find Matatu by Plate
              <input id="st_plate" placeholder="e.g. KDA123A"/>
            </label>
          </div>
          <button class="btn" id="st_find">Find</button>
          <span id="st_found" class="muted"></span>
          <button class="btn ghost" id="st_reload" title="Reload staff list" style="margin-left:auto">Reload</button>
        </div>
        <!-- Add by email -->
        <div class="row" style="margin-top:10px">
          <div class="field" style="flex:1;min-width:200px">
            <label>Full name
              <input id="st_fullname" placeholder="Full name"/>
            </label>
          </div>
          <div class="field" style="flex:1;min-width:160px">
            <label>Phone
              <input id="st_phone" placeholder="07XXXXXXXX"/>
            </label>
          </div>
          <div class="field" style="flex:1;min-width:240px">
            <label>Email
              <input id="st_email2" placeholder="email@example.com"/>
            </label>
          </div>
          <div class="field">
            <label>Role
              <select id="st_role2">
                <option value="MATATU_STAFF">MATATU_STAFF</option>
                <option value="DRIVER">DRIVER</option>
              </select>
            </label>
          </div>
          <button class="btn ok" id="st_add_direct">Add Staff</button>
          <button class="btn" id="st_export">Export CSV</button>
        </div>
        <!-- Staff table -->
        <div class="table-wrap">
          <table>
            <thead>
              <tr><th>Name</th><th>Phone</th><th>Email</th><th>Role</th><th class="mono">ID</th><th width="120"></th></tr>
            </thead>
            <tbody id="st_tbody"></tbody>
          </table>
        </div>
        <div class="note">
          Uses RPCs: <span class="mono">owner_add_staff_by_email</span>, <span class="mono">owner_remove_staff</span>.
          Listing tries <span class="mono">owner_list_matatu_staff</span>, then falls back to <span class="mono">/api/owner/members?matatu_id=ï¿½</span>.
        </div>
      </div>
    </section>
    <!-- Transactions -->
    <section id="panel-tx" class="panel">
      <div class="card">
        <h3 style="margin-top:0">Transactions (Today)</h3>
        <div class="row">
          <div class="field" style="flex:1;min-width:260px">
            <label>For Matatu (plate)
              <input id="tx_plate" placeholder="e.g. KDA123A"/>
            </label>
          </div>
          <button class="btn" id="tx_find">Find</button>
          <span id="tx_found" class="muted"></span>
          <button class="btn ghost" id="tx_reload" style="margin-left:auto">Reload</button>
          <button class="btn" id="tx_export">Export CSV</button>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Date</th><th>Type</th><th>Amount</th><th>Time</th></tr></thead>
            <tbody id="tx_tbody"></tbody>
          </table>
        </div>
        
      </div>
    </section>
    <!-- Tools / Logs -->
    <section id="panel-tools" class="panel">
      <div class="card">
        <h3 style="margin-top:0">Assign Staff Access</h3>
        <div class="row" style="align-items:flex-start">
          <div class="field">
            <label>Staff name
              <input id="tools_assign_name" placeholder="Full name"/>
            </label>
          </div>
          <div class="field">
            <label>Email
              <input id="tools_assign_email" placeholder="email@example.com"/>
            </label>
          </div>
          <div class="field">
            <label>Password
              <input id="tools_assign_password" type="password" placeholder="Choose password"/>
            </label>
          </div>
          <div class="field">
            <label>Phone
              <input id="tools_assign_phone" placeholder="07XXXXXXXX"/>
            </label>
          </div>
          <div class="field">
            <label>Role
              <select id="tools_assign_role">
                <option value="MATATU_STAFF">MATATU_STAFF</option>
                <option value="DRIVER">DRIVER</option>
                <option value="SACCO_STAFF">SACCO_STAFF</option>
              </select>
            </label>
          </div>
          <button class="btn" id="tools_assign_btn" type="button">Create login</button>
        </div>
        <div class="muted" id="tools_assign_status" style="margin-top:10px"></div>
        <div class="muted" id="tools_matatu_line" style="margin-top:6px;font-size:13px"></div>
      </div>
      <div class="card">
        <h3 style="margin-top:0">Assigned Staff</h3>
        <div class="table-wrap" id="tools_staff_list">
          <table>
            <thead><tr><th>Name</th><th>Phone</th><th>Email</th><th>Role</th><th class="mono">User / ID</th></tr></thead>
            <tbody id="tools_staff_rows"><tr><td colspan="5" class="muted">Select a matatu and reload staff to see the list.</td></tr></tbody>
          </table>
        </div>
      </div>
      <div class="card">
        <h3 style="margin-top:0">Logs</h3>
        <div id="log"></div>
      </div>
    </section>
  </div>
  <script>
requireRole('OWNER', { statusEl: 'auth_state', roleLabel: 'Matatu Owner' }).then(()=>{
    try{ ensureAuthOrRoot(); protect('MATATU_OWNER'); }catch(_){}
    // ---------- helpers (no manual token/API base) ----------
    const $ = (id)=>document.getElementById(id);
    let _AUTH_TOKEN = null;
    async function getAuthToken(){
      if (_AUTH_TOKEN) return _AUTH_TOKEN;
      try{
        if (window.TT && typeof TT.getAuth === 'function'){
          const t = TT.getAuth(); if (t) { _AUTH_TOKEN = t; return _AUTH_TOKEN; }
        }
        if (window.TT && typeof TT.getSupabase === 'function'){
          const supa = await TT.getSupabase();
          const { data:{ session } } = await supa.auth.getSession();
          if (session?.access_token){ _AUTH_TOKEN = session.access_token; return _AUTH_TOKEN; }
        }
      }catch(_){}
      return ''; // allow unauth errors to surface naturally
    }
    async function H(){
      const tok = await getAuthToken();
      const h = { 'Content-Type':'application/json' };
      if (tok) h['Authorization'] = 'Bearer '+tok;
      return h;
    }
    function log(msg, obj){
      const el = $('log');
      if (!el) return;
      const time = new Date().toLocaleTimeString();
      el.textContent = `[${time}] ${msg}` + (obj ? `\n${JSON.stringify(obj,null,2)}` : "") + "\n\n" + (el.textContent||'');
    }
    function exportTableToCSV(filename, tbodyId){
      const tbody = document.getElementById(tbodyId);
      if (!tbody) return;
      const table = tbody.closest('table');
      const rows = [...table.querySelectorAll('tr')];
      const csv = rows.map(row=>{
        const cols = [...row.querySelectorAll('th,td')].map(c => `"${(c.innerText||'').replace(/"/g,'""')}"`);
        return cols.join(',');
      }).join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click();
    }
    async function handle(r){
      const text = await r.text();
      let data = {};
      try{ data = text ? JSON.parse(text) : {}; }catch{ data = { error: text || r.statusText }; }
      if (!r.ok) throw new Error((data && (data.error || data.message)) || r.statusText || 'Request failed');
      return data;
    }
    async function jget(p){ const r=await fetch(p,{headers:await H()}); return handle(r); }
    async function jpost(p,b){ const r=await fetch(p,{method:'POST',headers:await H(),body:JSON.stringify(b||{})}); return handle(r); }
    async function jpatch(p,b){ const r=await fetch(p,{method:'PATCH',headers:await H(),body:JSON.stringify(b||{})}); return handle(r); }
    async function jdel(p){ const r = await fetch(p,{method:'DELETE',headers:await H()}); return handle(r); }
    async function jrpc(fn,args){ return jpost('/rpc/'+fn, args||{}); }
    // tabs
    document.querySelectorAll('.tab').forEach(t=>{
      t.onclick=()=>{
        document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
        document.querySelectorAll('.panel').forEach(x=>x.classList.remove('active'));
        t.classList.add('active');
        const key = t.getAttribute('data-for');
        const panel = document.getElementById('panel-'+key);
        if (panel) panel.classList.add('active');
      };
    });
    // logout (already wired in auth pill)
    document.getElementById('logoutLink')?.addEventListener('click',(e)=>{
      e.preventDefault();
      ['tt_root_token','tt_admin_token','auth_token'].forEach(k=>localStorage.removeItem(k));
      location.replace('/public/auth/login.html');
    });
    // shared state
    let MATATU_ID = '';
    let MATATU_CTX = null;
    const MY_VEHICLES = [];
    const staffEditorOverlay = $('staffEditor');
    const staffEditorPlateLine = $('st_edit_plate_line');
    const stEditName = $('st_edit_name');
    const stEditPhone = $('st_edit_phone');
    const stEditEmail = $('st_edit_email');
    const stEditRole = $('st_edit_role');
    const stEditMsg = $('st_edit_msg');
    const stEditSave = $('st_edit_save');
    const stEditCancel = $('st_edit_cancel');
    const staffEditorClose = $('staffEditorClose');
    let STAFF_ROWS = [];
    let STAFF_EDITING = null;
    const toolsAssignName = $('tools_assign_name');
    const toolsAssignEmail = $('tools_assign_email');
    const toolsAssignPassword = $('tools_assign_password');
    const toolsAssignPhone = $('tools_assign_phone');
    const toolsAssignRole = $('tools_assign_role');
    const toolsAssignBtn = $('tools_assign_btn');
    const toolsAssignStatus = $('tools_assign_status');
    const toolsStaffRows = $('tools_staff_rows');
    const toolsMatatuLine = $('tools_matatu_line');
    const chooser = document.getElementById('matatuChooser');
    const chooserList = document.getElementById('chooserList');
    function closeChooser(){
      if(!chooser) return;
      chooser.classList.remove('show');
      chooser.setAttribute('aria-hidden','true');
    }
    function openChooser(){
      if(!chooser) return;
      chooser.classList.add('show');
      chooser.setAttribute('aria-hidden','false');
    }
    function renderChooser(){
      if(!chooserList) return;
      chooserList.innerHTML = MY_VEHICLES.map(v=>{
        const plate = (v.number_plate||'').toUpperCase();
        const meta = [v.vehicle_type||'', v.sacco_id||''].filter(Boolean).join(' ï¿½ ');
        const active = String(v.id) === String(MATATU_ID);
        return `<button type="button" class="chooser-item${active?' active':''}" data-id="${v.id}">
          <div>
            <strong>${plate || v.id}</strong>
            <div class="chooser-meta">${meta||'No details'}</div>
          </div>
          <span class="chooser-meta">${active ? 'Current' : 'Select'}</span>
        </button>`;
      }).join('');
    }
    async function loadMyMatatus(opts={}){
      const auto = opts.autoSelect !== false;
      try{
        const data = await jget('/u/vehicles');
        MY_VEHICLES.length = 0;
        (data.items||[]).forEach(v=>{
          const copy = { ...v };
          if (copy.number_plate) copy.number_plate = copy.number_plate.toUpperCase();
          MY_VEHICLES.push(copy);
        });
        if (!MY_VEHICLES.length){
          log('? No matatu assigned to this owner');
          return;
        }
        renderChooser();
        if (auto){
          if (MY_VEHICLES.length === 1){
            applyMatatu(MY_VEHICLES[0], { announce:true });
          } else {
            openChooser();
          }
        }
      }catch(e){
        log('? Failed to load matatus', { error:String(e) });
      }
    }
    function applyMatatu(mat, opts={}){
      if(!mat || !mat.id){
        alert('Matatu not found');
        return;
      }
      MATATU_ID = mat.id;
      MATATU_CTX = mat;
      if (!opts.skipClose) closeChooser();
      fillOverview(mat); fillVehicle(mat);
      const plate = (mat.number_plate||'').toUpperCase();
      const label = MATATU_ID ? `? ${plate || MATATU_ID} (${MATATU_ID})` : (plate || MATATU_ID);
      const heroMatatu = document.getElementById('currentMatatuLabel');
      if (heroMatatu) heroMatatu.textContent = plate ? `${plate}${MATATU_ID ? ' â€¢ ' + MATATU_ID : ''}` : (MATATU_ID || 'Matatu selected');
      ['ov_found','mt_found','st_found','tx_found'].forEach(id=>{
        const el = $(id); if(el) el.textContent = label || 'Selected';
      });
      ['ov_plate','mt_plate','st_plate','tx_plate'].forEach(id=>{
        const el = $(id); if(el && plate) el.value = plate;
      });
      if (opts.load !== false){
        $('st_reload')?.click();
        $('tx_reload')?.click();
      }
      renderChooser();
      updateToolsMatatuLine(mat);
      log('? Selected matatu', { id: MATATU_ID, plate });
    }
    document.getElementById('switchMatatu')?.addEventListener('click', async ()=>{
      if(!MY_VEHICLES.length){
        await loadMyMatatus({ autoSelect:false });
      }else{
        renderChooser();
      }
      if(MY_VEHICLES.length > 1){
        openChooser();
      }else if (MY_VEHICLES.length === 1){
        applyMatatu(MY_VEHICLES[0], { skipClose:true });
        log('Only one matatu available; reused selection');
      }else{
        alert('No matatu assigned to this account.');
      }
    });
    document.getElementById('chooserClose')?.addEventListener('click', closeChooser);
    chooser?.addEventListener('click', (e)=>{ if (e.target === chooser) closeChooser(); });
    chooserList?.addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-id]'); if(!btn) return;
      const choice = MY_VEHICLES.find(v => String(v.id) === btn.dataset.id);
      if (choice) applyMatatu(choice);
    });
    // lookup
    async function lookupMatatuByPlate(plate){
      return jget('/u/matatu/by-plate?plate='+encodeURIComponent(plate));
    }
    // populate overview/vehicle cards
    function fillOverview(m){
      $('ov_plate_v').textContent = m.number_plate || 'ï¿½';
      $('ov_sacco_v').textContent = m.sacco_id || 'ï¿½';
      $('ov_id_v').textContent = m.id || 'ï¿½';
    }
    function fillVehicle(m){
      $('mt_plate_v').textContent = m.number_plate || 'ï¿½';
      $('mt_owner_v').textContent = m.owner_name || 'ï¿½';
      $('mt_sacco_v').textContent = m.sacco_id || 'ï¿½';
      $('mt_type_v').textContent  = m.vehicle_type || 'ï¿½';
      $('mt_tlb_v').textContent   = m.tlb_number || 'ï¿½';
      $('mt_till_v').textContent  = m.till_number || 'ï¿½';
      $('mt_id_v').textContent    = m.id || 'ï¿½';
    }
    // -------- Overview find/refresh ----------
    $('ov_find').onclick = async ()=>{
      try{
        const plate = $('ov_plate').value.trim().toUpperCase(); if(!plate) return alert('Enter plate');
        const r = await lookupMatatuByPlate(plate);
        applyMatatu(r, { skipClose:true });
      }catch(e){ alert(e.message||e); log('? Overview find failed',{error:String(e)}); }
    };
    $('ov_refresh').onclick = ()=>{ if(MATATU_CTX){ fillOverview(MATATU_CTX); fillVehicle(MATATU_CTX); }};
    // -------- Vehicle tab find ----------
    $('mt_find').onclick = async ()=>{
      try{
        const plate = $('mt_plate').value.trim().toUpperCase(); if(!plate) return alert('Enter plate');
        const r = await lookupMatatuByPlate(plate);
        applyMatatu(r, { skipClose:true });
      }catch(e){ alert(e.message||e); log('? Vehicle find failed',{error:String(e)}); }
    };
    // ================= STAFF =================
    function renderStaff(rows){
      STAFF_ROWS = rows || [];
      const T = $('st_tbody'); T.innerHTML = '';
      STAFF_ROWS.forEach(row=>{
        const tr = document.createElement('tr');
        const uid = row.user_id || '';
        const canDelete = !!uid;
        tr.innerHTML = `
          <td>${row.name || row.email || ''}</td>
          <td>${row.phone || ''}</td>
          <td>${row.email || ''}</td>
          <td>${row.role || ''}</td>
          <td class="mono">${uid || row.id || ''}</td>
          <td>
            <div class="row" style="gap:6px;flex-wrap:wrap">
              <button type="button" class="btn ghost" data-edit="${row.id}">Edit</button>
              ${canDelete ? `<button type="button" class="btn bad" data-id="${uid}">Remove</button>` : '<span class="muted">—</span>'}
            </div>
          </td>
        `;
        T.appendChild(tr);
      });
      T.onclick = async (e)=>{
        const btn = e.target.closest('button'); if(!btn) return;
        if (btn.dataset.edit){
          const staffRow = STAFF_ROWS.find(r => String(r.id) === btn.dataset.edit);
          if (staffRow) openStaffEditor(staffRow);
          return;
        }
        const uid = btn.dataset.id;
        if (!uid) return;
        if (!confirm('Remove staff ('+uid+')?')) return;
        try{
          await jdel(`/u/matatu/${encodeURIComponent(MATATU_ID)}/staff/${encodeURIComponent(uid)}`);
          log('? Removed staff '+uid);
          $('st_reload').click();
        }catch(err){ alert(err.message||err); log('? Remove failed', { error: String(err) }); }
      };
      renderToolsStaff(STAFF_ROWS);
    }

    function renderToolsStaff(rows){
      if (!toolsStaffRows) return;
      if (!rows.length){
        toolsStaffRows.innerHTML = '<tr><td colspan="5" class="muted">No staff assigned yet.</td></tr>';
        return;
      }
      toolsStaffRows.innerHTML = rows.map(row=>`
        <tr>
          <td>${row.name || ''}</td>
          <td>${row.phone || ''}</td>
          <td>${row.email || ''}</td>
          <td>${row.role || ''}</td>
          <td class="mono">${row.user_id || row.id || ''}</td>
        </tr>
      `).join('');
    }

    function updateToolsMatatuLine(mat){
      if (!toolsMatatuLine) return;
      if (mat || MATATU_ID){
        const plate = (mat?.number_plate || MATATU_CTX?.number_plate || '').toUpperCase() || 'Matatu';
        toolsMatatuLine.textContent = `${plate} (${mat?.id||MATATU_ID}) selected`;
      } else {
        toolsMatatuLine.textContent = 'Select a matatu to enable staff assignments.';
      }
      if (toolsAssignStatus) toolsAssignStatus.textContent = '';
    }

    function openStaffEditor(row){
      if(!row) return;
      STAFF_EDITING = row;
      const label = MATATU_CTX?.number_plate?.toUpperCase() || MATATU_ID || 'Matatu selected';
      if (staffEditorPlateLine) staffEditorPlateLine.textContent = `Matatu: ${label}`;
      if (stEditName) stEditName.value = row.name || row.email || '';
      if (stEditPhone) stEditPhone.value = row.phone || '';
      if (stEditEmail) stEditEmail.value = row.email || '';
      if (stEditRole) stEditRole.value = row.role || 'MATATU_STAFF';
      if (stEditMsg) stEditMsg.textContent = '';
      if (staffEditorOverlay){
        staffEditorOverlay.classList.add('show');
        staffEditorOverlay.setAttribute('aria-hidden','false');
      }
      stEditName?.focus();
    }

    function closeStaffEditor(){
      STAFF_EDITING = null;
      if (staffEditorOverlay){
        staffEditorOverlay.classList.remove('show');
        staffEditorOverlay.setAttribute('aria-hidden','true');
      }
      if (stEditMsg) stEditMsg.textContent = '';
    }

    async function saveStaffEdit(){
      if (!STAFF_EDITING) return;
      if (!MATATU_ID) return alert('Find a Matatu first');
      const name = (stEditName?.value || '').trim();
      if (!name) return alert('Enter full name');
      const role = (stEditRole?.value || 'MATATU_STAFF').toString().toUpperCase();
      const payload = {
        name,
        phone: (stEditPhone?.value || '').trim() || null,
        email: (stEditEmail?.value || '').trim() || null,
        role
      };
      if (stEditSave) stEditSave.disabled = true;
      if (stEditMsg) stEditMsg.textContent = 'Saving...';
      try{
        await jpatch(`/u/matatu/${encodeURIComponent(MATATU_ID)}/staff/${encodeURIComponent(STAFF_EDITING.id)}`, payload);
        log('?? Staff updated', { id: STAFF_EDITING.id, role });
        closeStaffEditor();
        await loadStaff();
      }catch(err){
        const errMsg = err?.message || err || 'Update failed';
        alert(errMsg);
        if (stEditMsg) stEditMsg.textContent = errMsg;
      }finally{
        if (stEditSave) stEditSave.disabled = false;
      }
    }

    if (staffEditorOverlay){
      staffEditorOverlay.addEventListener('click',(e)=>{ if (e.target === staffEditorOverlay) closeStaffEditor(); });
    }
    staffEditorClose?.addEventListener('click', closeStaffEditor);
    stEditCancel?.addEventListener('click', closeStaffEditor);
    stEditSave?.addEventListener('click', saveStaffEdit);
    document.addEventListener('keydown',(e)=>{ if (e.key === 'Escape' && staffEditorOverlay?.classList.contains('show')) closeStaffEditor(); });

    async function loadStaff(){
      if (!MATATU_ID) return alert('Find a Matatu first');
      let rows = [];
      try{
        const d = await jget(`/u/matatu/${encodeURIComponent(MATATU_ID)}/staff`);
        rows = d.items || d || [];
      }catch(_){ rows = []; }
      renderStaff(rows);
      log('?? Staff listed', rows);
    }
    $('st_find').onclick = async ()=>{
      try{
        const plate = $('st_plate').value.trim().toUpperCase(); if(!plate) return alert('Enter plate');
        const r = await lookupMatatuByPlate(plate);
        applyMatatu(r, { skipClose:true, load:false });
        $('st_reload')?.click();
      }catch(e){ alert(e.message||e); log('? Staff find failed',{error:String(e)}); }
    };
    $('st_reload').onclick = loadStaff;
    st_add_direct.onclick = async ()=>{
      try{
        if (!MATATU_ID) return alert('Find a Matatu first');
        const name = st_fullname.value.trim();
        const phone= st_phone.value.trim();
        const email= st_email2.value.trim();
        const role = st_role2.value || 'MATATU_STAFF';
        if (!name) return alert('Enter full name');
        await jpost(`/u/matatu/${encodeURIComponent(MATATU_ID)}/staff`, { name, phone, email, role });
        st_fullname.value=''; st_phone.value=''; st_email2.value='';
        await loadStaff();
      }catch(e){ alert(e.message||e); }
    };
    $('st_export').onclick = ()=> exportTableToCSV('matatu-staff.csv', 'st_tbody');
    toolsAssignBtn?.addEventListener('click', async ()=>{
      if (!MATATU_ID){
        if (toolsAssignStatus) toolsAssignStatus.textContent = 'Select a matatu first';
        return;
      }
      const name = (toolsAssignName?.value || '').trim();
      const email = (toolsAssignEmail?.value || '').trim();
      const phone = (toolsAssignPhone?.value || '').trim();
      const role = (toolsAssignRole?.value || 'MATATU_STAFF').toUpperCase();
      if (!name || !email){
        if (toolsAssignStatus) toolsAssignStatus.textContent = 'Name and email are required';
        return;
      }
      if (toolsAssignStatus) toolsAssignStatus.textContent = 'Saving...';
      try{
        const payload = { name, phone, email, role };
        const password = (toolsAssignPassword?.value || '').trim();
        if (password) payload.password = password;
        await jpost(`/u/matatu/${encodeURIComponent(MATATU_ID)}/staff`, payload);
        if (toolsAssignStatus) toolsAssignStatus.textContent = 'Staff login created; reload staff to see it.';
        log('?? Staff login created', { matatu_id: MATATU_ID, email, role });
        if (toolsAssignName) toolsAssignName.value = '';
        if (toolsAssignEmail) toolsAssignEmail.value = '';
        if (toolsAssignPassword) toolsAssignPassword.value = '';
        if (toolsAssignPhone) toolsAssignPhone.value = '';
        await loadStaff();
      }catch(err){
        const message = err?.message || err || 'Failed to assign staff';
        if (toolsAssignStatus) toolsAssignStatus.textContent = message;
        log('? Assign staff failed', { error: message });
      }
    });
    // ================= TRANSACTIONS =================
    function renderTx(rows){
      const T = $('tx_tbody'); T.innerHTML='';
      (rows||[]).forEach(x=>{
        const tr = document.createElement('tr');
        const row = {};
        tr.innerHTML = `\r\n          <td>${row.name || row.email || ""}</td>\r\n          <td>${row.phone || ""}</td>\r\n          <td>${row.email || ""}</td>\r\n          <td>${row.role || ""}</td>\r\n          <td class="mono">${row.user_id || row.id || ""}</td>\r\n          <td><button class="btn bad" data-id="${row.user_id || row.id}">Remove</button></td>`;
        tr.innerHTML = `<td>${x.date||""}</td><td>${x.type||x.kind||""}</td><td>${x.amount||""}</td><td>${x.time||""}</td>`;
        T.appendChild(tr);
      });
    }
    async function loadTx(){
      if (!MATATU_ID) return alert('Find a Matatu first for transactions');
      let rows = [];
      try{
        const d = await jrpc('owner_transactions_today', { p_matatu: MATATU_ID });
        rows = Array.isArray(d)? d : (d?.data || []);
      }catch(_){
        try{
          const d2 = await jget('/api/owner/transactions?matatu_id='+encodeURIComponent(MATATU_ID));
          rows = d2.items || d2 || [];
        }catch(__){
          log('?? No transactions endpoint available; showing empty list.');
        }
      }
      renderTx(rows);
      log('?? Tx listed', rows);
    }
    $('tx_find').onclick = async ()=>{
      try{
        const plate = $('tx_plate').value.trim().toUpperCase(); if(!plate) return alert('Enter plate');
        const r = await lookupMatatuByPlate(plate);
        applyMatatu(r, { skipClose:true, load:false });
        $('tx_reload')?.click();
      }catch(e){ alert(e.message||e); log('? Tx find failed',{error:String(e)}); }
    };
    $('tx_reload').onclick = loadTx;
    $('tx_export').onclick = ()=> exportTableToCSV('matatu-transactions.csv', 'tx_tbody');
    // init: idle until user selects a plate
    updateToolsMatatuLine();
    log('Ready. Loading assigned matatus...');
    loadMyMatatus();
}).catch(()=>{});
  </script>
</body>
</html>
