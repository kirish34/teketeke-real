<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>TekeTeke — Matatu Owner Dashboard</title>
  <script src="/public/js/app-config.js"></script>
  <script src="/public/js/api.js"></script>
  <script src="/public/js/role-guard.js"></script>
  <style>
    :root{
      --brand:#0ea5e9; --brand-700:#0284c7;
      --bg:#f8fafc; --panel:#ffffff; --border:#e5e7eb; --ink:#0f172a; --muted:#6b7280;
      --bad:#b91c1c; --ok:#065f46; --warn:#b45309;
    }
    *{ box-sizing:border-box; }
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif;
      margin:0; padding:24px; background:var(--bg); color:var(--ink);
    }
    a{ color:#0ea5e9; text-decoration:none; }
    h1,h2,h3{ margin:0 0 8px; }
    .wrap{ max-width:1100px; margin:0 auto; }
    .hero{
      background:linear-gradient(135deg,#0ea5e9,#0284c7);
      color:#fff; border-radius:24px; padding:22px;
      display:flex; flex-wrap:wrap; align-items:flex-start; gap:18px;
      box-shadow:0 24px 60px rgba(15,23,42,.35); margin-bottom:18px;
    }
    .hero-main{ flex:1 1 320px; }
    .hero-meta{ display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
    .badge{
      background:rgba(255,255,255,.16); border-radius:999px;
      padding:4px 14px; font-size:13px; font-weight:600;
      border:1px solid rgba(255,255,255,.3);
    }
    .pill{
      display:inline-flex; align-items:center; padding:4px 14px;
      border-radius:999px; border:1px solid rgba(255,255,255,.4);
      font-size:13px; font-weight:500;
    }
    .hero-actions{ display:flex; flex-wrap:wrap; gap:8px; justify-content:flex-end; }
    .btn{
      background:var(--brand); color:#fff; border:none; border-radius:8px;
      padding:8px 12px; cursor:pointer; font-size:14px; font-weight:500;
    }
    .btn:hover{ background:var(--brand-700); }
    .btn.ghost{
      background:rgba(255,255,255,.12); color:#fff;
      border:1px solid rgba(255,255,255,.5);
    }
    .btn.bad{ background:var(--bad); }
    .btn.ok{ background:var(--ok); }
    .tabs{
      display:flex; flex-wrap:wrap; gap:8px;
      margin:18px 0 18px;
      background:#fff; border-radius:999px; border:1px solid var(--border);
      padding:5px 6px; box-shadow:0 10px 24px rgba(15,23,42,.08);
    }
    .tab{
      border-radius:999px; padding:7px 14px; cursor:pointer;
      border:none; background:transparent; color:var(--muted);
      font-size:14px; font-weight:600;
    }
    .tab.active{
      background:var(--brand); color:#fff;
      box-shadow:0 10px 20px rgba(14,165,233,.35);
    }
    .panel{ display:none; }
    .panel.active{ display:block; }
    .card{
      background:var(--panel); border-radius:14px;
      border:1px solid var(--border); padding:14px; margin-bottom:14px;
    }
    .row{
      display:flex; flex-wrap:wrap; gap:10px; align-items:flex-end;
    }
    .field{ display:flex; flex-direction:column; gap:4px; }
    .field label{ font-size:13px; color:var(--muted); }
    .field input,.field select,.field textarea{
      padding:8px 9px; border-radius:8px; border:1px solid var(--border);
      font-size:14px; background:#fff;
    }
    .muted{ color:var(--muted); font-size:13px; }
    .grid3{
      display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:10px;
    }
    table{ width:100%; border-collapse:collapse; margin-top:8px; font-size:13px; }
    th,td{ border:1px solid var(--border); padding:6px 8px; text-align:left; vertical-align:top; }
    th{ background:#eff6ff; }
    .mono{ font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; }
    .table-wrap{
      border-radius:10px; border:1px solid var(--border);
      background:#fff; max-height:360px; overflow:auto;
    }
    .note{
      margin-top:6px; padding:6px 8px; border-radius:8px;
      background:#fef3c7; color:#92400e; border:1px solid #fde68a;
      font-size:13px;
    }
    .seg-tabs{
      display:inline-flex; gap:4px; padding:2px;
      border-radius:999px; background:#f1f5f9; border:1px solid var(--border);
    }
    .seg-tab{
      border:none; background:transparent; border-radius:999px;
      padding:4px 10px; font-size:13px; cursor:pointer; color:var(--muted);
    }
    .seg-tab.active{
      background:var(--brand); color:#fff;
      box-shadow:0 6px 12px rgba(14,165,233,.35);
    }
    @media (max-width:640px){
      body{ padding:16px; }
      .hero{
        padding:10px 12px;
        margin-bottom:10px;
        border-radius:18px;
        flex-direction:column;
        align-items:stretch;
        gap:12px;
      }
      .hero-main h1{
        font-size:20px !important;
      }
      .hero-actions{
        width:100%;
        justify-content:flex-start;
      }
      .tabs{
        margin:12px 0;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="hero">
      <div class="hero-main">
        <p class="muted" style="margin:0;color:rgba(255,255,255,.85);text-transform:uppercase;letter-spacing:.25em;font-size:11px;">Matatu Owner Console</p>
        <h1 id="welcomeLine" style="margin:2px 0 4px;font-size:28px;">Hello, Matatu Owner</h1>
        <p id="dateTimeLine" style="margin:0;font-size:13px;color:rgba(255,255,255,.85);"></p>
        <div class="hero-meta" style="margin-top:10px;">
          <span id="currentMatatuBadge" class="badge">No matatu selected</span>
          <span id="auth_state" class="pill">Checking sign-in…</span>
        </div>
      </div>
      <div class="hero-actions">
        <a class="btn ghost" href="/public/auth/role-select.html">Role Select</a>
        <button id="logoutBtn" class="btn bad" type="button">Logout</button>
      </div>
    </header>

    <div class="card" style="background:#e0f2fe;border:1px dashed #60a5fa;">
      <div class="row" style="align-items:center;justify-content:space-between;">
        <div class="field" style="flex:1;min-width:220px;">
          <label>My Matatu
            <select id="matatuSelect"></select>
          </label>
          <div id="matatuHint" class="muted">Choose a matatu to manage.</div>
        </div>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" data-panel="overview" type="button">Overview</button>
      <button class="tab" data-panel="staff" type="button">Staff</button>
      <button class="tab" data-panel="tx" type="button">Transactions</button>
      <button class="tab" data-panel="tools" type="button">Tools</button>
    </div>

    <!-- Overview -->
    <section id="panel-overview" class="panel active">
      <div class="card">
        <h3>Matatu Snapshot</h3>
        <div class="grid3">
          <div>
            <div class="muted">Plate</div>
            <div id="ov_plate" style="font-weight:600;">—</div>
          </div>
          <div>
            <div class="muted">SACCO</div>
            <div id="ov_sacco" style="font-weight:600;">—</div>
          </div>
          <div>
            <div class="muted">Matatu ID</div>
            <div id="ov_id" class="mono">—</div>
          </div>
        </div>
        <div class="grid3" style="margin-top:8px;">
          <div>
            <div class="muted">Owner</div>
            <div id="ov_owner" style="font-weight:600;">—</div>
          </div>
          <div>
            <div class="muted">Type</div>
            <div id="ov_type" style="font-weight:600;">—</div>
          </div>
          <div>
            <div class="muted">Till</div>
            <div id="ov_till" style="font-weight:600;">—</div>
          </div>
        </div>
        <p class="note" id="ov_note">Totals below are for the selected matatu (today only).</p>
        <div class="grid3" style="margin-top:6px;">
          <div>
            <div class="muted">Fees Today</div>
            <div id="ov_fees" style="font-weight:700;">0</div>
          </div>
          <div>
            <div class="muted">Savings Today</div>
            <div id="ov_savings" style="font-weight:700;">0</div>
          </div>
          <div>
            <div class="muted">Loan Repay Today</div>
            <div id="ov_loans" style="font-weight:700;">0</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Staff -->
    <section id="panel-staff" class="panel">
      <div class="card">
        <h3>Assign Staff / Crew</h3>
        <div class="row">
          <div class="field" style="flex:1;min-width:180px;">
            <label>Full Name
              <input id="st_name" placeholder="Full name"/>
            </label>
          </div>
          <div class="field" style="flex:1;min-width:150px;">
            <label>Phone
              <input id="st_phone" placeholder="07XXXXXXXX"/>
            </label>
          </div>
          <div class="field" style="flex:1;min-width:200px;">
            <label>Email (for login)
              <input id="st_email" placeholder="email@example.com"/>
            </label>
          </div>
          <div class="field" style="min-width:140px;">
            <label>Role
              <select id="st_role">
                <option value="MATATU_STAFF">MATATU_STAFF</option>
                <option value="DRIVER">DRIVER</option>
              </select>
            </label>
          </div>
          <div class="field" style="min-width:180px;">
            <label>Password (optional)
              <input id="st_password" type="password" placeholder="Auto-generate if blank"/>
            </label>
          </div>
          <button id="st_add" class="btn ok" type="button">Create / Attach Staff</button>
        </div>
        <div id="st_status" class="muted" style="margin-top:6px;"></div>
      </div>
      <div class="card">
        <h3>Current Staff</h3>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Name</th><th>Phone</th><th>Email</th><th>Role</th><th>User / ID</th><th width="90">Actions</th>
              </tr>
            </thead>
            <tbody id="st_body">
              <tr><td colspan="6" class="muted">No staff loaded.</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Transactions -->
    <section id="panel-tx" class="panel">
      <div class="card">
        <h3>Transactions (Recent)</h3>
        <div class="row" style="margin-bottom:6px;">
          <button id="tx_reload" class="btn ghost" type="button">Reload</button>
          <button id="tx_export" class="btn" type="button">Export CSV</button>
          <span id="tx_status" class="muted"></span>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Time</th><th>Kind</th><th>Amount</th><th>Phone</th><th>Status</th><th>ID</th>
              </tr>
            </thead>
            <tbody id="tx_body">
              <tr><td colspan="6" class="muted">No transactions loaded.</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Tools (includes loan request) -->
    <section id="panel-tools" class="panel">
      <div class="card">
        <h3>Notifications</h3>
        <div id="owner_notif" class="muted">No loan notifications.</div>
      </div>
      <div class="card">
        <h3>Request a Loan</h3>
        <div class="row">
          <div class="field" style="min-width:160px;">
            <label>Amount (KES)
              <input id="loan_amount" type="number" min="1" placeholder="e.g. 50000"/>
            </label>
          </div>
          <div class="field" style="min-width:150px;">
            <label>Model
              <select id="loan_model">
                <option value="DAILY">DAILY</option>
                <option value="WEEKLY">WEEKLY</option>
                <option value="MONTHLY" selected>MONTHLY</option>
              </select>
            </label>
          </div>
          <div class="field" style="min-width:130px;">
            <label>Term (months)
              <select id="loan_term">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
              </select>
            </label>
          </div>
          <div class="field" style="flex:1;min-width:220px;">
            <label>Note (optional)
              <input id="loan_note" placeholder="What is this loan for?"/>
            </label>
          </div>
        </div>
        <div class="row" style="margin-top:8px;">
          <div class="field" style="min-width:180px;">
            <label>Receive loan as</label>
            <div class="seg-tabs" id="loan_payout_tabs">
              <button type="button" class="seg-tab active" data-loan-payout="CASH">Cash at SACCO</button>
              <button type="button" class="seg-tab" data-loan-payout="M_PESA">M-PESA to my phone</button>
              <button type="button" class="seg-tab" data-loan-payout="ACCOUNT">Bank / Till account</button>
            </div>
            <input type="hidden" id="loan_payout" value="CASH"/>
          </div>
          <div class="field" style="min-width:170px;">
            <label>Phone for M-PESA (optional)
              <input id="loan_payout_phone" placeholder="07XXXXXXXX"/>
            </label>
          </div>
          <div class="field" style="flex:1;min-width:200px;">
            <label>Account or till (optional)
              <input id="loan_payout_account" placeholder="Account / till number"/>
            </label>
          </div>
          <button id="loan_submit" class="btn ok" type="button" style="align-self:flex-end;">Submit Request</button>
        </div>
        <div id="loan_status" class="muted" style="margin-top:6px;"></div>
      </div>
      <div class="card">
        <h3>My Loan Requests</h3>
        <div class="row" style="margin-bottom:6px;">
          <button id="loan_reload" class="btn ghost" type="button">Reload</button>
          <span id="loan_list_status" class="muted"></span>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Date</th><th>Amount</th><th>Model</th><th>Term</th><th>Status</th><th>Note</th><th class="mono">ID</th>
              </tr>
            </thead>
            <tbody id="loan_body">
              <tr><td colspan="7" class="muted">No requests loaded.</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <script>
    (function(){
      requireRole('OWNER', { statusEl:'auth_state', roleLabel:'Matatu Owner' }).then(start).catch(()=>{});

      function fmtKES(n){
        const v = Number(n||0);
        return v.toLocaleString('en-KE',{minimumFractionDigits:2,maximumFractionDigits:2});
      }

      async function parseJson(res){
        const text = await res.text();
        let data = {};
        try{ data = text ? JSON.parse(text) : {}; }catch(_){ data = { error:text||res.statusText }; }
        if (!res.ok){
          const msg = data.error || data.message || res.statusText || 'Request failed';
          throw new Error(msg);
        }
        return data;
      }
      async function jget(path){
        const res = await fetch(path,{ headers:{ Accept:'application/json' }});
        return parseJson(res);
      }
      async function jpost(path, body){
        const res = await fetch(path,{
          method:'POST',
          headers:{ 'Content-Type':'application/json', Accept:'application/json' },
          body: JSON.stringify(body||{})
        });
        return parseJson(res);
      }
      async function jdel(path){
        const res = await fetch(path,{ method:'DELETE', headers:{ Accept:'application/json' }});
        return parseJson(res);
      }

      let CURRENT_MATATU = null;
      let OWNER_SACCO_CACHE = null;

      function start(){
        startClock();
        bindTabs();
        bindLogout();
        loadMatatus();
        bindStaff();
        bindTx();
        bindLoans();
      }

      function $(id){ return document.getElementById(id); }

      function startClock(){
        const el = $('dateTimeLine');
        if (!el) return;
        const tick = ()=>{ el.textContent = new Date().toLocaleString(); };
        tick();
        setInterval(tick,1000);
      }

      function bindLogout(){
        const btn = $('logoutBtn');
        if (!btn) return;
        btn.addEventListener('click', async ()=>{
          try{
            const supa = await window.TT?.getSupabase?.();
            await supa?.auth?.signOut();
          }catch(_){}
          try{
            ['auth_token','tt_root_token','tt_admin_token'].forEach(k=>localStorage.removeItem(k));
          }catch(_){}
          location.href = '/public/auth/login.html';
        });
      }

      function bindTabs(){
        document.querySelectorAll('.tab').forEach(tab=>{
          tab.addEventListener('click', ()=>{
            const key = tab.getAttribute('data-panel');
            document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
            tab.classList.add('active');
            document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
            const panel = document.getElementById('panel-'+key);
            if (panel) panel.classList.add('active');
          });
        });
      }

      async function loadMatatus(){
        const select = $('matatuSelect');
        const badge = $('currentMatatuBadge');
        const hint = $('matatuHint');
        select.innerHTML = '';
        try{
          const data = await jget('/u/vehicles');
          const items = data.items || data || [];
          if (!items.length){
            const opt = document.createElement('option');
            opt.value = ''; opt.textContent = 'No matatu assigned';
            select.appendChild(opt);
            if (badge) badge.textContent = 'No matatu assigned';
            if (hint) hint.textContent = 'Ask your SACCO to attach this owner to a matatu.';
            return;
          }
          items.forEach(m=>{
            const opt = document.createElement('option');
            opt.value = m.id;
            opt.textContent = ((m.number_plate||'').toUpperCase() || m.id);
            select.appendChild(opt);
          });
          select.value = items[0].id;
          applyMatatu(items[0]);
          select.onchange = ()=>{
            const id = select.value;
            const found = (items||[]).find(m=>String(m.id)===String(id));
            if (found) applyMatatu(found);
          };
        }catch(e){
          if (badge) badge.textContent = 'Failed to load matatus';
          if (hint) hint.textContent = e.message || 'Error loading matatus';
        }
      }

      function applyMatatu(m){
        CURRENT_MATATU = m;
        const plate = (m.number_plate||'').toUpperCase() || 'Matatu';
        const badge = $('currentMatatuBadge');
        if (badge) badge.textContent = plate ? (plate + ' selected') : 'Matatu selected';
        const welcome = $('welcomeLine');
        if (welcome){
          const ownerName = (m.owner_name || '').toString().trim();
          welcome.textContent = ownerName ? `Hello, ${ownerName}` : 'Hello, Matatu Owner';
        }
        $('ov_plate').textContent = plate;
        $('ov_sacco').textContent = m.sacco_id || '—';
        $('ov_id').textContent = m.id || '—';
        $('ov_owner').textContent = m.owner_name || '—';
        $('ov_type').textContent = m.vehicle_type || '—';
        $('ov_till').textContent = m.till_number || '—';
        loadOverviewTotals();
        loadStaffList();
        loadTxList();
        loadLoanList();
      }

      async function loadOverviewTotals(){
        if (!CURRENT_MATATU) return;
        $('ov_fees').textContent = '0';
        $('ov_savings').textContent = '0';
        $('ov_loans').textContent = '0';
        try{
          const data = await jget(`/u/matatu/${encodeURIComponent(CURRENT_MATATU.id)}/transactions?limit=200`);
          const items = data.items || data || [];
          let fees=0, sav=0, loan=0;
          items.forEach(t=>{
            const kind = String(t.kind||'').toUpperCase();
            const amt = Number(t.fare_amount_kes || t.amount || 0);
            if (kind === 'SACCO_FEE') fees += amt;
            else if (kind === 'SAVINGS') sav += amt;
            else if (kind === 'LOAN_REPAY') loan += amt;
          });
          $('ov_fees').textContent = fmtKES(fees);
          $('ov_savings').textContent = fmtKES(sav);
          $('ov_loans').textContent = fmtKES(loan);
        }catch(_){}
      }

      // ---- Staff ----
      function bindStaff(){
        const addBtn = $('st_add');
        if (addBtn){
          addBtn.addEventListener('click', createStaff);
        }
      }

      async function loadStaffList(){
        const T = $('st_body');
        const status = $('st_status');
        if (!CURRENT_MATATU){
          T.innerHTML = '<tr><td colspan="6" class="muted">Select a matatu first.</td></tr>';
          if (status) status.textContent = '';
          return;
        }
        if (status) status.textContent = 'Loading staff...';
        T.innerHTML = '<tr><td colspan="6" class="muted">Loading...</td></tr>';
        try{
          const data = await jget(`/u/matatu/${encodeURIComponent(CURRENT_MATATU.id)}/staff`);
          const rows = data.items || data || [];
          if (!rows.length){
            T.innerHTML = '<tr><td colspan="6" class="muted">No staff yet.</td></tr>';
          }else{
            T.innerHTML = rows.map(r=>(
              `<tr>
                 <td>${r.name||''}</td>
                 <td>${r.phone||''}</td>
                 <td>${r.email||''}</td>
                 <td>${r.role||''}</td>
                 <td class="mono">${r.user_id||r.id||''}</td>
                 <td><button class="btn bad" data-user="${r.user_id||''}">Remove</button></td>
               </tr>`
            )).join('');
          }
          if (status) status.textContent = '';
          T.onclick = async (e)=>{
            const btn = e.target.closest('button[data-user]');
            if (!btn) return;
            const uid = btn.getAttribute('data-user');
            if (!uid) return;
            if (!confirm('Remove this staff and login from this matatu?')) return;
            try{
              await jdel(`/u/matatu/${encodeURIComponent(CURRENT_MATATU.id)}/staff/${encodeURIComponent(uid)}`);
              await loadStaffList();
            }catch(err){
              alert(err.message||err);
            }
          };
        }catch(err){
          T.innerHTML = '<tr><td colspan="6" class="muted">Failed to load staff.</td></tr>';
          if (status) status.textContent = err.message||'Failed to load staff';
        }
      }

      async function createStaff(){
        const status = $('st_status');
        if (!CURRENT_MATATU){
          if (status) status.textContent = 'Select a matatu first';
          return;
        }
        const name = ($('st_name')?.value || '').trim();
        const phone = ($('st_phone')?.value || '').trim();
        const email = ($('st_email')?.value || '').trim();
        const role = ($('st_role')?.value || 'MATATU_STAFF').toString().toUpperCase();
        const password = ($('st_password')?.value || '').trim();
        if (!name || !email){
          if (status) status.textContent = 'Name and email are required';
          return;
        }
        if (status) status.textContent = 'Creating staff...';
        try{
          const body = { name, phone, email, role };
          if (password) body.password = password;
          await jpost(`/u/matatu/${encodeURIComponent(CURRENT_MATATU.id)}/staff`, body);
          if (status) status.textContent = 'Staff created.';
          if ($('st_name')) $('st_name').value = '';
          if ($('st_phone')) $('st_phone').value = '';
          if ($('st_email')) $('st_email').value = '';
          if ($('st_password')) $('st_password').value = '';
          await loadStaffList();
        }catch(err){
          const msg = err.message || 'Failed to create staff';
          if (status) status.textContent = msg;
          alert(msg);
        }
      }

      // ---- Transactions ----
      function bindTx(){
        $('tx_reload')?.addEventListener('click', loadTxList);
        $('tx_export')?.addEventListener('click', exportTx);
      }

      async function loadTxList(){
        const T = $('tx_body');
        const status = $('tx_status');
        if (!CURRENT_MATATU){
          T.innerHTML = '<tr><td colspan="6" class="muted">Select a matatu first.</td></tr>';
          if (status) status.textContent = '';
          return;
        }
        if (status) status.textContent = 'Loading...';
        T.innerHTML = '<tr><td colspan="6" class="muted">Loading...</td></tr>';
        try{
          const data = await jget(`/u/matatu/${encodeURIComponent(CURRENT_MATATU.id)}/transactions?limit=200`);
          const rows = data.items || data || [];
          if (!rows.length){
            T.innerHTML = '<tr><td colspan="6" class="muted">No transactions yet.</td></tr>';
          }else{
            T.innerHTML = rows.map(tx=>{
              const ts = tx.created_at ? new Date(tx.created_at).toLocaleString() : '';
              const kind = tx.kind || tx.type || '';
              const amt = tx.fare_amount_kes || tx.amount || 0;
              return `<tr>
                <td>${ts}</td>
                <td>${kind}</td>
                <td>${fmtKES(amt)}</td>
                <td>${tx.msisdn || tx.phone || ''}</td>
                <td>${tx.status || ''}</td>
                <td class="mono">${tx.id || ''}</td>
              </tr>`;
            }).join('');
          }
          if (status) status.textContent = `${rows.length} transaction(s)`;
        }catch(err){
          T.innerHTML = '<tr><td colspan="6" class="muted">Failed to load transactions.</td></tr>';
          if (status) status.textContent = err.message || 'Failed to load';
        }
      }

      function exportTx(){
        const T = $('tx_body');
        const table = T?.closest('table');
        if (!table) return;
        const rows = Array.from(table.querySelectorAll('tr'));
        const csv = rows.map(r=>{
          const cells = Array.from(r.querySelectorAll('th,td')).map(c=>`"${(c.innerText||'').replace(/\"/g,'\"\"')}"`);
          return cells.join(',');
        }).join('\n');
        const blob = new Blob([csv],{type:'text/csv'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'matatu-transactions.csv';
        a.click();
      }

      // ---- Loans (Tools) ----
      function bindLoans(){
        $('loan_submit')?.addEventListener('click', submitLoanRequest);
        $('loan_reload')?.addEventListener('click', loadLoanList);
        const hidden = $('loan_payout');
        const tabs = document.querySelectorAll('#loan_payout_tabs .seg-tab');
        if (hidden && tabs.length){
          tabs.forEach(btn=>{
            btn.addEventListener('click', ()=>{
              const val = (btn.dataset.loanPayout || 'CASH').toString().toUpperCase();
              tabs.forEach(b=>b.classList.remove('active'));
              btn.classList.add('active');
              hidden.value = val || 'CASH';
            });
          });
        }
      }

      async function submitLoanRequest(){
        const status = $('loan_status');
        if (!CURRENT_MATATU){
          if (status) status.textContent = 'Select a matatu first.';
          return;
        }
        const amount = Number(($('loan_amount')?.value || '').trim());
        const model = ($('loan_model')?.value || 'MONTHLY').toString().toUpperCase();
        let term = Number(($('loan_term')?.value || '1').trim());
        const note = ($('loan_note')?.value || '').trim();
        if (!amount || amount <= 0){
          if (status) status.textContent = 'Enter amount.';
          return;
        }
        if (!['DAILY','WEEKLY','MONTHLY'].includes(model)){
          if (status) status.textContent = 'Choose a valid model.';
          return;
        }
        if (term < 1) term = 1;
        if (term > 6) term = 6;
        if (status) status.textContent = 'Submitting...';
        const payout = ($('loan_payout')?.value || 'CASH').toString().toUpperCase();
        const payoutPhone = ($('loan_payout_phone')?.value || '').trim();
        const payoutAccount = ($('loan_payout_account')?.value || '').trim();
        try{
          await jpost(`/u/matatu/${encodeURIComponent(CURRENT_MATATU.id)}/loan-requests`, {
            amount_kes: amount,
            model,
            term_months: term,
            note,
            payout_method: payout,
            payout_phone: payoutPhone,
            payout_account: payoutAccount
          });
          if (status) status.textContent = 'Request submitted. Waiting for SACCO approval.';
          if ($('loan_amount')) $('loan_amount').value = '';
          if ($('loan_note')) $('loan_note').value = '';
          if ($('loan_payout_phone')) $('loan_payout_phone').value = '';
          if ($('loan_payout_account')) $('loan_payout_account').value = '';
          await loadLoanList();
        }catch(err){
          const msg = err.message || 'Failed to submit request';
          if (status) status.textContent = msg;
          alert(msg);
        }
      }

      async function loadLoanList(){
        const T = $('loan_body');
        const status = $('loan_list_status');
        if (!CURRENT_MATATU){
          T.innerHTML = '<tr><td colspan="7" class="muted">Select a matatu first.</td></tr>';
          if (status) status.textContent = '';
          return;
        }
        if (!CURRENT_MATATU.sacco_id){
          T.innerHTML = '<tr><td colspan="7" class="muted">This matatu is not linked to any SACCO. Ask your SACCO to attach it before requesting a loan.</td></tr>';
          if (status) status.textContent = '';
          return;
        }
        T.innerHTML = '<tr><td colspan="7" class="muted">Loading...</td></tr>';
        if (status) status.textContent = 'Loading requests...';
        try{
          const d = await jget(`/u/sacco/${encodeURIComponent(CURRENT_MATATU.sacco_id)}/loan-requests`);
          let rows = d.items || d || [];
          rows = rows.filter(r => String(r.matatu_id||'') === String(CURRENT_MATATU.id||''));
          if (!rows.length){
            T.innerHTML = '<tr><td colspan="7" class="muted">No requests yet.</td></tr>';
          }else{
            T.innerHTML = rows.map(x=>{
              const dt = x.created_at ? String(x.created_at).substring(0,10) : '';
              const payout = (function(){
                const m = (x.payout_method||'').toUpperCase();
                if (!m) return '';
                if (m === 'M_PESA') return ` (M-PESA ${x.payout_phone||''})`;
                if (m === 'ACCOUNT') return ` (Account ${x.payout_account||''})`;
                return ' (Cash)';
              })();
              const statusRaw = x.status || '';
              const reason = (x.rejection_reason || '').toString().trim();
              const statusText = reason && String(statusRaw).toUpperCase() === 'REJECTED'
                ? `${statusRaw} - ${reason}`
                : statusRaw;
              return `<tr>
                <td>${dt}</td>
                <td>${fmtKES(x.amount_kes||0)}</td>
                <td>${x.model||''}</td>
                <td>${x.term_months||''}</td>
                <td>${statusText}</td>
                <td>${(x.note||'')}${payout}</td>
                <td class="mono">${x.id||''}</td>
              </tr>`;
            }).join('');
          }
          if (status) status.textContent = `${rows.length} request(s)`;

          // Owner-facing notifications: approvals + payment reminder
          const notifEl = document.getElementById('owner_notif');
          if (notifEl){
            const approved = rows.filter(r => String(r.status||'').toUpperCase() === 'APPROVED');
            const pending  = rows.filter(r => String(r.status||'').toUpperCase() === 'PENDING');
            const msgs = [];
            if (approved.length){
              msgs.push(`${approved.length} loan request${approved.length>1?'s':''} approved`);
            }else if (pending.length){
              msgs.push(`${pending.length} loan request${pending.length>1?'s':''} pending approval`);
            }
            // Loan due/overdue reminder
            let dueCount = 0;
            try{
              const dueRes = await jget(`/u/sacco/${encodeURIComponent(CURRENT_MATATU.sacco_id)}/loans/due-today`);
              const all = dueRes.items || [];
              dueCount = all.filter(l => String(l.matatu_id||'') === String(CURRENT_MATATU.id||'')).length;
            }catch(_){}
            if (dueCount){
              msgs.push(`${dueCount} loan installment${dueCount>1?'s':''} due or overdue. Please pay today.`);
            }
            notifEl.textContent = msgs.length ? msgs.join(' • ') : 'No loan notifications.';
          }
        }catch(err){
          T.innerHTML = '<tr><td colspan="7" class="muted">Failed to load requests.</td></tr>';
          if (status) status.textContent = err.message || 'Failed to load';
        }
      }

    })();
  </script>

  <script>
    // Tidy up owner UI: hide raw IDs and show SACCO name
    document.addEventListener('DOMContentLoaded', () => {
      function hideMatatuIdRow(){
        try{
          const idEl = document.getElementById('ov_id');
          if (idEl && idEl.parentElement){
            idEl.parentElement.style.display = 'none';
          }
        }catch(_){}
      }

      async function updateSaccoName(){
        try{
          const saccoEl = document.getElementById('ov_sacco');
          if (!saccoEl) return;
          const raw = (saccoEl.textContent || '').trim();
          if (!raw) return;
          const res = await (window.authFetch ? window.authFetch('/u/my-saccos') : fetch('/u/my-saccos'));
          const data = res && res.json ? await res.json() : res;
          const items = data?.items || data || [];
          const match = items.find(row => String(row.sacco_id) === raw);
          if (match && match.name){
            saccoEl.textContent = match.name;
          }
        }catch(_){}
      }

      function updateBadge(){
        try{
          const plate = (document.getElementById('ov_plate')?.textContent || '').trim();
          const badge = document.getElementById('currentMatatuBadge');
          if (badge && plate){
            badge.textContent = plate + ' selected';
          }
        }catch(_){}
      }

      async function tweak(){
        hideMatatuIdRow();
        await updateSaccoName();
        updateBadge();
      }

      // Initial tweak after main script runs
      setTimeout(tweak, 400);

      const sel = document.getElementById('matatuSelect');
      if (sel){
        sel.addEventListener('change', () => setTimeout(tweak, 300));
      }
    });
  </script>

  <footer style="max-width:1100px;margin:24px auto 0;"></footer>
</body>
</html>
