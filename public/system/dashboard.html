<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>System Admin — TekeTeke</title>

  <script src="/public/js/app-config.js"></script>
  <script src="/public/js/api.js"></script>

  <style>
    :root{
      --brand:#1976d2; --brand-700:#135ba1; --bg:#f6f7fb; --panel:#ffffff; --ink:#0b0f19;
      --border:#e5e7eb; --muted:#4b5563; --ok:#065f46; --bad:#b91c1c;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,Segoe UI,Arial,sans-serif;background:var(--bg);color:var(--ink);margin:0;padding:14px}
    h2{margin:0 0 10px}
    .topbar{display:flex;align-items:center;gap:8px;margin-bottom:10px}
    .pill{background:#eef2ff;color:#3730a3;border:1px solid #c7d2fe;padding:4px 10px;border-radius:999px;font-size:12px}
    .right{margin-left:auto}
    .btn{padding:8px 10px;border:1px solid var(--brand);border-radius:8px;background:var(--brand);color:#fff;font-weight:700;cursor:pointer}
    .btn.ghost{background:#fff;color:var(--brand)}
    .btn:hover{background:var(--brand-700);border-color:var(--brand-700)}
    .btn.ghost:hover{background:#f0f7ff}
    .btn.danger{border-color:#b91c1c;color:#b91c1c;background:#fff}
    .btn.danger:hover{background:#fee2e2}
    .field.hidden{display:none}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:8px 10px;background:var(--brand);color:#fff;border-radius:8px;cursor:pointer}
    .tab.active{background:var(--brand-700)}
    .panel{display:none;background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px;box-shadow:0 6px 18px rgba(0,0,0,.06);margin-top:10px}
    .panel.active{display:block}
    .card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:16px;box-shadow:0 8px 24px rgba(15,23,42,.06);margin-bottom:12px}
    .grid.metrics{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin-top:12px}
    .metric{padding:12px;border-radius:10px;border:1px solid var(--border);background:#f8fafc}
    .metric .k{font-size:13px;color:var(--muted)}
    .metric .v{font-size:24px;font-weight:700;margin-top:6px}
    .grid.g2{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
    .table-wrap{overflow:auto}
    .list{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:6px}
    .list li{padding:8px 10px;border:1px solid var(--border);border-radius:8px;background:#f8fafc;font-family:monospace}
    input,select{padding:8px;border:1px solid var(--border);border-radius:8px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid var(--border);padding:8px;text-align:left;vertical-align:top}
    th{background:#1976d2;color:#fff}
    .muted{color:var(--muted)}
    .status{display:block;font-size:13px}
    .err{color:var(--bad);font-weight:700}
    .ok{color:var(--ok);font-weight:700}
    .row{display:flex;flex-wrap:wrap;gap:8px}
    .hint{font-size:12px;color:#6b7280;margin-top:4px}
    .section{margin-top:10px}
    .stacked{display:flex;flex-direction:column;gap:6px}
    .stacked .item{padding:6px 0;border-bottom:1px solid var(--border);font-size:13px}
    .stacked .item:last-child{border-bottom:none}
    .sacco-matatu-list{font-size:13px}
  </style>
</head>
<body>
  <div class="topbar">
    <h2 style="margin:0">System Admin</h2>
    <span id="sess_badge" class="pill right">Checking session…</span>
    <button id="logout_btn" class="btn ghost" title="Sign out">Logout</button>
  </div>

  <div class="tabs" role="tablist" aria-label="Sections">
    <div class="tab active" data-id="overview" role="tab" aria-selected="true">Overview</div>
    <div class="tab" data-id="saccos" role="tab" aria-selected="false">SACCOs</div>
    <div class="tab" data-id="matatus" role="tab" aria-selected="false">Matatu</div>
    <div class="tab" data-id="taxis" role="tab" aria-selected="false">Taxis</div>
    <div class="tab" data-id="bodas" role="tab" aria-selected="false">BodaBodas</div>
    <div class="tab" data-id="pool" role="tab" aria-selected="false">USSD Pool</div>
    <div class="tab" data-id="logins" role="tab" aria-selected="false">Logins</div>
  </div>

  <section id="overview" class="panel active" aria-labelledby="tab_overview">
    <div class="card">
      <h3>Platform snapshot</h3>
      <div class="grid metrics">
        <div class="metric"><div class="k">SACCOs</div><div class="v" id="ov_saccos">—</div></div>
        <div class="metric"><div class="k">Matatus</div><div class="v" id="ov_matatus">—</div></div>
        <div class="metric"><div class="k">Transactions today</div><div class="v" id="ov_tx">—</div></div>
        <div class="metric"><div class="k">USSD available</div><div class="v" id="ov_pool_avail">—</div></div>
        <div class="metric"><div class="k">USSD total</div><div class="v" id="ov_pool_total">—</div></div>
      </div>
    </div>
  </section>

  <section id="saccos" class="panel" aria-labelledby="tab_saccos">
    <h3>Register SACCO</h3>
    <div class="row">
      <input id="sc_name" placeholder="SACCO name" autocomplete="organization" />
      <input id="sc_contact_name" placeholder="Contact name" autocomplete="name" />
      <input id="sc_phone" placeholder="Phone" autocomplete="tel" />
      <input id="sc_email" placeholder="Email" autocomplete="email" />
      <input id="sc_till" placeholder="Default till (optional)" />
    </div>

    <div class="section row">
      <button id="sc_add" class="btn">Register SACCO</button>
      <span id="sc_msg" class="muted" style="align-self:center"></span>
    </div>

    <table>
      <thead><tr><th>Name</th><th>Contact</th><th>Phone</th><th>Email</th><th>ID</th></tr></thead>
      <tbody id="sc_list"><tr><td colspan="5" class="muted">Loading…</td></tr></tbody>
    </table>
  </section>

  <section id="matatus" class="panel" aria-labelledby="tab_matatus">
    <h3>Register Matatu</h3>
    <div class="row">
      <input id="mt_plate" placeholder="KDA123A" />
      <input id="mt_owner" placeholder="Owner name" />
      <input id="mt_phone" placeholder="Owner phone" />
      <input id="mt_till" placeholder="Till number" />
      <select id="mt_sacco">
        <option value="">Select SACCO</option>
      </select>
    </div>

    <div class="hint" id="mt_sacco_hint">Select a SACCO to link this matatu.</div>

    <div class="section">
      <h4 style="margin:8px 0 4px">Matatus already registered in this SACCO</h4>
      <div id="mt_existing_list" class="sacco-matatu-list muted">Select a SACCO to see matatus registered under it.</div>
    </div>

    <div class="section row">
      <button id="mt_add" class="btn">Register Matatu</button>
      <span id="mt_msg" class="muted" style="align-self:center"></span>
    </div>

    <table>
      <thead><tr><th>Plate</th><th>Owner</th><th>Type</th><th>SACCO</th><th>ID</th></tr></thead>
      <tbody id="mt_list"><tr><td colspan="5" class="muted">Loading…</td></tr></tbody>
    </table>
  </section>

  <section id="taxis" class="panel" aria-labelledby="tab_taxis">
    <h3>Register Taxi</h3>
    <div class="row">
      <input id="taxi_plate" placeholder="KTA123B" />
      <input id="taxi_owner" placeholder="Owner name" />
      <input id="taxi_phone" placeholder="Owner phone" />
      <input id="taxi_till" placeholder="Till number" />
      <input id="taxi_sacco" placeholder="SACCO id (optional)" />
    </div>
    <div class="hint">Leave SACCO empty if this taxi is not registered under one.</div>

    <div class="section row">
      <button id="taxi_add" class="btn">Register Taxi</button>
      <span id="taxi_msg" class="muted" style="align-self:center"></span>
    </div>

    <table>
      <thead><tr><th>Plate</th><th>SACCO</th><th>ID</th></tr></thead>
      <tbody id="taxi_list"><tr><td colspan="3" class="muted">Loading…</td></tr></tbody>
    </table>
  </section>

  <section id="bodas" class="panel" aria-labelledby="tab_bodas">
    <h3>Register BodaBoda</h3>
    <div class="row">
      <input id="boda_plate" placeholder="KDB456C" />
      <input id="boda_owner" placeholder="Rider name" />
      <input id="boda_phone" placeholder="Rider phone" />
      <input id="boda_till" placeholder="Till number" />
      <input id="boda_sacco" placeholder="SACCO id (optional)" />
    </div>
    <div class="hint">SACCO linkage is optional for boda bodas.</div>

    <div class="section row">
      <button id="boda_add" class="btn">Register BodaBoda</button>
      <span id="boda_msg" class="muted" style="align-self:center"></span>
    </div>

    <table>
      <thead><tr><th>Plate</th><th>SACCO</th><th>ID</th></tr></thead>
      <tbody id="boda_list"><tr><td colspan="3" class="muted">Loading…</td></tr></tbody>
    </table>
  </section>

  <section id="pool" class="panel" aria-labelledby="tab_pool">
    <div class="card">
      <h3>Assign next USSD code</h3>
      <form id="ussdForm" class="grid g2">
        <label class="field">Prefix<input name="prefix" value="*001*" placeholder="*001*"></label>
        <label class="field">Level
          <select name="level">
            <option value="MATATU">Matatu</option>
            <option value="SACCO">SACCO</option>
          </select>
        </label>
        <label class="field">Matatu ID<input name="matatu_id" placeholder="optional"></label>
        <label class="field">SACCO ID<input name="sacco_id" placeholder="optional"></label>
        <div class="field" style="align-self:flex-end">
          <button class="btn" type="submit">Assign code</button>
          <div id="ussdMsg" class="status muted" style="margin-top:6px"></div>
        </div>
      </form>
    </div>
    <div class="card">
      <h3>Available codes</h3>
      <ul id="ussdAvail" class="list"><li class="muted">Loading...</li></ul>
    </div>
    <div class="card">
      <h3>Recent allocations</h3>
      <div class="table-wrap">
        <table>
          <thead><tr><th>Code</th><th>Status</th><th>Level</th><th>Linked ID</th><th>Updated</th></tr></thead>
          <tbody id="ussdAlloc"><tr><td colspan="5" class="muted">Loading...</td></tr></tbody>
        </table>
      </div>
    </div>
  </section>

  <section id="logins" class="panel" aria-labelledby="tab_logins">
    <div class="card">
      <h3>Create login</h3>
      <form id="loginForm" class="grid g2">
        <label class="field">Role
          <select id="login_role">
            <option value="SACCO">SACCO Admin</option>
            <option value="OWNER">Matatu Owner</option>
            <option value="TAXI">Taxi</option>
            <option value="BODA">BodaBoda</option>
          </select>
        </label>
        <label class="field">Email<input id="login_email" type="email" autocomplete="email" required></label>
        <label class="field">Password<input id="login_password" type="password" autocomplete="new-password" required></label>
        <label class="field" data-login-field="create-sacco">SACCO
          <select id="login_sacco">
            <option value="">Select SACCO</option>
          </select>
        </label>
        <label class="field" data-login-field="create-matatu">Matatu
          <select id="login_matatu">
            <option value="">Select Matatu</option>
          </select>
        </label>
        <div class="field" style="align-self:flex-end">
          <button class="btn" type="submit">Create login</button>
          <div id="login_create_msg" class="status muted"></div>
        </div>
      </form>
    </div>

    <div class="card" id="loginEditor" hidden>
      <h3>Edit login</h3>
      <form id="loginEditForm" class="grid g2">
        <input type="hidden" id="edit_user_id" />
        <label class="field">Email<input id="edit_email" type="email" autocomplete="email"></label>
        <label class="field">Role
          <select id="edit_role">
            <option value="SACCO">SACCO Admin</option>
            <option value="OWNER">Matatu Owner</option>
            <option value="TAXI">Taxi</option>
            <option value="BODA">BodaBoda</option>
          </select>
        </label>
        <label class="field">New password<input id="edit_password" type="password" placeholder="Leave blank to keep" autocomplete="new-password"></label>
        <label class="field" data-login-field="edit-sacco">SACCO
          <select id="edit_sacco">
            <option value="">Select SACCO</option>
          </select>
        </label>
        <label class="field" data-login-field="edit-matatu">Matatu
          <select id="edit_matatu">
            <option value="">Select Matatu</option>
          </select>
        </label>
        <div class="field" style="align-self:flex-end">
          <button class="btn" type="submit">Save changes</button>
          <button class="btn ghost" type="button" id="cancelEdit">Cancel</button>
          <div id="login_edit_msg" class="status muted"></div>
        </div>
      </form>
    </div>

    <div class="card">
      <h3>Existing logins</h3>
      <div class="table-wrap">
        <table>
          <thead><tr><th>Email</th><th>Role</th><th>SACCO</th><th>Matatu</th><th>Assigned</th><th width="160">Actions</th></tr></thead>
          <tbody id="login_list"><tr><td colspan="6" class="muted">Loading...</td></tr></tbody>
        </table>
      </div>
    </div>
  </section>


  <script>
    (function () {
      document.addEventListener('click', function (e) {
        const tab = e.target.closest('.tab'); if (!tab) return;
        document.querySelectorAll('.tab').forEach(t => {
          const sel = t === tab;
          t.classList.toggle('active', sel);
          t.setAttribute('aria-selected', sel ? 'true' : 'false');
        });
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        const p = document.getElementById(tab.dataset.id); if (p) p.classList.add('active');
      }, true);
      const q = new URLSearchParams(location.search);
      const want = q.get('tab');
      if (want && document.getElementById(want)) {
        const btn = document.querySelector(`.tab[data-id="${want}"]`);
        if (btn) btn.click();
      }
    })();
  </script>

  <script type="module">
    async function safeInit() {
      let createClient;
      try {
        ({ createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'));
      } catch (e) {
        console.error('[system] Failed to import supabase-js:', e);
        document.getElementById('sess_badge').textContent = 'Supabase unavailable';
        return;
      }

      const sb = createClient(window.SUPABASE_URL || '', window.SUPABASE_ANON_KEY || '');
      const $ = (id)=>document.getElementById(id);
      const badge = $('sess_badge');
      const state = { saccos: [], vehicles: [], vehiclesLoaded: false, overview: null, ussdAvailable: [], ussdAllocated: [], logins: [], loginBeingEdited: null };
      const loginRoleMeta = {
        SACCO: { sacco: true, matatu: false, label: 'SACCO Admin' },
        OWNER: { sacco: false, matatu: true, label: 'Matatu Owner' },
        TAXI: { sacco: false, matatu: true, label: 'Taxi' },
        BODA: { sacco: false, matatu: true, label: 'BodaBoda' }
      };
      const numberFmt = new Intl.NumberFormat('en-KE');

      const parseErr = (err) => {
        if (!err) return 'Unknown error';
        if (typeof err === 'string') { try { const obj = JSON.parse(err); return obj.error || obj.message || err; } catch { return err; } }
        return err.error || err.message || String(err);
      };

      const toast = (text, type='ok')=>{
        const t = document.getElementById('toast') || (()=>{
          const div = document.createElement('div');
          div.id = 'toast'; document.body.appendChild(div);
          return div;
        })();
        t.textContent = text;
        t.className = type === 'err' ? 'show err' : 'show';
        clearTimeout(window._toastTimer);
        window._toastTimer = setTimeout(()=>{ t.className=''; }, 2200);
      };

      function clearInputs(ids){
        if (!Array.isArray(ids)) return;
        ids.forEach(id => {
          const el = $(id);
          if (!el) return;
          if (el.tagName === 'SELECT'){
            el.selectedIndex = 0;
          }else if ('value' in el){
            el.value = '';
          }
        });
      }

      async function ensureSession(){
        const { data:{ session } } = await sb.auth.getSession();
        if (!session?.access_token) {
          const next = encodeURIComponent(location.pathname + location.search);
          location.href = `/public/auth/login.html?next=${next}`;
          throw new Error('Not signed in');
        }
        badge.textContent = `Signed in as ${session.user.email}`;
        return session.access_token;
      }
      async function tkn(){ return ensureSession(); }

      async function jget(url){
        const token = await tkn();
        const r = await fetch(url, { headers:{ Authorization:`Bearer ${token}`, Accept:'application/json' }});
        const tx = await r.text();
        if (!r.ok) throw tx || r.statusText;
        try { return JSON.parse(tx); } catch { return {}; }
      }

      async function jpost(url, body){
        const token = await tkn();
        const r = await fetch(url, {
          method:'POST',
          headers:{ Authorization:`Bearer ${token}`, 'Content-Type':'application/json', Accept:'application/json' },
          body: JSON.stringify(body||{})
        });
        const tx = await r.text();
        if (!r.ok) throw tx || r.statusText;
        try { return JSON.parse(tx); } catch { return {}; }
      }

      function saccoLabel(id){
        if (!id) return '';
        const sacco = state.saccos.find(s => s.id === id);
        if (!sacco) return id;
        return sacco.name ? `${sacco.name} (${sacco.id})` : sacco.id;
      }

      function populateMatatuSaccoSelect(){
        const select = $('mt_sacco');
        if (!select) return;
        const current = select.value;
        const options = ['<option value=\"\">Select SACCO</option>'];
        state.saccos.forEach(row => {
          const label = row.name ? `${row.name} (${row.id})` : row.id;
          options.push(`<option value=\"${row.id}\">${label}</option>`);
        });
        select.innerHTML = options.join('');
        if (current && state.saccos.some(row => row.id === current)){
          select.value = current;
        }
        refreshMatatuSaccoMeta();
      }

      function refreshMatatuSaccoMeta(){
        const hint = $('mt_sacco_hint');
        const select = $('mt_sacco');
        const saccoId = select ? select.value : '';
        if (hint){
          if (!saccoId){
            hint.textContent = 'Select a SACCO to link this matatu.';
          }else{
            const sacco = state.saccos.find(s => s.id === saccoId);
            const base = sacco ? `${sacco.name || 'Unnamed SACCO'} - ID ${sacco.id}` : saccoId;
            const till = sacco?.default_till ? ` - Default till ${sacco.default_till}` : '';
            hint.textContent = base + till;
          }
        }
        renderExistingMatatuList(saccoId);
      }

      function renderExistingMatatuList(saccoId){
        const list = $('mt_existing_list');
        if (!list) return;
        if (!saccoId){
          list.classList.remove('stacked');
          list.classList.add('muted');
          list.textContent = 'Select a SACCO to see matatus registered under it.';
          return;
        }
        if (!state.vehiclesLoaded){
          list.classList.remove('stacked');
          list.classList.add('muted');
          list.textContent = 'Matatu register is still loading...';
          return;
        }
        const matatus = (state.vehicles||[]).filter(row => row.sacco_id === saccoId && !['TAXI','BODABODA'].includes(normalizeType(row)));
        if (!matatus.length){
          list.classList.remove('stacked');
          list.classList.add('muted');
          list.textContent = 'No matatus registered for this SACCO yet.';
          return;
        }
        list.classList.add('stacked');
        list.classList.remove('muted');
        list.innerHTML = matatus.map(row => {
          const owner = row.owner_name || 'Owner not set';
          const phone = row.owner_phone ? ` | ${row.owner_phone}` : '';
          return `<div class=\"item\"><strong>${owner}</strong> - ${row.number_plate || ''} (ID: ${row.id || ''})${phone}</div>`;
        }).join('');
      }

      function setMetric(id, value){
        const el = $(id);
        if (!el) return;
        if (value === undefined || value === null || Number.isNaN(value)){
          el.textContent = '—';
        }else{
          el.textContent = numberFmt.format(value);
        }
      }

      function renderOverview(){
        const counts = state.overview?.counts || {};
        const pool = state.overview?.ussd_pool || {};
        setMetric('ov_saccos', counts.saccos);
        setMetric('ov_matatus', counts.matatus);
        setMetric('ov_tx', counts.tx_today);
        setMetric('ov_pool_avail', pool.available);
        setMetric('ov_pool_total', pool.total);
      }

      async function loadOverview(){
        try{
          state.overview = await jget('/api/admin/system-overview');
        }catch(e){
          console.error('[system] overview', e);
          state.overview = null;
        }
        renderOverview();
      }

      $('logout_btn').addEventListener('click', async ()=>{
        await sb.auth.signOut();
        localStorage.removeItem('auth_token');
        sessionStorage.removeItem('auth_token');
        location.href = '/public/auth/login.html';
      });

      async function loadSaccos(){
        try{
          const data = await jget('/api/admin/saccos');
          const rows = Array.isArray(data.items) ? data.items : [];
          state.saccos = rows;
          populateLoginSelects();
          $('sc_list').innerHTML = rows.length ? rows.map(row=>`
            <tr>
              <td>${row.name||''}</td>
              <td>${row.contact_name||''}</td>
              <td>${row.contact_phone||''}</td>
              <td>${row.contact_email||''}</td>
              <td>${row.id||''}</td>
            </tr>`).join('') : '<tr><td colspan="5" class="muted">No SACCOs yet</td></tr>';
          populateMatatuSaccoSelect();
          if (state.vehiclesLoaded) renderVehicleTables();
        }catch(e){
          state.saccos = [];
          populateLoginSelects();
          populateMatatuSaccoSelect();
          if (state.vehiclesLoaded) renderVehicleTables();
          $('sc_list').innerHTML = `<tr><td colspan="5" class="err">${parseErr(e)}</td></tr>`;
        }
      }

      $('sc_add').addEventListener('click', async ()=>{
        const msg = $('sc_msg'); msg.className='muted'; msg.textContent='Saving…';
        const payload = {
          name: $('sc_name').value.trim(),
          contact_name: $('sc_contact_name').value.trim(),
          contact_phone: $('sc_phone').value.trim(),
          contact_email: $('sc_email').value.trim(),
          default_till: $('sc_till').value.trim() || null
        };
        if (!payload.name){
          msg.className='err'; msg.textContent='SACCO name required'; return;
        }
        try{
          const sacco = await jpost('/api/admin/register-sacco', payload);
          msg.className='ok'; msg.textContent='SACCO created';
          clearInputs(['sc_name','sc_contact_name','sc_phone','sc_email','sc_till']);
          await loadSaccos();
        }catch(e){
          msg.className='err'; msg.textContent=parseErr(e);
        }
      });

      const ussdForm = document.getElementById('ussdForm');
      if (ussdForm){
        ussdForm.addEventListener('submit', async (event)=>{
          event.preventDefault();
          const msg = $('ussdMsg');
          if (msg){
            msg.className = 'status muted';
            msg.textContent = 'Assigning...';
          }
          const formData = new FormData(ussdForm);
          const payload = {};
          formData.forEach((value, key)=>{
            const trimmed = (value ?? '').toString().trim();
            payload[key] = trimmed || null;
          });
          try{
            const res = await jpost('/api/admin/ussd/pool/assign-next', payload);
            if (msg){
              msg.className = 'status ok';
              msg.textContent = `Assigned ${res.ussd_code || 'code'}`;
            }
            ussdForm.reset();
            await Promise.all([loadUssd(), loadOverview()]);
          }catch(err){
            if (msg){
              msg.className = 'status err';
              msg.textContent = parseErr(err);
            }
          }
        });
      }

      function normalizeType(row){
        return (row?.vehicle_type || '').toString().toUpperCase();
      }

      function renderVehicleTables(){
        const items = Array.isArray(state.vehicles) ? state.vehicles : [];

        const matatus = items.filter(row => {
          const t = normalizeType(row);
          return t !== 'TAXI' && t !== 'BODABODA';
        });
        const taxis = items.filter(row => normalizeType(row) === 'TAXI');
        const bodas = items.filter(row => normalizeType(row) === 'BODABODA');

        $('mt_list').innerHTML = matatus.length ? matatus.map(row=>`
          <tr>
            <td>${row.number_plate||''}</td>
            <td>${row.owner_name||''}</td>
            <td>${row.vehicle_type||''}</td>
            <td>${saccoLabel(row.sacco_id) || 'N/A'}</td>
            <td>${row.id||''}</td>
          </tr>`).join('') : '<tr><td colspan="5" class="muted">No matatus yet</td></tr>';

        $('taxi_list').innerHTML = taxis.length ? taxis.map(row=>`
          <tr>
            <td>${row.number_plate||''}</td>
            <td>${saccoLabel(row.sacco_id) || 'N/A'}</td>
            <td>${row.id||''}</td>
          </tr>`).join('') : '<tr><td colspan="3" class="muted">No taxis yet</td></tr>';

        $('boda_list').innerHTML = bodas.length ? bodas.map(row=>`
          <tr>
            <td>${row.number_plate||''}</td>
            <td>${saccoLabel(row.sacco_id) || 'N/A'}</td>
            <td>${row.id||''}</td>
          </tr>`).join('') : '<tr><td colspan="3" class="muted">No boda bodas yet</td></tr>';
      }

      async function loadVehicles(){
        try{
          const data = await jget('/api/admin/matatus');
          state.vehicles = Array.isArray(data.items) ? data.items : [];
          state.vehiclesLoaded = true;
          populateLoginSelects();
          renderVehicleTables();
          refreshMatatuSaccoMeta();
        }catch(e){
          state.vehicles = [];
          state.vehiclesLoaded = false;
          populateLoginSelects();
          const errMatatu = `<tr><td colspan="5" class="err">${parseErr(e)}</td></tr>`;
          const errVehicle = `<tr><td colspan="3" class="err">${parseErr(e)}</td></tr>`;
          $('mt_list').innerHTML = errMatatu;
          $('taxi_list').innerHTML = errVehicle;
          $('boda_list').innerHTML = errVehicle;
          const list = $('mt_existing_list');
          if (list){
            list.classList.remove('stacked');
            list.classList.add('muted');
            list.textContent = `Failed to load matatus: ${parseErr(e)}`;
          }
        }
      }

      function renderUssd(){
        const avail = $('ussdAvail');
        if (avail){
          if (!state.ussdAvailable.length){
            avail.innerHTML = '<li class="muted">No free codes.</li>';
          }else{
            avail.innerHTML = state.ussdAvailable.slice(0,30).map(item => `<li>${item.full_code || `*001*${item.base||''}${item.checksum||''}#`}</li>`).join('');
          }
        }
        const alloc = $('ussdAlloc');
        if (alloc){
          if (!state.ussdAllocated.length){
            alloc.innerHTML = '<tr><td colspan="5" class="muted">No allocations yet.</td></tr>';
          }else{
            alloc.innerHTML = state.ussdAllocated.slice(0,30).map(item => {
              const updated = item.allocated_at ? new Date(item.allocated_at).toLocaleString() : '—';
              const level = item.allocated_to_type || item.level || '—';
              const linked = item.allocated_to_id || item.matatu_id || item.sacco_id || '—';
              return `
                <tr>
                  <td>${item.full_code || '—'}</td>
                  <td>${item.status || '—'}</td>
                  <td>${level}</td>
                  <td>${linked}</td>
                  <td>${updated}</td>
                </tr>`;
            }).join('');
          }
        }
      }

      async function loadUssd(){
        try{
          const [avail, alloc] = await Promise.all([
            jget('/api/admin/ussd/pool/available'),
            jget('/api/admin/ussd/pool/allocated')
          ]);
          state.ussdAvailable = Array.isArray(avail?.items) ? avail.items : [];
          state.ussdAllocated = Array.isArray(alloc?.items) ? alloc.items : [];
          renderUssd();
          const msg = $('ussdMsg');
          if (msg && msg.textContent.startsWith('Assigning')){
            msg.className = 'status ok';
            msg.textContent = 'Pool updated';
          }
        }catch(e){
          state.ussdAvailable = [];
          state.ussdAllocated = [];
          renderUssd();
          const msg = $('ussdMsg');
          if (msg){
            msg.className = 'status err';
            msg.textContent = parseErr(e);
          }
        }
      }

      async function handleVehicleRegistration(cfg){
        const msgEl = $(cfg.msgId);
        if (!msgEl) return;
        msgEl.className = 'muted';
        msgEl.textContent = 'Saving...';

        const plateEl = $(cfg.plateId);
        const saccoEl = $(cfg.saccoId);
        const ownerEl = cfg.ownerId ? $(cfg.ownerId) : null;
        const phoneEl = cfg.phoneId ? $(cfg.phoneId) : null;
        const tillEl = cfg.tillId ? $(cfg.tillId) : null;

        const number_plate = (plateEl?.value || '').trim().toUpperCase();
        const saccoValue = (saccoEl?.value || '').trim();
        const sacco_id = saccoValue || null;
        const requireSacco = cfg.requireSacco !== false;
        const owner_name = ownerEl ? ownerEl.value.trim() : '';
        const owner_phone = phoneEl ? phoneEl.value.trim() : '';
        const till_number = tillEl ? tillEl.value.trim() : '';

        if (!number_plate){
          msgEl.className = 'err';
          msgEl.textContent = 'Plate required';
          return;
        }
        if (requireSacco && !sacco_id){
          msgEl.className = 'err';
          msgEl.textContent = 'SACCO id required';
          return;
        }

        const payload = {
          number_plate,
          owner_name: owner_name || null,
          owner_phone: owner_phone || null,
          till_number: till_number || null,
          vehicle_type: cfg.type,
          sacco_id
        };

        try{
          const created = await jpost('/api/admin/register-matatu', payload);
          const vehicleId = created?.id;
          msgEl.className = 'ok';
          msgEl.textContent = `${cfg.successLabel} created`;
          await loadVehicles();
          await loadLogins();
        }catch(err){
          msgEl.className = 'err';
          msgEl.textContent = parseErr(err);
        }
      }

      const mtSaccoSelect = $('mt_sacco');
      if (mtSaccoSelect){
        mtSaccoSelect.addEventListener('change', refreshMatatuSaccoMeta);
      }

      $('mt_add').addEventListener('click', () =>{
        handleVehicleRegistration({
          type:'MATATU',
          plateId:'mt_plate',
          ownerId:'mt_owner',
          phoneId:'mt_phone',
          tillId:'mt_till',
          saccoId:'mt_sacco',
          msgId:'mt_msg',
          successLabel:'Matatu',
          clearIds:['mt_plate','mt_owner','mt_phone','mt_till','mt_sacco']
        });
      });

      $('taxi_add').addEventListener('click', () =>{
        handleVehicleRegistration({
          type:'TAXI',
          plateId:'taxi_plate',
          ownerId:'taxi_owner',
          phoneId:'taxi_phone',
          tillId:'taxi_till',
          saccoId:'taxi_sacco',
          msgId:'taxi_msg',
          successLabel:'Taxi',
          requireSacco:false,
          clearIds:['taxi_plate','taxi_owner','taxi_phone','taxi_till','taxi_sacco']
        });
      });

      $('boda_add').addEventListener('click', () =>{
        handleVehicleRegistration({
          type:'BODABODA',
          plateId:'boda_plate',
          ownerId:'boda_owner',
          phoneId:'boda_phone',
          tillId:'boda_till',
          saccoId:'boda_sacco',
          msgId:'boda_msg',
          successLabel:'Boda boda',
          requireSacco:false,
          clearIds:['boda_plate','boda_owner','boda_phone','boda_till','boda_sacco']
        });
      });
      function renderLoginTable(){
        const tbody = $('login_list');
        if (!tbody) return;
        if (!state.logins.length){
          tbody.innerHTML = '<tr><td colspan="6" class="muted">No logins yet</td></tr>';
          return;
        }
        tbody.innerHTML = state.logins.map(row => {
          const created = row.created_at ? new Date(row.created_at).toLocaleString() : '—';
          const canManage = Boolean(loginRoleMeta[row.role || '']);
          const editBtn = canManage ? `<button class="btn ghost" type="button" data-edit="${row.user_id}">Edit</button>` : '';
          const deleteBtn = `<button class="btn danger" type="button" data-delete="${row.user_id}">Remove</button>`;
          const actions = editBtn ? `${editBtn} ${deleteBtn}` : deleteBtn;
          return `
            <tr>
              <td>${row.email || '—'}</td>
              <td>${row.role || '—'}</td>
              <td>${row.sacco_id || '—'}</td>
              <td>${row.matatu_id || '—'}</td>
              <td>${created}</td>
              <td>${actions}</td>
            </tr>`;
        }).join('');
      }

      async function loadLogins(){
        try{
          const rows = await jget('/api/admin/user-roles/logins');
          state.logins = Array.isArray(rows) ? rows : [];
          renderLoginTable();
        }catch(e){
          state.logins = [];
          const tbody = $('login_list');
          if (tbody){
            tbody.innerHTML = `<tr><td colspan="6" class="err">${parseErr(e)}</td></tr>`;
          }
        }
      }

      function populateLoginSelects(){
        const saccoOptions = ['<option value=\"\">Select SACCO</option>']
          .concat(state.saccos.map(row => `<option value=\"${row.id}\">${row.name || row.id}</option>`));
        ['login_sacco','edit_sacco'].forEach(id => {
          const el = $(id);
          if (!el) return;
          const current = el.value;
          el.innerHTML = saccoOptions.join('');
          if (current) el.value = current;
        });

        const matatuOptions = ['<option value=\"\">Select Matatu</option>']
          .concat(state.vehicles.map(row => {
            const id = row.id || '';
            const label = row.number_plate || id || 'Matatu';
            const display = id ? `${label} (${id})` : label;
            return `<option value=\"${id}\">${display}</option>`;
          }));
        ['login_matatu','edit_matatu'].forEach(id => {
          const el = $(id);
          if (!el) return;
          const current = el.value;
          el.innerHTML = matatuOptions.join('');
          if (current) el.value = current;
        });
      }

      function setLoginFieldVisibility(prefix, role){
        const meta = loginRoleMeta[role] || {};
        const saccoField = document.querySelector(`[data-login-field="${prefix}-sacco"]`);
        const matatuField = document.querySelector(`[data-login-field="${prefix}-matatu"]`);
        if (saccoField) saccoField.classList.toggle('hidden', !meta.sacco);
        if (matatuField) matatuField.classList.toggle('hidden', !meta.matatu);
      }

      function openLoginEditor(userId){
        const entry = state.logins.find(l => l.user_id === userId);
        const wrap = $('loginEditor');
        if (!entry || !wrap) return;
        state.loginBeingEdited = entry;
        wrap.hidden = false;
        $('edit_user_id').value = entry.user_id;
        $('edit_email').value = entry.email || '';
        $('edit_role').value = entry.role || 'SACCO';
        $('edit_sacco').value = entry.sacco_id || '';
        $('edit_matatu').value = entry.matatu_id || '';
        $('edit_password').value = '';
        setLoginFieldVisibility('edit', $('edit_role').value);
      }

      function closeLoginEditor(){
        state.loginBeingEdited = null;
        const wrap = $('loginEditor');
        if (wrap) wrap.hidden = true;
        $('edit_user_id')?.value = '';
        $('edit_password')?.value = '';
        const msg = $('login_edit_msg');
        if (msg) msg.textContent = '';
      }

      const loginRoleSelect = $('login_role');
      if (loginRoleSelect){
        loginRoleSelect.addEventListener('change', ()=> setLoginFieldVisibility('create', loginRoleSelect.value));
        setLoginFieldVisibility('create', loginRoleSelect.value);
      }

      const editRoleSelect = $('edit_role');
      if (editRoleSelect){
        editRoleSelect.addEventListener('change', ()=> setLoginFieldVisibility('edit', editRoleSelect.value));
      }

      const cancelEditBtn = $('cancelEdit');
      if (cancelEditBtn){
        cancelEditBtn.addEventListener('click', () => closeLoginEditor());
      }

      const loginForm = $('loginForm');
      if (loginForm){
        loginForm.addEventListener('submit', async (event)=>{
          event.preventDefault();
          const role = $('login_role').value;
          const email = ($('login_email').value || '').trim();
          const password = $('login_password').value || '';
          const saccoId = $('login_sacco').value || '';
          const matatuId = $('login_matatu').value || '';
          const msg = $('login_create_msg');
          const meta = loginRoleMeta[role] || {};
          if (!email || !password){
            msg.className = 'status err';
            msg.textContent = 'Email and password are required';
            return;
          }
          if (meta.sacco && !saccoId){
            msg.className = 'status err';
            msg.textContent = 'Select a SACCO';
            return;
          }
          if (meta.matatu && !matatuId){
            msg.className = 'status err';
            msg.textContent = 'Select a matatu';
            return;
          }
          msg.className = 'status muted';
          msg.textContent = 'Creating...';
          const body = { email, password, role };
          if (meta.sacco) body.sacco_id = saccoId;
          if (meta.matatu) body.matatu_id = matatuId;
          try{
            await jpost('/api/admin/user-roles/create-user', body);
            msg.className = 'status ok';
            msg.textContent = 'Login created';
            loginForm.reset();
            setLoginFieldVisibility('create', $('login_role').value);
            await loadLogins();
          }catch(err){
            msg.className = 'status err';
            msg.textContent = parseErr(err);
          }
        });
      }

      const loginEditForm = $('loginEditForm');
      if (loginEditForm){
        loginEditForm.addEventListener('submit', async (event)=>{
          event.preventDefault();
          const userId = $('edit_user_id').value;
          if (!userId) return;
          const role = $('edit_role').value;
          const email = ($('edit_email').value || '').trim();
          const password = $('edit_password').value || '';
          const saccoId = $('edit_sacco').value || '';
          const matatuId = $('edit_matatu').value || '';
          const meta = loginRoleMeta[role] || {};
          const msg = $('login_edit_msg');
          if (!email){
            msg.className = 'status err';
            msg.textContent = 'Email is required';
            return;
          }
          if (meta.sacco && !saccoId){
            msg.className = 'status err';
            msg.textContent = 'Select a SACCO';
            return;
          }
          if (meta.matatu && !matatuId){
            msg.className = 'status err';
            msg.textContent = 'Select a matatu';
            return;
          }
          const body = { user_id: userId, role, email };
          body.sacco_id = meta.sacco ? saccoId : null;
          body.matatu_id = meta.matatu ? matatuId : null;
          if (password) body.password = password;
          msg.className = 'status muted';
          msg.textContent = 'Saving...';
          try{
            await jpost('/api/admin/user-roles/update', body);
            msg.className = 'status ok';
            msg.textContent = 'Login updated';
            closeLoginEditor();
            await loadLogins();
          }catch(err){
            msg.className = 'status err';
            msg.textContent = parseErr(err);
          }
        });
      }

      const loginTable = $('login_list');
      if (loginTable){
        loginTable.addEventListener('click', async (event)=>{
          const editBtn = event.target.closest('button[data-edit]');
          if (editBtn){
            openLoginEditor(editBtn.getAttribute('data-edit'));
            return;
          }
          const deleteBtn = event.target.closest('button[data-delete]');
          if (deleteBtn){
            const userId = deleteBtn.getAttribute('data-delete');
            if (!userId) return;
            if (!confirm('Remove this login?')) return;
            const resp = await fetch(`/api/admin/user-roles/${userId}?remove_user=true`, { method:'DELETE' });
            if (!resp.ok){
              let message = resp.statusText;
              try{
                const data = await resp.json();
                message = data.error || message;
              }catch(_){}
              alert(message);
              return;
            }
            if (state.loginBeingEdited?.user_id === userId){
              closeLoginEditor();
            }
            await loadLogins();
          }
        });
      }

      try{
        await ensureSession();
        await Promise.all([loadOverview(), loadSaccos(), loadVehicles(), loadLogins(), loadUssd()]);
      }catch(_){}
    }
    safeInit();
  </script>
</body>
</html>
