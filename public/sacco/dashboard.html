<!doctype html>
<html lan      if(!currentSacco) return alert('Pick a SACCO first');
      const matatuId = lnMatatu.value;
      if(!matatuId) return alert('Select a Matatu — loans must be tied to the vehicle owner');
      const m = (window._matatuFull && window._matatuFull.get(matatuId)) || null;
      const ownerName = (m && (m.owner_name||'')) || '';
      lnBorrower.value = ownerName; // enforce borrower = owner
      // Enforce model interest and max duration (6 months)
      const model = document.getElementById('lnModel')?.value || 'MONTHLY';
      if (model === 'DAILY') { document.getElementById('lnRate').value = '10'; }
      else if (model === 'WEEKLY') { document.getElementById('lnRate').value = '20'; }
      else { document.getElementById('lnRate').value = '30'; }
      let t = Number(document.getElementById('lnTerm').value||1);
      if (t > 6) t = 6; if (t < 1) t = 1; document.getElementById('lnTerm').value = String(t);g="en">
<head>
  <meta charset="utf-8"/>
  <title>TekeTeke ï¿½ SACCO Dashboard</title>

  <link rel="stylesheet" href="/public/css/dashboard-theme.css"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <script src="/public/js/app-config.js"></script>
  <script src="/public/js/api.js"></script>

  <!-- Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="top-meta hero-card">
  <div class="top-left hero-stack">
    <p class="eyebrow" style="margin:0;text-transform:uppercase;letter-spacing:.3em;font-size:11px">SACCO Console</p>
    <h2 style="margin:0" id="saccoHeadline">SACCO Dashboard</h2>
    <div class="hello-block" style="margin-top:6px">
      <div class="hello" id="welcomeLine">Hello!</div>
      <div class="time" id="dateTimeLine">--</div>
    </div>
  </div>
  <div class="top-actions hero-actions">
    <a class="btn ghost" href="/public/auth/role-select.html">Role Select</a>
    <span id="auth_state" class="pill">Checking sign-in.</span>
    <button id="logoutBtn" class="btn bad">Logout</button>
  </div>
</div>

<div class="bar">
    <label>SACCO <select id="saccoSelect"></select></label>
    <label>From <input id="fromDate" type="date"></label>
    <label>To <input id="toDate" type="date"></label>
    <button id="applyRange">Apply</button>
    <span class="right k" id="statusMsg"></span>
  </div>

  <div class="tabs" role="tablist" aria-label="Sections">
    <div class="tab active" data-panel="p_matatus" role="tab" aria-selected="true">Matatus</div>
    <div class="tab" data-panel="p_summary" role="tab" aria-selected="false">Collections</div>
    <div class="tab" data-panel="p_tx" role="tab" aria-selected="false">Transactions</div>
    <div class="tab" data-panel="p_staffcol" role="tab" aria-selected="false">Staff Collections</div>
    <div class="tab" data-panel="p_ops" role="tab" aria-selected="false">Payments (STK)</div>
    <div class="tab" data-panel="p_staff" role="tab" aria-selected="false">Staff</div>
    <div class="tab" data-panel="p_loans" role="tab" aria-selected="false">Loans</div>
  </div>

  <!-- Matatus -->
  <section id="p_matatus" class="panel active">
    <div class="row">
      <input id="matatuSearch" placeholder="Search plateï¿½"/>
      <button class="ghost" id="reloadMatatus">Reload</button>
      <span class="right k" id="matatuCount"></span>
    </div>
    <table>
      <thead>
        <tr><th>Plate</th><th>Owner</th><th>Phone</th><th>Type</th><th>TLB</th><th>Till</th><th>ID</th></tr>
      </thead>
      <tbody id="matatuTbody"></tbody>
    </table>
  </section>

  <!-- Staff Collections -->
  <section id="p_staffcol" class="panel">
    <div class="card">
      <div class="row"><h3 style="margin:0">Summary by Staff</h3><button id="sc_refresh" class="ghost right">Reload</button></div>
      <div class="muted" style="margin:6px 0">Using the date range above. Includes SUCCESS transactions only.</div>
      <div class="table-wrap">
        <table>
          <thead><tr><th>Staff</th><th>Email</th><th>Daily Fee</th><th>Savings</th><th>Loan Repay</th><th>Total</th></tr></thead>
          <tbody id="sc_sum_tbody"><tr><td colspan="6" class="muted">Loading.</td></tr></tbody>
        </table>
      </div>
    </div>
    <div class="card" style="margin-top:12px">
      <h3>Breakdown by Staff & Matatu</h3>
      <div class="table-wrap">
        <table>
          <thead><tr><th>Staff</th><th>Matatu</th><th>Kind</th><th>Amount</th><th>Count</th></tr></thead>
          <tbody id="sc_col_tbody"><tr><td colspan="5" class="muted">Loading.</td></tr></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Collections summary -->
  <section id="p_summary" class="panel">
    <div class="grid">
      <div class="card"><div class="k">FARE (gross)</div><div class="v" id="sum_fare">0</div></div>
      <div class="card"><div class="k">SAVINGS</div><div class="v" id="sum_savings">0</div></div>
      <div class="card"><div class="k">LOAN REPAY</div><div class="v" id="sum_loan">0</div></div>
      <div class="card"><div class="k">SACCO FEE</div><div class="v" id="sum_sacco">0</div></div>
    </div>
    <div class="card" style="margin-top:16px">
      <canvas id="summaryChart" height="120"></canvas>
      <p class="note">Chart shows SACCO_FEE by day (computed client-side for the selected range).</p>
    </div>
  </section>

  <!-- Transactions -->
  <section id="p_tx" class="panel">
    <div class="row">
      <label>Status
        <select id="txStatus">
          <option value="">All</option>
          <option value="SUCCESS">SUCCESS</option>
          <option value="PENDING">PENDING</option>
          <option value="FAILED">FAILED</option>
          <option value="TIMEOUT">TIMEOUT</option>
        </select>
      </label>
      <button class="ghost" id="reloadTx">Reload</button>
      <button id="exportTx">Export CSV</button>
      <span class="right k" id="txCount"></span>
    </div>
    <table>
      <thead>
        <tr><th>Time</th><th>Matatu</th><th>MSISDN</th><th>Fare</th><th>Service Fee</th><th>Status</th><th>Kind</th><th>ID</th></tr>
      </thead>
      <tbody id="txTbody"></tbody>
    </table>
  </section>

  <!-- Payments (STK only) -->
  <section id="p_ops" class="panel">
    <div class="card">
      <h3>Send STK Prompt</h3>
      <div class="row">
        <input id="stkCode" placeholder="*001*1101#"/>
        <input id="stkAmt" type="number" placeholder="amount"/>
        <input id="stkPhone" placeholder="07XXXXXXXX"/>
        <button id="stkGo">Send</button>
      </div>
      <pre id="stkOut" class="mono">{}</pre>
      <p class="note">USSD assignment is disabled here. Only system admin can assign USSD codes.</p>
    </div>
  </section>

  <!-- Staff -->
  <section id="p_staff" class="panel">
    <div class="card">
      <h3>Register Staff</h3>
      <div class="form-grid-4">
        <input id="stName" placeholder="Full name"/>
        <input id="stPhone" placeholder="07XXXXXXXX"/>
        <input id="stEmail" placeholder="email@example.com"/>
        <select id="stRole">
          <option value="SACCO_STAFF">SACCO_STAFF</option>
          <option value="SACCO_ADMIN">SACCO_ADMIN</option>
        </select>
      </div>
      <div class="row" style="margin-top:8px">
        <input id="stPass" type="password" placeholder="Password (optional if not creating login)" style="max-width:320px"/>
        <span class="muted" style="align-self:center">Provide email + password to create a login.</span>
      </div>
      <button id="stAdd">Add Staff</button>
    </div>
    <div class="card" style="margin-top:12px">
      <h3>Current Staff</h3>
      <table>
        <thead><tr><th>Name</th><th>Phone</th><th>Email</th><th>Role</th><th>ID</th></tr></thead>
        <tbody id="staffTbody"></tbody>
      </table>
    </div>
  </section>

  <!-- Loans -->
  <section id="p_loans" class="panel">
    <div class="card">
      <h3>Create Loan</h3>
      <div class="form-grid">
          <select id="lnMatatu" class="w-2"><option value="">ï¿½ choose Matatu ï¿½</option></select>
          <input id="lnBorrower" placeholder="Owner (auto)" readonly title="Borrower is the selected matatu owner"/>
        <input id="lnPrincipal" type="number" placeholder="Principal (KES)"/>
        <select id="lnModel">
          <option value="DAILY">Daily collection (10% per month, max 6 months)</option>
          <option value="WEEKLY">Weekly collection (20% per month, max 6 months)</option>
          <option value="MONTHLY">Monthly collection (30% per month, max 6 months)</option>
        </select>
        <input id="lnStart" type="date" placeholder="Start date"/>
        <input id="lnRate" type="number" placeholder="Interest %"/>
        <input id="lnTerm" type="number" placeholder="Term (months)"/>
      </div>
      <div id="lnSummary" class="muted" style="margin:8px 0"></div>
      <button id="lnAdd">Create Loan</button>
    </div>
    <div class="card" style="margin-top:12px">
      <h3>Loans</h3>
      <table>
        <thead><tr><th>Borrower</th><th>Matatu</th><th>Principal</th><th>Rate %</th><th>Term (m)</th><th>Status</th><th>ID</th></tr></thead>
        <tbody id="loanTbody"></tbody>
      </table>
    </div>
  </section>

  <script>
  (function(){
    const $ = id => document.getElementById(id);
    const isoDate = d => new Date(d).toISOString().slice(0,10);
    const today = isoDate(new Date());
    const fmtKES = n => Number(n||0).toLocaleString('en-KE',{minimumFractionDigits:2,maximumFractionDigits:2});

    let supaClient = null;

    async function ensureSupabase(){
      if (window.TT && typeof window.TT.getSupabase === 'function'){
        try{ return await window.TT.getSupabase(); }catch(_){ /* ignore */ }
      }
      if (supaClient) return supaClient;
      try{
        const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');
        const url = window.SUPABASE_URL || '';
        const anon = window.SUPABASE_ANON_KEY || '';
        if (!url || !anon) return null;
        supaClient = createClient(url, anon);
        return supaClient;
      }catch(err){
        console.warn('[sacco] failed to init supabase', err);
        return null;
      }
    }

    function friendlyName(user){
      if(!user) return 'SACCO Admin';
      const meta = user.user_metadata || {};
      const email = user.email || '';
      return meta.full_name || meta.name || meta.display_name || meta.displayName || (email ? email.split('@')[0] : 'SACCO Admin');
    }

    function startClock(){
      const el = $('dateTimeLine');
      if(!el) return;
      const tick = ()=>{ el.textContent = new Date().toLocaleString(); };
      tick();
      setInterval(tick, 1000);
    }
    startClock();

    async function setupSessionUi(){
      const pill = $('auth_state');
      const welcome = $('welcomeLine');
      try{
        const supa = await ensureSupabase();
        if(!supa){
          if (pill) pill.textContent = 'Sign-in unavailable';
          return;
        }
        const { data:{ session } } = await supa.auth.getSession();
        const user = session?.user || null;
        if (pill) pill.textContent = user?.email ? `Signed in as ${user.email}` : 'Not signed in';
        if (welcome) welcome.textContent = `Hello, ${friendlyName(user)}`;
        const btn = $('logoutBtn');
        if (btn && !btn.dataset.bound){
          btn.dataset.bound = '1';
          btn.addEventListener('click', async ()=>{
            btn.disabled = true;
            try{ await supa.auth.signOut(); }catch(_){}
            ['auth_token','tt_root_token','tt_admin_token'].forEach(k=>localStorage.removeItem(k));
            location.href = '/public/auth/login.html';
          });
        }
      }catch(err){
        console.warn('[sacco] session ui error', err);
        if (pill) pill.textContent = 'Sign-in error';
      }
    }
    setupSessionUi();

    async function parse(res){
      const t = await res.text();
      let j = {};
      try { j = t ? JSON.parse(t) : {}; } catch { j = { error: t || res.statusText }; }
      if (!res.ok) throw new Error(j.error||j.message||res.statusText||'Request failed');
      return j;
    }
    async function jget(path){
      return parse(await fetch(path,{ headers:{ Accept:'application/json' }}));
    }

    // Tabs (delegated, with aria)
    (function setupTabs(){
      const tabsWrap = document.querySelector('.tabs');
      if(!tabsWrap) return;
      tabsWrap.addEventListener('click', (e)=>{
        const tab = e.target.closest('.tab'); if(!tab) return;
        const id = tab.getAttribute('data-panel');
        document.querySelectorAll('.tab').forEach(t=>{
          const sel = t===tab;
          t.classList.toggle('active', sel);
          t.setAttribute('aria-selected', sel ? 'true' : 'false');
        });
        document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
        const panel = document.getElementById(id);
        if(panel){ panel.classList.add('active'); panel.scrollTop=0; }
      });
    })();

    // Date defaults
    $('toDate').value = today;
    $('fromDate').value = isoDate(new Date(Date.now() - 6*24*3600*1000));

    let currentSacco = null;
    let matatuMap = new Map();
    const saccoNames = new Map();
    const headlineEl = document.getElementById('saccoHeadline');
    const defaultHeadline = 'SACCO Dashboard';
    function updateHeadlineFor(id){
      if(!headlineEl) return;
      const label = id ? (saccoNames.get(id) || id) : '';
      const trimmed = (label || '').trim();
      if(!trimmed){
        headlineEl.textContent = defaultHeadline;
        return;
      }
      const endsWithSacco = /\bsacco\b$/i.test(trimmed);
      headlineEl.textContent = endsWithSacco ? `${trimmed} Dashboard` : `${trimmed} SACCO Dashboard`;
    }

    async function loadSaccos(){
      const sel = $('saccoSelect');
      sel.innerHTML = '<option value="">- choose -</option>';
      const res = await jget('/u/my-saccos');
      const items = res.items || [];
      saccoNames.clear();
      items.forEach(s=>{
        const o=document.createElement('option');
        o.value=s.sacco_id;
        o.textContent=s.name||s.sacco_id;
        sel.appendChild(o);
        saccoNames.set(s.sacco_id, s.name || s.sacco_id);
      });
      $('statusMsg').textContent = `${items.length} SACCO(s)`;
      if(items.length){
        sel.value = items[0].sacco_id;
        currentSacco = sel.value;
        updateHeadlineFor(currentSacco);
      } else {
        currentSacco = null;
        updateHeadlineFor(null);
      }
    }

    async function loadMatatus(){
      if(!currentSacco) return;
      const data = await jget(`/u/sacco/${currentSacco}/matatus`);
      matatuMap = new Map((data.items||[]).map(m=>[m.id,m.number_plate||'']));
      // Keep full matatu details for loan owner validation
      window._matatuFull = new Map((data.items||[]).map(m=>[m.id, m]));
      const q = $('matatuSearch').value.trim().toUpperCase();
      const rows = (data.items||[]).filter(m => !q || (m.number_plate||'').toUpperCase().includes(q));
      const T = $('matatuTbody'); T.innerHTML = '';
      rows.forEach(m=>{
        const tr = document.createElement('tr');
        tr.innerHTML =
          `<td>${m.number_plate||''}</td><td>${m.owner_name||''}</td><td>${m.owner_phone||''}</td>`+
          `<td>${m.vehicle_type||''}</td><td>${m.tlb_number||''}</td><td>${m.till_number||''}</td>`+
          `<td class="mono">${m.id}</td>`;
        T.appendChild(tr);
      });
      $('matatuCount').textContent = `${rows.length} matatu(s)`;

      // loans matatu select
      const sel = $('lnMatatu');
      sel.innerHTML = '<option value="">ï¿½ choose Matatu ï¿½</option>';
      (data.items||[]).forEach(m=>{
        const o=document.createElement('option');
        o.value=m.id; o.textContent=m.number_plate + (m.owner_name ? ` ï¿½ ${m.owner_name}` : '');
        sel.appendChild(o);
      });
      // When matatu changes, auto-fill borrower as the owner and lock it
      sel.onchange = ()=>{
        const id = sel.value;
        const m = window._matatuFull?.get(id) || null;
        const owner = (m && (m.owner_name||'')) || '';
        const b = $('lnBorrower');
        b.value = owner;
        try { updateLoanSummary && updateLoanSummary(); } catch(_){ }
      };
    }

    function withinRange(ts,fromIso,toIso){
      const d = isoDate(ts);
      return d>=fromIso && d<=toIso;
    }
    function groupByDay(items){
      const map = new Map();
      items.forEach(tx=>{
        const day = isoDate(tx.created_at);
        map.set(day,(map.get(day)||0) + Number(tx.kind==='SACCO_FEE' ? (tx.fare_amount_kes||0) : 0));
      });
      const labels=[]; const values=[];
      const start=new Date($('fromDate').value+'T00:00:00');
      const end=new Date($('toDate').value+'T00:00:00');
      for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)){
        const key=isoDate(d);
        labels.push(key);
        values.push(map.get(key)||0);
      }
      return {labels, values};
    }

    function renderChart(id,label,labels,values){
      const ctx=document.getElementById(id);
      if(ctx._inst) ctx._inst.destroy();
      ctx._inst=new Chart(ctx,{
        type:'line',
        data:{ labels, datasets:[{ label, data:values, borderColor:'#1976d2', backgroundColor:'transparent', tension:.25 }] },
        options:{ responsive:true, scales:{ y:{ beginAtZero:true } } }
      });
    }

    async function loadTxAndTotals(){
      if(!currentSacco) return;
      const res = await jget(`/u/sacco/${currentSacco}/transactions?limit=1000`);
      const fromIso=$('fromDate').value, toIso=$('toDate').value, status=$('txStatus').value;
      const all=(res.items||[]).filter(tx=>withinRange(tx.created_at,fromIso,toIso));
      const items = status ? all.filter(tx=>(tx.status||'')===status) : all;

      const T=$('txTbody'); T.innerHTML='';
      items.forEach(tx=>{
        const tr=document.createElement('tr');
        tr.innerHTML =
          `<td>${new Date(tx.created_at).toLocaleString()}</td><td class="mono">${tx.matatu_id||''}</td>`+
          `<td class="mono">${tx.passenger_msisdn||''}</td><td>${fmtKES(tx.fare_amount_kes)}</td>`+
          `<td>${fmtKES(tx.service_fee_kes)}</td><td>${tx.status||''}</td><td>${tx.kind||''}</td>`+
          `<td class="mono">${tx.id}</td>`;
        T.appendChild(tr);
      });
      $('txCount').textContent = `${items.length} row(s)`;

      const sum = k => all.filter(t=>t.kind===k).reduce((a,b)=>a+Number(b.fare_amount_kes||0),0);
      $('sum_fare').textContent   = fmtKES(sum('FARE'));
      $('sum_savings').textContent= fmtKES(sum('SAVINGS'));
      $('sum_loan').textContent   = fmtKES(sum('LOAN_REPAY'));
      $('sum_sacco').textContent  = fmtKES(sum('SACCO_FEE'));

      const g = groupByDay(all);
      renderChart('summaryChart','SACCO Fee (KES)',g.labels,g.values);
    }

    async function loadStaffCollections(){
      if(!currentSacco) return;
      const res = await jget(`/u/sacco/${currentSacco}/transactions?limit=2000`);
      const fromIso=$('fromDate').value, toIso=$('toDate').value;
      const items=(res.items||[]).filter(tx=>withinRange(tx.created_at,fromIso,toIso) && (tx.status||'')==='SUCCESS');

      const staffMap = new Map(); // key -> {name,email,df,sav,loan,total}
      const brk = new Map(); // key -> {staff, plate, kind, amount, count}

      const staffKey = (tx)=>{
        const name = tx.created_by_name || '';
        const email = tx.created_by_email || '';
        const id = tx.created_by || '';
        return id || email || name || 'ï¿½';
      };
      const staffLabel = (tx)=> (tx.created_by_name || tx.created_by_email || 'ï¿½');
      const plateFor = (id)=> (matatuMap.get(id)||id||'');

      items.forEach(tx=>{
        // classify kind
        const k = tx.kind === 'SACCO_FEE' ? 'df' : (tx.kind === 'SAVINGS' ? 'sav' : (tx.kind === 'LOAN_REPAY' ? 'loan' : null));
        if (!k) return;
        const amt = Number(tx.fare_amount_kes||0);
        const key = staffKey(tx);
        const label = staffLabel(tx);
        const email = tx.created_by_email || '';
        const row = staffMap.get(key) || { name: label, email, df:0, sav:0, loan:0, total:0 };
        row[k] += amt; row.total += amt; row.email = email || row.email; row.name = label || row.name;
        staffMap.set(key, row);

        const bkey = `${key}|${tx.matatu_id||''}|${tx.kind}`;
        const brow = brk.get(bkey) || { staff: label, plate: plateFor(tx.matatu_id), kind: tx.kind, amount:0, count:0 };
        brow.amount += amt; brow.count += 1; brk.set(bkey, brow);
      });

      // Render summary
      const sumBody = $('sc_sum_tbody'); sumBody.innerHTML='';
      const rows = Array.from(staffMap.values()).sort((a,b)=> b.total - a.total);
      rows.forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${r.name||'ï¿½'}</td><td class="mono">${r.email||''}</td>`+
                       `<td>${fmtKES(r.df)}</td><td>${fmtKES(r.sav)}</td><td>${fmtKES(r.loan)}</td><td><strong>${fmtKES(r.total)}</strong></td>`;
        sumBody.appendChild(tr);
      });
      if (!rows.length) sumBody.innerHTML = '<tr><td colspan="6" class="muted">No data in range.</td></tr>';

      // Render breakdown
      const colBody = $('sc_col_tbody'); colBody.innerHTML='';
      const brows = Array.from(brk.values()).sort((a,b)=> b.amount - a.amount);
      brows.forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${r.staff||'ï¿½'}</td><td class="mono">${r.plate||''}</td><td>${r.kind}</td><td>${fmtKES(r.amount)}</td><td>${r.count}</td>`;
        colBody.appendChild(tr);
      });
      if (!brows.length) colBody.innerHTML = '<tr><td colspan="5" class="muted">No data in range.</td></tr>';
    }

    // STK
    $('stkGo').onclick = async ()=>{
      try{
        const body = {
          code:  $('stkCode').value.trim(),
          amount:Number($('stkAmt').value||0),
          phone: $('stkPhone').value.trim()
        };
        const r = await fetch('/api/pay/stk',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
        $('stkOut').textContent = await r.text();
      }catch(e){ $('stkOut').textContent = e.message; }
    };

    // Staff
    async function loadStaff(){
      if(!currentSacco) return;
      try{
        const res = await jget(`/u/sacco/${currentSacco}/staff`);
        const T=$('staffTbody'); T.innerHTML='';
        (res.items||[]).forEach(s=>{
          const tr=document.createElement('tr');
          tr.innerHTML = `<td>${s.name||''}</td><td>${s.phone||''}</td><td>${s.email||''}</td><td>${s.role||''}</td><td class="mono">${s.id}</td>`;
          T.appendChild(tr);
        });
      }catch(e){
        $('staffTbody').innerHTML = `<tr><td colspan="5" class="err">${parseErr(e)}</td></tr>`;
      }
    }
      $('stAdd').onclick = async ()=>{
        if(!currentSacco) return alert('Pick a SACCO first');
        const body = {
          sacco_id: currentSacco,
          name:  $('stName').value.trim(),
          phone: $('stPhone').value.trim(),
          email: $('stEmail').value.trim(),
          role:  $('stRole').value,
          password: $('stPass').value
        };
        try{
          await parse(await fetch(`/u/sacco/${currentSacco}/staff`,{
            method:'POST',
            headers:{ 'Content-Type':'application/json', Accept:'application/json' },
            body: JSON.stringify(body)
          }));
          $('stName').value = $('stPhone').value = $('stEmail').value = '';
          $('stPass').value = '';
          await loadStaff();
          alert('Staff added');
        }catch(e){ alert(e.message); }
      };

    // Loans
    function addMonths(date, m){ const d = new Date(date); d.setMonth(d.getMonth()+m); return d; }
    function countWeekdaysInclusive(start, end){
      try{ let c=0, d=new Date(start); d.setHours(0,0,0,0); const e=new Date(end); e.setHours(0,0,0,0); while(d<=e){ const day=d.getDay(); if(day>=1 && day<=5) c++; d.setDate(d.getDate()+1);} return Math.max(1,c);}catch(_){ return 1; }
    }
    function weeksInRange(start, end){ try{ const ms = new Date(end).getTime() - new Date(start).getTime(); return Math.max(1, Math.ceil(ms/(7*24*3600*1000))); }catch(_){ return 1; } }
    function updateLoanSummary(){
      const principal = Number((document.getElementById('lnPrincipal')?.value)||0);
      const model = document.getElementById('lnModel')?.value || 'MONTHLY';
      const rateEl = document.getElementById('lnRate'); const termEl = document.getElementById('lnTerm'); const startEl=document.getElementById('lnStart');
      if (!startEl) return;
      if (model === 'DAILY'){
        rateEl.value = '10'; rateEl.readOnly = true; termEl.readOnly = false;
        if (!termEl.value) termEl.value='1';
        if (Number(termEl.value)>6) termEl.value='6';
        if (Number(termEl.value)<1) termEl.value='1';
      } else if (model === 'WEEKLY'){
        rateEl.value = '20'; rateEl.readOnly = true; termEl.readOnly = false;
        if (!termEl.value) termEl.value='1';
        if (Number(termEl.value)>6) termEl.value='6';
        if (Number(termEl.value)<1) termEl.value='1';
      } else { // MONTHLY
        rateEl.value = '30'; rateEl.readOnly = true; termEl.readOnly = false;
        if (!termEl.value) termEl.value='1';
        if (Number(termEl.value)>6) termEl.value='6';
        if (Number(termEl.value)<1) termEl.value='1';
      }
      const rate = Number(rateEl.value||0); const term = Math.max(1, Number(termEl.value||1));
      const start = startEl.value || new Date().toISOString().slice(0,10);
      const end = addMonths(new Date(start), term);
      const total = principal * (1 + rate/100);
      let installments = term;
      if (model === 'DAILY') installments = countWeekdaysInclusive(new Date(start), end);
      if (model === 'WEEKLY') installments = weeksInRange(new Date(start), end);
      const per = installments>0 ? (total/installments) : total;
      const sumEl = document.getElementById('lnSummary');
      if (sumEl) sumEl.textContent = `Total due: KES ${Number(total||0).toLocaleString('en-KE',{minimumFractionDigits:2,maximumFractionDigits:2})} â€” ${installments} ${model.toLowerCase()} installment(s) @ KES ${Number(per||0).toLocaleString('en-KE',{minimumFractionDigits:2,maximumFractionDigits:2})} each`;
    }
    ;['lnModel','lnPrincipal','lnRate','lnTerm','lnStart'].forEach(id=>{ const el=document.getElementById(id); if(el) el.addEventListener('input', updateLoanSummary); });
    if (document.getElementById('lnStart')) { document.getElementById('lnStart').value = new Date().toISOString().slice(0,10); }
    try { updateLoanSummary(); } catch(_){ }

    async function loadLoans(){
      if(!currentSacco) return;
      try{
        const res = await jget(`/u/sacco/${currentSacco}/loans`);
        const T=$('loanTbody'); T.innerHTML='';
        (res.items||[]).forEach(l=>{
          const tr=document.createElement('tr');
          tr.innerHTML =
            `<td>${l.borrower_name||''}</td><td>${(l.matatu_id||'')}</td><td>${fmtKES(l.principal_kes||0)}</td>`+
            `<td>${l.interest_rate_pct||0}</td><td>${l.term_months||0}</td><td>${l.status||''}</td>`+
            `<td class="mono">${l.id}</td>`;
          T.appendChild(tr);
        });
      }catch(e){
        $('loanTbody').innerHTML = `<tr><td colspan="7" class="err">${parseErr(e)}</td></tr>`;
      }
    }
    $('lnAdd').onclick = async ()=>{
      if(!currentSacco) return alert('Pick a SACCO first');
      const matatuId = $('lnMatatu').value;
      if(!matatuId) return alert('Select a Matatu ï¿½ loans must be tied to the vehicle owner');
      const m = (window._matatuFull && window._matatuFull.get(matatuId)) || null;
      const ownerName = (m && (m.owner_name||'')) || '';
      $('lnBorrower').value = ownerName; // enforce borrower = owner
      const body = {
        sacco_id: currentSacco,
        borrower_name: ownerName,
        matatu_id:     matatuId,
        principal_kes: Number($('lnPrincipal').value||0),
        interest_rate_pct: Number($('lnRate').value||0),
        term_months:   Number($('lnTerm').value||0)
      };
      try{
        await parse(await fetch(`/u/sacco/${currentSacco}/loans`,{
          method:'POST',
          headers:{ 'Content-Type':'application/json', Accept:'application/json' },
          body: JSON.stringify(body)
        }));
        $('lnBorrower').value = $('lnPrincipal').value = $('lnRate').value = $('lnTerm').value = '';
        $('lnMatatu').value = '';
        await loadLoans();
        alert('Loan created');
      }catch(e){ alert(e.message); }
    };

    // Events
    $('saccoSelect').onchange = async ()=>{
      currentSacco = $('saccoSelect').value || null;
      updateHeadlineFor(currentSacco);
      await Promise.all([ loadMatatus(), loadTxAndTotals(), loadStaff(), loadLoans() ]);
    };
    $('applyRange').onclick = ()=> { loadTxAndTotals(); loadStaffCollections(); };
    $('matatuSearch').oninput = ()=> { clearTimeout(window._mtT); window._mtT = setTimeout(loadMatatus, 200); };
    $('reloadMatatus').onclick = loadMatatus;
    $('txStatus').onchange = loadTxAndTotals;
    $('reloadTx').onclick = ()=> { loadTxAndTotals(); loadStaffCollections(); };
    $('sc_refresh').onclick = loadStaffCollections;

    // Export CSV
    $('exportTx').onclick = ()=>{
      const tbody=document.getElementById('txTbody');
      const table=tbody.closest('table');
      const rows=[...table.querySelectorAll('tr')];
      const csv=rows.map(r=>[...r.querySelectorAll('th,td')].map(c=>`"${(c.innerText||'').replace(/"/g,'""')}"`).join(',')).join('\n');
      const a=document.createElement('a');
      a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
      a.download='transactions.csv';
      a.click();
    };

    // Init
    (async function init(){
      try{
        
        await loadSaccos();
        await Promise.all([ loadMatatus(), loadTxAndTotals(), loadStaffCollections(), loadStaff(), loadLoans() ]);
      }catch(e){
        $('statusMsg').textContent = e.message;
        console.error(e);
        alert('Load error: '+e.message);
      }
    })();
  })();
  </script>

</body>
</html>


