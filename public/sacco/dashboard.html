<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>TekeTeke ù SACCO Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <!-- Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --brand:#1976d2; --brand-700:#135ba1;
      --bg:#f6f7fb; --panel:#fff; --text:#0b0f19; --muted:#6b7280; --border:#e5e7eb;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,Segoe UI,Arial;background:var(--bg);color:var(--text);margin:0;padding:20px}
    h2{color:var(--brand);margin:0 0 12px}
    .bar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
    select,input,button{padding:10px;border:1px solid var(--border);border-radius:8px}
    button{background:var(--brand);color:#fff;border:none;cursor:pointer}
    button.ghost{background:#fff;color:var(--brand)}
    .tabs{display:flex;gap:8px;margin:8px 0 16px;flex-wrap:wrap}
    .tab{padding:10px 14px;background:var(--brand);color:#fff;border-radius:8px;cursor:pointer}
    .tab.active{background:var(--brand-700)}
    .panel{display:none;background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
    .panel.active{display:block}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .right{margin-left:auto}
    .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
    .card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px}
    .k{color:var(--muted);font-size:12px}
    .v{font-weight:700;font-size:20px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:10px;border:1px solid var(--border);text-align:left}
    th{background:var(--brand);color:#fff}
    .mono{font-family:ui-monospace,Consolas,monospace}
    .note{color:var(--muted); font-size:12px}
    a.back{display:inline-block;margin-bottom:10px}
    .form-grid{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:8px;margin:10px 0}
    .form-grid-4{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px;margin:10px 0}
    .w-2{grid-column:span 2}
  </style>
</head>
<body>

  <a class="back" href="/public/auth/role-select.html">?Back</a>
  <h2>SACCO Dashboard</h2>

  <div class="bar">
    <label>SACCO <select id="saccoSelect"></select></label>
    <label>From <input id="fromDate" type="date"></label>
    <label>To <input id="toDate" type="date"></label>
    <button id="applyRange">Apply</button>
    <span class="right k" id="statusMsg"></span>
  </div>

  <div class="tabs" role="tablist" aria-label="Sections">
    <div class="tab active" data-panel="p_matatus" role="tab" aria-selected="true">Matatus</div>
    <div class="tab" data-panel="p_summary" role="tab" aria-selected="false">Collections</div>
    <div class="tab" data-panel="p_tx" role="tab" aria-selected="false">Transactions</div>
    <div class="tab" data-panel="p_ops" role="tab" aria-selected="false">Payments (STK)</div>
    <div class="tab" data-panel="p_staff" role="tab" aria-selected="false">Staff</div>
    <div class="tab" data-panel="p_loans" role="tab" aria-selected="false">Loans</div>
  </div>

  <!-- Matatus -->
  <section id="p_matatus" class="panel active">
    <div class="row">
      <input id="matatuSearch" placeholder="Search plateà"/>
      <button class="ghost" id="reloadMatatus">Reload</button>
      <span class="right k" id="matatuCount"></span>
    </div>
    <table>
      <thead>
        <tr><th>Plate</th><th>Owner</th><th>Phone</th><th>Type</th><th>TLB</th><th>Till</th><th>ID</th></tr>
      </thead>
      <tbody id="matatuTbody"></tbody>
    </table>
  </section>

  <!-- Collections summary -->
  <section id="p_summary" class="panel">
    <div class="grid">
      <div class="card"><div class="k">FARE (gross)</div><div class="v" id="sum_fare">0</div></div>
      <div class="card"><div class="k">SAVINGS</div><div class="v" id="sum_savings">0</div></div>
      <div class="card"><div class="k">LOAN REPAY</div><div class="v" id="sum_loan">0</div></div>
      <div class="card"><div class="k">SACCO FEE</div><div class="v" id="sum_sacco">0</div></div>
    </div>
    <div class="card" style="margin-top:16px">
      <canvas id="summaryChart" height="120"></canvas>
      <p class="note">Chart shows SACCO_FEE by day (computed client-side for the selected range).</p>
    </div>
  </section>

  <!-- Transactions -->
  <section id="p_tx" class="panel">
    <div class="row">
      <label>Status
        <select id="txStatus">
          <option value="">All</option>
          <option value="SUCCESS">SUCCESS</option>
          <option value="PENDING">PENDING</option>
          <option value="FAILED">FAILED</option>
          <option value="TIMEOUT">TIMEOUT</option>
        </select>
      </label>
      <button class="ghost" id="reloadTx">Reload</button>
      <button id="exportTx">Export CSV</button>
      <span class="right k" id="txCount"></span>
    </div>
    <table>
      <thead>
        <tr><th>Time</th><th>Matatu</th><th>MSISDN</th><th>Fare</th><th>Service Fee</th><th>Status</th><th>Kind</th><th>ID</th></tr>
      </thead>
      <tbody id="txTbody"></tbody>
    </table>
  </section>

  <!-- Payments (STK only) -->
  <section id="p_ops" class="panel">
    <div class="card">
      <h3>Send STK Prompt</h3>
      <div class="row">
        <input id="stkCode" placeholder="*001*1101#"/>
        <input id="stkAmt" type="number" placeholder="amount"/>
        <input id="stkPhone" placeholder="07XXXXXXXX"/>
        <button id="stkGo">Send</button>
      </div>
      <pre id="stkOut" class="mono">{}</pre>
      <p class="note">USSD assignment is disabled here. Only system admin can assign USSD codes.</p>
    </div>
  </section>

  <!-- Staff -->
  <section id="p_staff" class="panel">
    <div class="card">
      <h3>Register Staff</h3>
      <div class="form-grid-4">
        <input id="stName" placeholder="Full name"/>
        <input id="stPhone" placeholder="07XXXXXXXX"/>
        <input id="stEmail" placeholder="email@example.com"/>
        <select id="stRole">
          <option value="SACCO_STAFF">SACCO_STAFF</option>
          <option value="SACCO_ADMIN">SACCO_ADMIN</option>
        </select>
      </div>
      <button id="stAdd">Add Staff</button>
    </div>
    <div class="card" style="margin-top:12px">
      <h3>Current Staff</h3>
      <table>
        <thead><tr><th>Name</th><th>Phone</th><th>Email</th><th>Role</th><th>ID</th></tr></thead>
        <tbody id="staffTbody"></tbody>
      </table>
    </div>
  </section>

  <!-- Loans -->
  <section id="p_loans" class="panel">
    <div class="card">
      <h3>Create Loan</h3>
      <div class="form-grid">
        <input id="lnBorrower" placeholder="Borrower name"/>
        <select id="lnMatatu" class="w-2"><option value="">ù optional ù Matatu</option></select>
        <input id="lnPrincipal" type="number" placeholder="Principal (KES)"/>
        <input id="lnRate" type="number" placeholder="Interest % p.a"/>
        <input id="lnTerm" type="number" placeholder="Term (months)"/>
      </div>
      <button id="lnAdd">Create Loan</button>
    </div>
    <div class="card" style="margin-top:12px">
      <h3>Loans</h3>
      <table>
        <thead><tr><th>Borrower</th><th>Matatu</th><th>Principal</th><th>Rate %</th><th>Term (m)</th><th>Status</th><th>ID</th></tr></thead>
        <tbody id="loanTbody"></tbody>
      </table>
    </div>
  </section>

  <script>
  (function(){
    const $ = id => document.getElementById(id);
    const isoDate = d => new Date(d).toISOString().slice(0,10);
    const today = isoDate(new Date());
    const bearer = () => localStorage.getItem('auth_token') || '';
    const adminTok = () => '';
    const fmtKES = n => Number(n||0).toLocaleString('en-KE',{minimumFractionDigits:2,maximumFractionDigits:2});

    async function parse(res){
      const t = await res.text();
      let j = {};
      try { j = t ? JSON.parse(t) : {}; } catch { j = { error: t || res.statusText }; }
      if (!res.ok) throw new Error(j.error||j.message||res.statusText||'Request failed');
      return j;
    }
    async function jget(path){
      const headers = {};
      const tok = bearer();
      if (tok) headers.Authorization = 'Bearer ' + tok;
      return parse(await fetch(path,{headers}));
    }
    async function jadmin(method, path, body){
      // Admin-only endpoints retained for staff/loans. No USSD calls here anymore.
      const headers = {'Content-Type':'application/json'};
      const res = await fetch(path,{method,headers,body: body? JSON.stringify(body): undefined});
      return parse(res);
    }

    // Tabs (delegated, with aria)
    (function setupTabs(){
      const tabsWrap = document.querySelector('.tabs');
      if(!tabsWrap) return;
      tabsWrap.addEventListener('click', (e)=>{
        const tab = e.target.closest('.tab'); if(!tab) return;
        const id = tab.getAttribute('data-panel');
        document.querySelectorAll('.tab').forEach(t=>{
          const sel = t===tab;
          t.classList.toggle('active', sel);
          t.setAttribute('aria-selected', sel ? 'true' : 'false');
        });
        document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
        const panel = document.getElementById(id);
        if(panel){ panel.classList.add('active'); panel.scrollTop=0; }
      });
    })();

    // Date defaults
    $('toDate').value = today;
    $('fromDate').value = isoDate(new Date(Date.now() - 6*24*3600*1000));

    let currentSacco = null;
    let matatuMap = new Map();

    async function loadSaccos(){
      const sel = $('saccoSelect');
      sel.innerHTML = '<option value="">ù choose ù</option>';
      const res = await jget('/u/my-saccos');
      const items = res.items || [];
      items.forEach(s=>{
        const o=document.createElement('option');
        o.value=s.sacco_id;
        o.textContent=s.name||s.sacco_id;
        sel.appendChild(o);
      });
      $('statusMsg').textContent = `${items.length} SACCO(s)`;
      if(items.length){
        sel.value = items[0].sacco_id;
        currentSacco = sel.value;
      }
    }

    async function loadMatatus(){
      if(!currentSacco) return;
      const data = await jget(`/u/sacco/${currentSacco}/matatus`);
      matatuMap = new Map((data.items||[]).map(m=>[m.id,m.number_plate||'']));
      const q = $('matatuSearch').value.trim().toUpperCase();
      const rows = (data.items||[]).filter(m => !q || (m.number_plate||'').toUpperCase().includes(q));
      const T = $('matatuTbody'); T.innerHTML = '';
      rows.forEach(m=>{
        const tr = document.createElement('tr');
        tr.innerHTML =
          `<td>${m.number_plate||''}</td><td>${m.owner_name||''}</td><td>${m.owner_phone||''}</td>`+
          `<td>${m.vehicle_type||''}</td><td>${m.tlb_number||''}</td><td>${m.till_number||''}</td>`+
          `<td class="mono">${m.id}</td>`;
        T.appendChild(tr);
      });
      $('matatuCount').textContent = `${rows.length} matatu(s)`;

      // loans matatu select
      const sel = $('lnMatatu');
      sel.innerHTML = '<option value="">ù optional ù Matatu</option>';
      (data.items||[]).forEach(m=>{
        const o=document.createElement('option');
        o.value=m.id; o.textContent=m.number_plate;
        sel.appendChild(o);
      });
    }

    function withinRange(ts,fromIso,toIso){
      const d = isoDate(ts);
      return d>=fromIso && d<=toIso;
    }
    function groupByDay(items){
      const map = new Map();
      items.forEach(tx=>{
        const day = isoDate(tx.created_at);
        map.set(day,(map.get(day)||0) + Number(tx.kind==='SACCO_FEE' ? (tx.fare_amount_kes||0) : 0));
      });
      const labels=[]; const values=[];
      const start=new Date($('fromDate').value+'T00:00:00');
      const end=new Date($('toDate').value+'T00:00:00');
      for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)){
        const key=isoDate(d);
        labels.push(key);
        values.push(map.get(key)||0);
      }
      return {labels, values};
    }

    function renderChart(id,label,labels,values){
      const ctx=document.getElementById(id);
      if(ctx._inst) ctx._inst.destroy();
      ctx._inst=new Chart(ctx,{
        type:'line',
        data:{ labels, datasets:[{ label, data:values, borderColor:'#1976d2',BackgroundColor:'transparent', tension:.25 }] },
        options:{ responsive:true, scales:{ y:{ beginAtZero:true } } }
      });
    }

    async function loadTxAndTotals(){
      if(!currentSacco) return;
      const res = await jget(`/u/sacco/${currentSacco}/transactions?limit=1000`);
      const fromIso=$('fromDate').value, toIso=$('toDate').value, status=$('txStatus').value;
      const all=(res.items||[]).filter(tx=>withinRange(tx.created_at,fromIso,toIso));
      const items = status ? all.filter(tx=>(tx.status||'')===status) : all;

      const T=$('txTbody'); T.innerHTML='';
      items.forEach(tx=>{
        const tr=document.createElement('tr');
        tr.innerHTML =
          `<td>${new Date(tx.created_at).toLocaleString()}</td><td class="mono">${tx.matatu_id||''}</td>`+
          `<td class="mono">${tx.passenger_msisdn||''}</td><td>${fmtKES(tx.fare_amount_kes)}</td>`+
          `<td>${fmtKES(tx.service_fee_kes)}</td><td>${tx.status||''}</td><td>${tx.kind||''}</td>`+
          `<td class="mono">${tx.id}</td>`;
        T.appendChild(tr);
      });
      $('txCount').textContent = `${items.length} row(s)`;

      const sum = k => all.filter(t=>t.kind===k).reduce((a,b)=>a+Number(b.fare_amount_kes||0),0);
      $('sum_fare').textContent   = fmtKES(sum('FARE'));
      $('sum_savings').textContent= fmtKES(sum('SAVINGS'));
      $('sum_loan').textContent   = fmtKES(sum('LOAN_REPAY'));
      $('sum_sacco').textContent  = fmtKES(sum('SACCO_FEE'));

      const g = groupByDay(all);
      renderChart('summaryChart','SACCO Fee (KES)',g.labels,g.values);
    }

    // STK
    $('stkGo').onclick = async ()=>{
      try{
        const body = {
          code:  $('stkCode').value.trim(),
          amount:Number($('stkAmt').value||0),
          phone: $('stkPhone').value.trim()
        };
        const r = await fetch('/api/pay/stk',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
        $('stkOut').textContent = await r.text();
      }catch(e){ $('stkOut').textContent = e.message; }
    };

    // Staff
    async function loadStaff(){
      if(!currentSacco) return;
      const res = await jadmin('GET', `/api/admin/staff?sacco_id=${encodeURIComponent(currentSacco)}`);
      const T=$('staffTbody'); T.innerHTML='';
      (res.items||[]).forEach(s=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${s.name||''}</td><td>${s.phone||''}</td><td>${s.email||''}</td><td>${s.role||''}</td><td class="mono">${s.id}</td>`;
        T.appendChild(tr);
      });
    }
    $('stAdd').onclick = async ()=>{
      if(!currentSacco) return alert('Pick a SACCO first');
      const body = {
        sacco_id: currentSacco,
        name:  $('stName').value.trim(),
        phone: $('stPhone').value.trim(),
        email: $('stEmail').value.trim(),
        role:  $('stRole').value
      };
      try{
        await jadmin('POST','/api/admin/staff', body);
        $('stName').value = $('stPhone').value = $('stEmail').value = '';
        await loadStaff();
        alert('Staff added');
      }catch(e){ alert(e.message); }
    };

    // Loans
    async function loadLoans(){
      if(!currentSacco) return;
      const res = await jadmin('GET', `/api/admin/loans?sacco_id=${encodeURIComponent(currentSacco)}`);
      const T=$('loanTbody'); T.innerHTML='';
      (res.items||[]).forEach(l=>{
        const tr=document.createElement('tr');
        tr.innerHTML =
          `<td>${l.borrower_name||''}</td><td>${(l.matatu_id||'')}</td><td>${fmtKES(l.principal_kes||0)}</td>`+
          `<td>${l.interest_rate_pct||0}</td><td>${l.term_months||0}</td><td>${l.status||''}</td>`+
          `<td class="mono">${l.id}</td>`;
        T.appendChild(tr);
      });
    }
    $('lnAdd').onclick = async ()=>{
      if(!currentSacco) return alert('Pick a SACCO first');
      const body = {
        sacco_id: currentSacco,
        borrower_name: $('lnBorrower').value.trim(),
        matatu_id:     $('lnMatatu').value || null,
        principal_kes: Number($('lnPrincipal').value||0),
        interest_rate_pct: Number($('lnRate').value||0),
        term_months:   Number($('lnTerm').value||0)
      };
      try{
        await jadmin('POST','/api/admin/loans', body);
        $('lnBorrower').value = $('lnPrincipal').value = $('lnRate').value = $('lnTerm').value = '';
        $('lnMatatu').value = '';
        await loadLoans();
        alert('Loan created');
      }catch(e){ alert(e.message); }
    };

    // Events
    $('saccoSelect').onchange = async ()=>{
      currentSacco = $('saccoSelect').value || null;
      await Promise.all([ loadMatatus(), loadTxAndTotals(), loadStaff(), loadLoans() ]);
    };
    $('applyRange').onclick = ()=> loadTxAndTotals();
    $('matatuSearch').oninput = ()=> { clearTimeout(window._mtT); window._mtT = setTimeout(loadMatatus, 200); };
    $('reloadMatatus').onclick = loadMatatus;
    $('txStatus').onchange = loadTxAndTotals;
    $('reloadTx').onclick = loadTxAndTotals;

    // Export CSV
    $('exportTx').onclick = ()=>{
      const tbody=document.getElementById('txTbody');
      const table=tbody.closest('table');
      const rows=[...table.querySelectorAll('tr')];
      const csv=rows.map(r=>[...r.querySelectorAll('th,td')].map(c=>`"${(c.innerText||'').replace(/"/g,'""')}"`).join(',')).join('\n');
      const a=document.createElement('a');
      a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
      a.download='transactions.csv';
      a.click();
    };

    // Init
    (async function init(){
      try{
        
        await loadSaccos();
        await Promise.all([ loadMatatus(), loadTxAndTotals(), loadStaff(), loadLoans() ]);
      }catch(e){
        $('statusMsg').textContent = e.message;
        console.error(e);
        alert('Load error: '+e.message);
      }
    })();
  })();
  </script>

  <!-- Auth pill (needs app-config/api) -->
  <script src="/public/js/app-config.js"></script>
  <script src="/public/js/api.js"></script>
  <script>
  (async()=>{
    try{
      const bar=document.createElement('div');
      bar.style.cssText='position:fixed;top:10px;left:10px;z-index:10;display:flex;gap:8px;align-items:center';
      const pill=document.createElement('span');
      pill.id='auth_state';
      pill.style.cssText='background:#eef2ff;color:#3730a3;border:1px solid #c7d2fe;padding:4px 10px;border-radius:999px;font-size:12px;max-width:40vw;overflow:hidden;text-overflow:ellipsis;white-space:nowrap';
      pill.textContent='Checking sign-inà';
      const btn=document.createElement('button');
      btn.textContent='Logout';
      btn.style.cssText='padding:6px 10px;border-radius:6px;border:1px solid #cfe3ff;background:#0b5cab;color:#fff;cursor:pointer';
      bar.appendChild(pill); bar.appendChild(btn);
      document.body.appendChild(bar);

      if(window.TT && window.TT.getSupabase){
        const supa=await window.TT.getSupabase();
        const {data:{session}}=await supa.auth.getSession();
        pill.textContent = session?.user?.email ? ('Signed in as '+session.user.email) : 'Not signed in';
        btn.addEventListener('click', async ()=>{
          try{ await supa.auth.signOut(); }catch(_){}
          localStorage.removeItem('auth_token');
          localStorage.removeItem('tt_root_token');
          localStorage.removeItem('tt_admin_token');
          location.reload();
        }, {passive:true});
      }
    }catch(_){}
  })();
  </script>
</body>
</html>

