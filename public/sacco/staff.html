<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TekeTeke - SACCO Staff</title>

  <link rel="stylesheet" href="/public/css/dashboard-theme.css"/>
  <script src="/public/js/app-config.js"></script>
  <script src="/public/js/api.js"></script>
  <script src="/public/js/role-guard.js"></script>
</head>
<body>

<div class="hero-card">
  <div class="hero-stack">
    <p class="eyebrow">SACCO Staff</p>
    <div class="hello" id="welcomeLine">Hello!</div>
    <div class="timestamp" id="dateTimeLine">--</div>
    <div class="muted" id="saccoNameLine" style="margin-top:4px;font-size:13px;">SACCO: --</div>
  </div>
  <div class="hero-actions">
    <span id="auth_state" class="pill">Checking sign-in...</span>
    <button id="logoutBtn" class="btn bad">Logout</button>
  </div>
</div>

<div class="card" style="margin-top:12px;display:flex;align-items:flex-start;gap:14px;flex-wrap:wrap">
  <div style="flex:1 1 220px">
    <h3 style="margin:0 0 6px">Android app (APK)</h3>
    <p class="muted" style="margin:0 0 6px">
      Install the SACCO Staff PWA wrapper on Android and unlock with the staff PIN.
    </p>
    <p class="muted" style="margin:0">
      Current PIN: <strong>1234</strong> (change via <code>sacco-staff-pwa/.env</code> → <code>VITE_STAFF_PIN</code> then rebuild).
    </p>
  </div>
  <div style="display:flex;align-items:center;gap:8px">
    <a class="btn primary" href="/downloads/sacco-staff.apk" download target="_blank" rel="noopener">
      Download SACCO Staff APK
    </a>
    <span class="muted" style="font-size:12px">If this 404s, upload the latest APK to <code>public/downloads/sacco-staff.apk</code>.</span>
  </div>
</div>

<h2>SACCO Staff - Cash Desk</h2>

<!-- Top filters (hidden: SACCO select/search/reload now handled automatically) -->
<div class="card stack">
  <div class="row" style="display:none">
    <label>SACCO <select id="sacco"></select></label>
    <label>Search plate <input id="search" placeholder="KDA123A"/></label>
    <button id="reload" class="ghost">Reload</button>
    <span class="right muted" id="stat"></span>
  </div>
</div>

<!-- Tabs -->
<div class="tabs" role="tablist" aria-label="Collections">
  <div class="tab active" data-panel="p_daily" role="tab" aria-selected="true">Daily Fee</div>
  <div class="tab" data-panel="p_loans" role="tab">Loans</div>
  <div class="tab" data-panel="p_savings" role="tab">Savings</div>
  <!-- Note: removed extra link buttons per request -->
  </div>

<!-- Daily Fee Panel -->
<section id="p_daily" class="panel active" aria-labelledby="tab_daily">
  <div class="section-title">
    <h3 style="margin:0">Daily Fee</h3>
    <span class="muted" id="df_counts"></span>
    <span class="muted" id="df_total" style="margin-left:12px;"></span>
  </div>
  <div class="card">
    <h4>Paid Today</h4>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Plate</th><th>Amount</th><th>Time</th></tr></thead>
        <tbody id="df_paid"></tbody>
      </table>
    </div>
  </div>
  <div class="card" style="margin-top:10px"><h4>Manual Collection</h4>
    <div class="row">
      <label>Matatu <select id="df_matatu"></select></label>
      <input id="df_amount" type="number" placeholder="Amount (KES)" class="amount"/>
      <input id="df_name" placeholder="Payer name"/>
      <input id="df_phone" placeholder="07XXXXXXXX"/>
      <button id="df_collect">Collect</button>
    </div>
  </div>
  <div class="card" style="margin-top:10px">
    <h4>Not Paid (to collect)</h4>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Plate</th><th class="mono">Matatu ID</th><th>Amount</th><th></th></tr></thead>
        <tbody id="df_due"></tbody>
      </table>
    </div>
  </div>
  </section>

<!-- Loans Panel (single table) -->
<section id="p_loans" class="panel" aria-labelledby="tab_loans">
  <div class="section-title">
    <h3 style="margin:0">Loan Table (Due Today)</h3>
    <span class="muted" id="ln_counts"></span>
    <span class="muted" id="ln_total" style="margin-left:12px;"></span>
  </div>
  <div class="card">
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Matatu</th>
            <th>Loan Amount</th>
            <th>Loan Balance</th>
            <th>To Pay Today</th>
            <th>Amount</th>
            <th>Collect</th>
          </tr>
        </thead>
        <tbody id="ln_table"></tbody>
      </table>
    </div>
  </div>
</section>

<!-- Savings Panel -->
<section id="p_savings" class="panel" aria-labelledby="tab_savings">
  <div class="section-title">
    <h3 style="margin:0">Savings</h3>
    <span class="muted" id="sv_counts"></span>
    <span class="muted" id="sv_total" style="margin-left:12px;"></span>
  </div>
  <div class="card">
    <h4>Paid Today</h4>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Plate</th><th>Amount</th><th>Time</th></tr></thead>
        <tbody id="sv_paid"></tbody>
      </table>
    </div>
  </div>
  <div class="card" style="margin-top:10px"><h4>Manual Collection</h4>
    <div class="row">
      <label>Matatu <select id="sv_matatu"></select></label>
      <input id="sv_amount" type="number" placeholder="Amount (KES)" class="amount"/>
      <input id="sv_name" placeholder="Payer name"/>
      <input id="sv_phone" placeholder="07XXXXXXXX"/>
      <button id="sv_collect">Collect</button>
    </div>
  </div>
  <div class="card" style="margin-top:10px">
    <h4>Not Paid (to collect)</h4>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Plate</th><th class="mono">Matatu ID</th><th>Amount</th><th></th></tr></thead>
        <tbody id="sv_due"></tbody>
      </table>
    </div>
  </div>
</section>

<div class="card" style="margin:24px auto;max-width:480px">
  <h3 style="margin:0 0 4px">Device PIN (offline lock)</h3>
  <p class="muted" style="margin:0 0 8px">
    Protect this device with a 4 digit PIN. The PIN is stored only on this device so you can still open the app while offline.
  </p>
  <div class="row" style="align-items:center;gap:8px;flex-wrap:wrap">
    <input id="pin_new" type="password" inputmode="numeric" pattern="[0-9]*" maxlength="4" placeholder="New PIN" style="max-width:90px"/>
    <input id="pin_confirm" type="password" inputmode="numeric" pattern="[0-9]*" maxlength="4" placeholder="Confirm PIN" style="max-width:120px"/>
    <button id="pin_save">Save PIN</button>
    <button id="pin_clear" class="ghost">Remove PIN</button>
  </div>
  <div id="pin_msg" class="muted" style="margin-top:6px;font-size:13px;"></div>
</div>

<div id="toast" role="status" aria-live="polite"></div>

<script>
(async function(){
  const PIN_STORAGE_KEY = 'tt_sacco_device_pin_v1';
  const PIN_SESSION_KEY = 'tt_sacco_device_pin_ok';

  async function hashPin(pin){
    try{
      if (window.crypto?.subtle && window.TextEncoder){
        const data = new TextEncoder().encode(pin);
        const buf = await window.crypto.subtle.digest('SHA-256', data);
        return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
      }
    }catch(_){}
    return 'pin:' + pin;
  }

  async function ensurePinUnlocked(){
    const stored = localStorage.getItem(PIN_STORAGE_KEY);
    if (!stored) return;
    const ok = sessionStorage.getItem(PIN_SESSION_KEY);
    if (ok && ok === stored) return;

    return new Promise((resolve)=>{
      const overlay = document.createElement('div');
      overlay.id = 'pinGate';
      overlay.style.position = 'fixed';
      overlay.style.inset = '0';
      overlay.style.zIndex = '9999';
      overlay.style.background = 'rgba(15,23,42,0.8)';
      overlay.style.display = 'flex';
      overlay.style.alignItems = 'center';
      overlay.style.justifyContent = 'center';

      overlay.innerHTML = `
        <div style="background:#ffffff;border-radius:16px;padding:20px;max-width:320px;width:90%;box-shadow:0 18px 40px rgba(0,0,0,.35);text-align:center">
          <h3 style="margin:0 0 8px;font-size:18px;">Enter device PIN</h3>
          <p style="margin:0 0 12px;font-size:13px;color:#6b7280;">This 4 digit PIN protects this device even when you are offline.</p>
          <input id="pinGateInput" type="password" inputmode="numeric" pattern="[0-9]*" maxlength="4" style="letter-spacing:0.4em;text-align:center;font-size:20px;padding:10px 6px;border-radius:10px;border:1px solid #e5e7eb;width:160px;" autofocus />
          <div id="pinGateMsg" style="margin-top:8px;font-size:13px;color:#b91c1c;min-height:18px;"></div>
          <button id="pinGateUnlock" style="margin-top:10px;padding:8px 14px;border-radius:999px;border:none;background:#1976d2;color:#fff;font-weight:700;cursor:pointer;">Unlock</button>
        </div>
      `;

      document.body.appendChild(overlay);
      const input = overlay.querySelector('#pinGateInput');
      const msgEl = overlay.querySelector('#pinGateMsg');
      const btn = overlay.querySelector('#pinGateUnlock');

      function setMsg(t){ if (msgEl) msgEl.textContent = t || ''; }

      async function tryUnlock(){
        const val = (input.value || '').trim();
        if (!/^[0-9]{4}$/.test(val)){
          setMsg('PIN must be 4 digits');
          return;
        }
        const hash = await hashPin(val);
        if (hash === stored){
          sessionStorage.setItem(PIN_SESSION_KEY, stored);
          document.body.removeChild(overlay);
          resolve();
        } else {
          setMsg('Incorrect PIN');
          input.value = '';
          input.focus();
        }
      }

      if (btn) btn.addEventListener('click', (e)=>{ e.preventDefault(); tryUnlock(); });
      if (input) input.addEventListener('keydown', (e)=>{ if(e.key === 'Enter'){ e.preventDefault(); tryUnlock(); } });
      setTimeout(()=>{ try{ input && input.focus(); }catch(_){ } }, 0);
    });
  }

  function initPinSettings(){
    const newEl = document.getElementById('pin_new');
    const confirmEl = document.getElementById('pin_confirm');
    const msgEl = document.getElementById('pin_msg');
    const saveBtn = document.getElementById('pin_save');
    const clearBtn = document.getElementById('pin_clear');
    if (!newEl || !confirmEl || !msgEl || !saveBtn || !clearBtn) return;

    function setMsg(text, isError){
      msgEl.textContent = text || '';
      msgEl.style.color = isError ? '#b91c1c' : '#6b7280';
    }

    if (localStorage.getItem(PIN_STORAGE_KEY)){
      setMsg('PIN is enabled on this device.', false);
    }

    saveBtn.onclick = async ()=>{
      const a = (newEl.value || '').trim();
      const b = (confirmEl.value || '').trim();
      if (!/^[0-9]{4}$/.test(a)){
        setMsg('PIN must be exactly 4 digits.', true);
        return;
      }
      if (a !== b){
        setMsg('PIN values do not match.', true);
        return;
      }
      const hash = await hashPin(a);
      localStorage.setItem(PIN_STORAGE_KEY, hash);
      sessionStorage.removeItem(PIN_SESSION_KEY);
      newEl.value = '';
      confirmEl.value = '';
      setMsg('PIN saved for this device.', false);
    };

    clearBtn.onclick = ()=>{
      localStorage.removeItem(PIN_STORAGE_KEY);
      sessionStorage.removeItem(PIN_SESSION_KEY);
      newEl.value = '';
      confirmEl.value = '';
      setMsg('PIN removed for this device.', false);
    };
  }

  const loginForSaccoStaff = '/public/auth/login.html?next=' + encodeURIComponent('/public/sacco/staff.html');
  try{
    await requireRole('SACCO_STAFF', {
      statusEl: 'auth_state',
      roleLabel: 'SACCO Staff',
      loginUrl: loginForSaccoStaff,
      onMismatch: loginForSaccoStaff
    });
  }catch(_){ return; }
  await ensurePinUnlocked();
  const $ = id => document.getElementById(id);
  const todayIso = d => new Date(d).toISOString().slice(0,10);
  const isToday = (ts) => todayIso(ts) === todayIso(new Date());
  const fmtKES = n => Number(n||0).toLocaleString('en-KE',{minimumFractionDigits:2,maximumFractionDigits:2});
  const toast = (msg)=>{ const t=$('toast'); t.textContent=msg; t.classList.add('show'); clearTimeout(window._t); window._t=setTimeout(()=>t.classList.remove('show'),1800); };

  async function parse(r){ const t=await r.text(); let j={}; try{ j=t?JSON.parse(t):{} }catch{ j={error:t||r.statusText} } if(!r.ok) throw new Error(j.error||j.message||r.statusText); return j; }
  async function g(p){ return parse(await fetch(p)); }
  async function post(p,b){ return parse(await fetch(p,{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(b)})); }

  let SACCO_ID=null; let MATATUS=[]; let MAT_BY_ID=new Map();
  let DAILY_FEE_BY_TYPE = new Map();

  async function loadSaccos(){
    const res=await g('/u/my-saccos');
    const sel=$('sacco'); sel.innerHTML='';
    const items = res.items||[];
    items.forEach(s=>{ const o=document.createElement('option'); o.value=s.sacco_id; o.textContent=s.name||s.sacco_id; sel.appendChild(o); });
    if(items.length){
      sel.value=items[0].sacco_id;
      SACCO_ID = sel.value;
      const line = document.getElementById('saccoNameLine');
      if (line){
        const name = items[0].name || items[0].sacco_id || '';
        line.textContent = name ? `SACCO: ${name}` : 'SACCO: --';
      }
    }
  }
  async function loadMatatus(){
    if(!SACCO_ID) return;
    const res=await g(`/u/sacco/${SACCO_ID}/matatus`);
    MATATUS = res.items||[];
    MAT_BY_ID = new Map(MATATUS.map(m=>[m.id,m]));
    $('stat').textContent = `${MATATUS.length} matatu(s)`;
    function fillSel(id){ const el=document.getElementById(id); if(!el) return; el.innerHTML=''; (MATATUS||[]).forEach(m=>{ const o=document.createElement('option'); o.value=m.id; o.textContent=m.number_plate; el.appendChild(o); }); }
    fillSel('df_matatu'); fillSel('sv_matatu');
  }

  async function loadDailyFeeConfig(){
    DAILY_FEE_BY_TYPE = new Map();
    if (!SACCO_ID) return;
    try{
      const res = await g(`/u/sacco/${SACCO_ID}/daily-fee-rates`);
      const items = res.items || [];
      DAILY_FEE_BY_TYPE = new Map(items.map(r=>[(r.vehicle_type||'').toString().toUpperCase(), Number(r.daily_fee_kes||0)]));
    }catch(_){ DAILY_FEE_BY_TYPE = new Map(); }
  }

  async function quickCollect(kind, matatu_id, amount){
    const body = { sacco_id:SACCO_ID, matatu_id, kind, amount:Number(amount||0), payer_name:'Cash desk', payer_phone:'' };
    await post('/api/staff/cash', body);
    toast('Recorded');
    await renderAll();
  }

  function renderPaidList(tbodyId, list){
    const T=$(tbodyId); if(!T) return; T.innerHTML='';
    list.sort((a,b)=> new Date(b.created_at)-new Date(a.created_at)).forEach(tx=>{
      const m = MAT_BY_ID.get(tx.matatu_id) || {}; const plate = m.number_plate || tx.matatu_id || '';
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${plate}</td><td>${fmtKES(tx.fare_amount_kes)}</td><td>${new Date(tx.created_at).toLocaleTimeString()}</td>`;
      T.appendChild(tr);
    });
  }
  function dailyFeeForMatatu(m){
    if (!m) return 0;
    const vt = (m.vehicle_type||'').toString().toUpperCase();
    const v = DAILY_FEE_BY_TYPE.get(vt);
    return Number.isFinite(v) && v>0 ? v : 0;
  }

  function renderDueList(tbodyId, paidSet, kind){
    const T=$(tbodyId); if(!T) return; T.innerHTML='';
    const q = ($('search').value||'').trim().toUpperCase();
    const due = MATATUS.filter(m => (!q || (m.number_plate||'').toUpperCase().includes(q)) && !paidSet.has(m.id));
    due.forEach(m=>{
      const tr=document.createElement('tr'); const amtId = `${tbodyId}_amt_${m.id}`;
      const autoAmt = kind==='DAILY_FEE' ? dailyFeeForMatatu(m) : 0;
      tr.innerHTML = `<td>${m.number_plate||''}</td><td class='mono'>${m.id}</td>`+
        `<td><input id='${amtId}' type='number' class='amount' placeholder='Amount'`+ (autoAmt?` value='${autoAmt}'`:'') +`/></td>`+
        `<td><button data-kind='${kind}' data-id='${m.id}'>Collect</button></td>`;
      T.appendChild(tr);
    });
    T.onclick=(e)=>{ const btn=e.target.closest('button'); if(!btn) return; const id=btn.getAttribute('data-id'); const k=btn.getAttribute('data-kind'); const v=Number((document.getElementById(`${tbodyId}_amt_${id}`)?.value)||0); if(!v) return toast('Enter amount'); btn.disabled=true; quickCollect(k,id,v).finally(()=>{ btn.disabled=false; }); };
  }

  function addMonths(d, m){ const x=new Date(d); x.setMonth(x.getMonth()+m); return x; }
  function startOfDay(d){ const x=new Date(d); x.setHours(0,0,0,0); return x; }
  function countWeekdaysInclusive(start, end){ try{ let c=0, d=startOfDay(start), e=startOfDay(end); while(d<=e){ const w=d.getDay(); if(w>=1 && w<=5) c++; d.setDate(d.getDate()+1);} return Math.max(1,c);}catch(_){ return 1; } }
  function weeksInRange(start, end){ try{ const ms = startOfDay(end).getTime() - startOfDay(start).getTime(); return Math.max(1, Math.ceil(ms/(7*24*3600*1000))); }catch(_){ return 1; } }

  async function renderAll(){
    if(!SACCO_ID) return;
    const res = await g(`/u/sacco/${SACCO_ID}/transactions?limit=1000`);
    const items = res.items||[];
    window._saccoStaffTx = items;

    const dfPaid = items.filter(tx => ['SACCO_FEE','DAILY_FEE'].includes(tx.kind) && tx.status==='SUCCESS' && isToday(tx.created_at));
    const dfSet = new Set(dfPaid.map(x=>x.matatu_id));
    renderPaidList('df_paid', dfPaid);
    renderDueList('df_due', dfSet, 'DAILY_FEE');
    $('df_counts').textContent = `${dfPaid.length} paid · ${(MATATUS.length - dfSet.size)} due`;

    // Loans: single simple table
    const lnPaid = items.filter(tx => tx.kind==='LOAN_REPAY' && tx.status==='SUCCESS' && isToday(tx.created_at));
    const paidSum = new Map(); lnPaid.forEach(t=>{ const id=t.matatu_id; paidSum.set(id,(paidSum.get(id)||0)+Number(t.fare_amount_kes||0)); });

    let loans = { items: [] };
    try{ loans = await g(`/u/sacco/${SACCO_ID}/loans`); }catch(_){ loans = { items: [] }; }
    const allLoans = (loans.items||[]);
    const LT = $('ln_table'); if (LT){ LT.innerHTML=''; }
    // All-time successful repayments for quick balance calc
    const loanRepaysAll = items.filter(tx => tx.kind==='LOAN_REPAY' && tx.status==='SUCCESS');

    const msDay = 24*3600*1000; const today = startOfDay(new Date());
    let dueCount = 0;
    allLoans.forEach(l=>{
      const m = MAT_BY_ID.get(l.matatu_id)||{}; const plate = m.number_plate || (l.matatu_id||'');
      const id = l.matatu_id || '';
      const principal = Number(l.principal_kes||0);
      const ratePct = Number(l.interest_rate_pct||0);
      const total = principal * (1 + ratePct/100);
      const model = String(l.collection_model||'MONTHLY');
      const term = Math.max(1, Number(l.term_months||1));
      const start = l.start_date ? new Date(l.start_date) : new Date();
      const end = addMonths(start, term);
      let installments = term; if (model==='DAILY') installments = countWeekdaysInclusive(start, end); else if (model==='WEEKLY') installments = weeksInRange(start, end);
      const installmentAmt = installments>0 ? (total/installments) : total;
      // Determine if today is a payable day
      let isPayDay = false;
      if (model === 'DAILY') { isPayDay = true; }
      else if (model === 'WEEKLY') {
        const days = Math.floor((today.getTime() - startOfDay(start).getTime())/msDay);
        isPayDay = (days >= 0) && (days % 7 === 0) && (today <= end);
      } else { isPayDay = false; }
      const dueToday = isPayDay ? installmentAmt : 0;
      if (isPayDay) dueCount++;
      const repaidAll = loanRepaysAll
        .filter(t => String(t.matatu_id)===String(id) && (!l.start_date || new Date(t.created_at) >= new Date(l.start_date)))
        .reduce((s,t)=> s + Number(t.fare_amount_kes||0), 0);
      const loanBalance = Math.max(0, total - repaidAll);
      const balToday = Math.max(0, dueToday - Number(paidSum.get(id)||0));
      const amtId = `ln_amt_${id}`;
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${plate}</td>`+
        `<td>${fmtKES(principal)}</td>`+
        `<td>${fmtKES(loanBalance)}</td>`+
        `<td>${fmtKES(dueToday)}</td>`+
        `<td><input id='${amtId}' type='number' class='amount' placeholder='Amount' value='${balToday.toFixed(2)}'/></td>`+
        `<td><button data-id='${id}'>Collect</button></td>`;
      LT.appendChild(tr);
    });
    LT.onclick = (e)=>{ const btn=e.target.closest('button'); if(!btn) return; const id=btn.getAttribute('data-id'); const v=Number((document.getElementById(`ln_amt_${id}`)?.value)||0); if(!v) return toast('Enter amount'); btn.disabled=true; quickCollect('LOAN_REPAY', id, v).finally(()=>{ btn.disabled=false; }); };
    $('ln_counts').textContent = `${lnPaid.length} collected today · ${dueCount} due today (${allLoans.length} loans)`;

    // Savings
    const svPaid = items.filter(tx => tx.kind==='SAVINGS' && tx.status==='SUCCESS' && isToday(tx.created_at));
    const svSet = new Set(svPaid.map(x=>x.matatu_id));
    renderPaidList('sv_paid', svPaid);
    renderDueList('sv_due', svSet, 'SAVINGS');
    recomputeTotals();
  }

  function recomputeTotals(){
    const items = window._saccoStaffTx || [];
    if (!Array.isArray(items) || !items.length) return;

    const dfPaid = items.filter(tx => ['SACCO_FEE','DAILY_FEE'].includes(tx.kind) && tx.status==='SUCCESS' && isToday(tx.created_at));
    const dfTotal = dfPaid.reduce((sum, tx)=> sum + Number(tx.fare_amount_kes||0), 0);
    const dfTotalEl = document.getElementById('df_total');
    if (dfTotalEl){
      dfTotalEl.textContent = `Total: ${fmtKES(dfTotal)}`;
    }

    const svPaid = items.filter(tx => tx.kind==='SAVINGS' && tx.status==='SUCCESS' && isToday(tx.created_at));
    const svTotal = svPaid.reduce((sum, tx)=> sum + Number(tx.fare_amount_kes||0), 0);
    const svTotalEl = document.getElementById('sv_total');
    if (svTotalEl){
      svTotalEl.textContent = `Total: ${fmtKES(svTotal)}`;
    }

    const lnPaid = items.filter(tx => tx.kind==='LOAN_REPAY' && tx.status==='SUCCESS' && isToday(tx.created_at));
    const lnTotal = lnPaid.reduce((sum, tx)=> sum + Number(tx.fare_amount_kes||0), 0);
    const lnTotalEl = document.getElementById('ln_total');
    if (lnTotalEl){
      lnTotalEl.textContent = `Total: ${fmtKES(lnTotal)}`;
    }
  }

  // Tabs
  document.querySelectorAll('.tab').forEach(t=>{
    t.onclick=()=>{
      document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
      document.querySelectorAll('.panel').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      const p=document.getElementById(t.dataset.panel); if(p) p.classList.add('active');
    };
  });

  $('sacco').onchange = async ()=>{ SACCO_ID=$('sacco').value; await loadMatatus(); await loadDailyFeeConfig(); await renderAll(); };
  $('reload').onclick = async ()=>{ await loadSaccos(); await loadMatatus(); await loadDailyFeeConfig(); await renderAll(); };
  $('search').oninput = ()=>{ clearTimeout(window._srch); window._srch = setTimeout(renderAll, 200); };
  const dfMatSel = document.getElementById('df_matatu');
  if (dfMatSel){
    dfMatSel.onchange = ()=>{
      const id = dfMatSel.value;
      const m = MAT_BY_ID.get(id) || null;
      const autoAmt = dailyFeeForMatatu(m);
      const amtEl = document.getElementById('df_amount');
      if (amtEl && autoAmt){
        amtEl.value = autoAmt;
      }
    };
  }
  $('df_collect').onclick = ()=>{ const id=$('df_matatu').value; const amt=Number($('df_amount').value||0); if(!id||!amt) return toast('Pick matatu & amount'); quickCollect('DAILY_FEE', id, amt).then(()=>{$('df_amount').value='';}); };
  $('sv_collect').onclick = ()=>{ const id=$('sv_matatu').value; const amt=Number($('sv_amount').value||0); if(!id||!amt) return toast('Pick matatu & amount'); quickCollect('SAVINGS', id, amt).then(()=>{$('sv_amount').value='';}); };

  initPinSettings();

  await loadSaccos();
  await loadMatatus();
  await loadDailyFeeConfig();
  await renderAll();
})();
</script>

<script>
// Session UI
const friendlyName = (user)=>{
  if(!user) return 'SACCO Staff';
  const meta = user.user_metadata || {};
  const email = user.email || '';
  return meta.full_name || meta.name || meta.display_name || meta.displayName || (email ? email.split('@')[0] : 'SACCO Staff');
};
function startCornerClock(){ const el=document.getElementById('dateTimeLine'); if(!el) return; const update=()=>{ el.textContent=new Date().toLocaleString(); }; update(); setInterval(update,1000); }
startCornerClock();
(function tweakForNativeApp(){
  try{
    const inApp = !!(window.Capacitor && window.Capacitor.isNativePlatform);
    if (!inApp) return;
    // Hide web-only navigation
    const link = document.getElementById('roleSelectLink');
    if (link) link.style.display = 'none';
    // Special header text for offline app
    const h2 = document.querySelector('h2');
    if (h2) h2.textContent = 'SACCO Staff – Offline Cash Desk';
  }catch(_){}
})();
(async function(){ try{ if(window.TT && window.TT.getSupabase){ const supa = await window.TT.getSupabase(); const {data:{session}}=await supa.auth.getSession(); const el=document.getElementById('auth_state'); if(el) el.textContent = session?.user?.email ? (`Signed in as ${session.user.email}`) : 'Not signed in'; const welcome=document.getElementById('welcomeLine'); if(welcome) welcome.textContent = `Hello, ${friendlyName(session?.user)}`; const b=document.getElementById('logoutBtn'); b?.addEventListener('click', async ()=>{ try{ await supa.auth.signOut(); }catch(_){} localStorage.removeItem('auth_token'); localStorage.removeItem('tt_root_token'); localStorage.removeItem('tt_admin_token'); location.reload(); }); } }catch(_){ } })();
</script>

</body>
</html>
