<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TekeTeke � SACCO Staff</title>
  <script src="/public/js/app-config.js"></script>
  <script src="/public/js/api.js"></script>
  <script src="/public/js/role-guard.js"></script>
  <style>
    :root{ --brand:#1976d2; --brand-700:#135ba1; --bg:#f6f7fb; --panel:#fff; --border:#e5e7eb; --muted:#6b7280; --ink:#0b0f19; }
    *{box-sizing:border-box}
    body{font-family:system-ui, Segoe UI, Arial; background:var(--bg); color:var(--ink); margin:0; padding:20px}
    h2{color:var(--brand); margin:0 0 12px}
    h3{margin:0 0 10px}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .right{margin-left:auto}
    input,select,button{padding:10px; border:1px solid var(--border); border-radius:8px}
    button{background:var(--brand); color:#fff; border:none; cursor:pointer}
    button.ghost{background:#fff; color:#1976d2}
    .card{background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:14px}
    .stack{display:grid; gap:12px}
    .muted{color:var(--muted)}
    .mono{font-family:ui-monospace,Consolas,monospace}
    table{width:100%; border-collapse:collapse}
    th,td{padding:8px 10px; border:1px solid var(--border); text-align:left}
    th{background:var(--brand); color:#fff}
    .pill{background:#eef2ff; color:#3730a3; border:1px solid #c7d2fe; padding:4px 10px; border-radius:999px; font-size:12px; max-width:40vw; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
    .section-title{display:flex; align-items:center; justify-content:space-between; margin-bottom:8px}
    .amount{width:110px}
    .table-wrap{max-height:360px; overflow:auto; border:1px solid var(--border); border-radius:10px}
    #toast{position:fixed; bottom:14px; right:14px; background:#111827; color:#fff; padding:10px 12px; border-radius:8px; opacity:0; pointer-events:none; transition:.2s; box-shadow:0 4px 18px rgba(0,0,0,.2)}
    #toast.show{opacity:1; pointer-events:auto}
    /* Admin-style tabs */
    .tabs{display:flex; gap:8px; margin:12px 0 16px}
    .tab{padding:10px 14px; background:#1976d2; color:#fff; border-radius:8px; cursor:pointer}
    .tab.active{background:#135ba1}
    .panel{display:none; background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:14px; box-shadow:0 2px 8px rgba(0,0,0,.04)}
    .panel.active{display:block}
    .corner-info{display:flex;flex-direction:column;align-items:flex-start;margin-bottom:10px}
    .corner-info .hello{font-size:16px;font-weight:600;color:var(--ink)}
    .corner-info .time{font-size:13px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="corner-info">
    <div class="hello" id="welcomeLine">Hello!</div>
    <div class="time" id="dateTimeLine">--</div>
  </div>
  <div class="row" style="justify-content:space-between; align-items:center; margin-bottom:8px">
    <a href="/public/auth/role-select.html">Role Select</a>
    <div class="row" style="gap:8px">
      <span id="auth_state" class="pill">Checking sign-in�</span>
      <button id="logoutBtn" style="padding:8px 10px; border-radius:8px; border:1px solid #cfe3ff; background:#0b5cab; color:#fff">Logout</button>
    </div>
  </div>
  <h2>SACCO Staff � Cash Desk</h2>

  <!-- Top filters & defaults -->
  <div class="card stack">
    <div class="row">
      <label>SACCO <select id="sacco"></select></label>
      <label>Search plate <input id="search" placeholder="KDA123A"/></label>
      <button id="reload" class="ghost">Reload</button>
      <span class="right muted" id="stat"></span>
    </div>
    <div class="card" style="background:#eef2ff;border:1px dashed #c7d2fe">
      <div class="row" style="align-items:center;gap:12px">
        <div style="flex:1">
          <strong>Need offline mode?</strong>
          <div class="muted">Download the SACCO Staff Android app for better offline recording.</div>
        </div>
        <a class="btn" href="/public/downloads/teketeke-go-sacco-staff.apk" download>Download APK</a>
      </div>
    </div>
    
  </div>

  <!-- Tabs in the same style as System Admin -->
  <div class="tabs" role="tablist" aria-label="Collections">
    <div class="tab active" data-panel="p_daily" role="tab" aria-selected="true">Daily Fee</div>
    <div class="tab" data-panel="p_loans" role="tab">Loans Repayment</div>
    <div class="tab" data-panel="p_savings" role="tab">Savings</div>
  </div>

  <!-- Daily Fee Panel -->
  <section id="p_daily" class="panel active" aria-labelledby="tab_daily">
    <div class="section-title"><h3 style="margin:0">Daily Fee</h3><span class="muted" id="df_counts"></span></div>
    <div class="card">
      <h4>Paid Today</h4>
      <div class="table-wrap">
        <table>
          <thead><tr><th>Plate</th><th>Amount</th><th>Time</th></tr></thead>
          <tbody id="df_paid"></tbody>
        </table>
      </div>
    </div>
    <div class="card" style="margin-top:10px"><h4>Manual Collection</h4>
      <div class="row">
        <label>Matatu <select id="df_matatu"></select></label>
        <input id="df_amount" type="number" placeholder="Amount (KES)" class="amount"/>
        <input id="df_name" placeholder="Payer name"/>
        <input id="df_phone" placeholder="07XXXXXXXX"/>
        <button id="df_collect">Collect</button>
      </div>
    </div>
    <div class="card" style="margin-top:10px">
      <h4>Not Paid (to collect)</h4>
      <div class="table-wrap">
        <table>
          <thead><tr><th>Plate</th><th class="mono">Matatu ID</th><th>Amount</th><th></th></tr></thead>
          <tbody id="df_due"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Loans Repayment Panel -->
  <section id="p_loans" class="panel" aria-labelledby="tab_loans">
    <div class="section-title"><h3 style="margin:0">Loans Repayment</h3><span class="muted" id="ln_counts"></span></div>
    <div class="card">
      <h4>Paid Today</h4>
      <div class="table-wrap">
        <table>
          <thead><tr><th>Plate</th><th>Amount</th><th>Time</th></tr></thead>
          <tbody id="ln_paid"></tbody>
        </table>
      </div>
    </div>
    <div class="card" style="margin-top:10px"><h4>Manual Collection</h4>
      <div class="row">
        <label>Matatu <select id="ln_matatu"></select></label>
        <input id="ln_amount" type="number" placeholder="Amount (KES)" class="amount"/>
        <input id="ln_name" placeholder="Payer name"/>
        <input id="ln_phone" placeholder="07XXXXXXXX"/>
        <button id="ln_collect">Collect</button>
      </div>
    </div>
    <div class="card" style="margin-top:10px"><h4>Not Paid (to collect)</h4>
      <div class="table-wrap">
        <table>
          <thead><tr><th>Plate</th><th class="mono">Matatu ID</th><th>Amount</th><th></th></tr></thead>
          <tbody id="ln_due"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Savings Panel -->
  <section id="p_savings" class="panel" aria-labelledby="tab_savings">
    <div class="section-title"><h3 style="margin:0">Savings</h3><span class="muted" id="sv_counts"></span></div>
    <div class="card">
      <h4>Paid Today</h4>
      <div class="table-wrap">
        <table>
          <thead><tr><th>Plate</th><th>Amount</th><th>Time</th></tr></thead>
          <tbody id="sv_paid"></tbody>
        </table>
      </div>
    </div>
    <div class="card" style="margin-top:10px"><h4>Manual Collection</h4>
      <div class="row">
        <label>Matatu <select id="sv_matatu"></select></label>
        <input id="sv_amount" type="number" placeholder="Amount (KES)" class="amount"/>
        <input id="sv_name" placeholder="Payer name"/>
        <input id="sv_phone" placeholder="07XXXXXXXX"/>
        <button id="sv_collect">Collect</button>
      </div>
    </div>
    <div class="card" style="margin-top:10px"><h4>Not Paid (to collect)</h4>
      <div class="table-wrap">
        <table>
          <thead><tr><th>Plate</th><th class="mono">Matatu ID</th><th>Amount</th><th></th></tr></thead>
          <tbody id="sv_due"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Recent transactions -->
  <div class="card" style="margin-top:12px">
    <div class="row"><strong>Recent Transactions</strong><button id="reloadTx" class="ghost right">Reload</button></div>
    <div class="table-wrap" style="margin-top:8px">
      <table>
        <thead><tr><th>When</th><th>Matatu</th><th>MSISDN</th><th>Kind</th><th>Amount</th><th>Status</th><th>ID</th></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <div id="toast" role="status" aria-live="polite"></div>

<script>
(async function(){
  try{
    await requireRole('SACCO_STAFF', { statusEl: 'auth_state', roleLabel: 'SACCO Staff' });
  }catch(_){
    return;
  }
  const $ = id => document.getElementById(id);
  const todayIso = d => new Date(d).toISOString().slice(0,10);
  const isToday = (ts) => todayIso(ts) === todayIso(new Date());
  const fmtKES = n => Number(n||0).toLocaleString('en-KE', {minimumFractionDigits:2, maximumFractionDigits:2});
  const toast = (msg)=>{ const t=$('toast'); t.textContent=msg; t.classList.add('show'); clearTimeout(window._t); window._t=setTimeout(()=>t.classList.remove('show'),1800); };

  async function parse(r){ const t=await r.text(); let j={}; try{ j=t?JSON.parse(t):{} }catch{ j={error:t||r.statusText} } if(!r.ok) throw new Error(j.error||j.message||r.statusText); return j; }
  async function g(p){ return parse(await fetch(p)); }
  async function post(p,b){ return parse(await fetch(p,{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(b)})); }

  let SACCO_ID=null; let MATATUS=[]; let MAT_BY_ID=new Map();

  // Loaders
  async function loadSaccos(){
    const res=await g('/u/my-saccos');
    const sel=$('sacco'); sel.innerHTML='';
    (res.items||[]).forEach(s=>{ const o=document.createElement('option'); o.value=s.sacco_id; o.textContent=s.name||s.sacco_id; sel.appendChild(o); });
    if(res.items?.length){ sel.value=res.items[0].sacco_id; SACCO_ID = sel.value; }
  }
  async function loadMatatus(){
    if(!SACCO_ID) return;
    const res=await g(`/u/sacco/${SACCO_ID}/matatus`);
    MATATUS = res.items||[];
    MAT_BY_ID = new Map(MATATUS.map(m=>[m.id,m]));
    $('stat').textContent = `${MATATUS.length} matatu(s)`;
    // fill manual selects per tab
    function fillSel(id){ const el=document.getElementById(id); if(!el) return; el.innerHTML=''; (MATATUS||[]).forEach(m=>{ const o=document.createElement('option'); o.value=m.id; o.textContent=m.number_plate; el.appendChild(o); }); }
    fillSel('df_matatu'); fillSel('ln_matatu'); fillSel('sv_matatu');
  }

  // Collect helpers
  async function quickCollect(kind, matatu_id, amount){
    const body = {
      sacco_id: SACCO_ID,
      matatu_id,
      kind,
      amount: Number(amount||0),
      payer_name: 'Cash desk',
      payer_phone: ''
    };
    await post('/api/staff/cash', body);
    toast('Recorded ?');
    await Promise.all([renderAll(), loadRecentTx()]);
  }

  // Render sections
  function filterByKindToday(items, kind){
    return items.filter(tx => tx.kind===kind && tx.status==='SUCCESS' && isToday(tx.created_at));
  }

  function renderPaidList(tbodyId, list){
    const T = $(tbodyId); if(!T) return;
    T.innerHTML='';
    list.sort((a,b)=> new Date(b.created_at) - new Date(a.created_at));
    list.forEach(tx=>{
      const m = MAT_BY_ID.get(tx.matatu_id) || {}; const plate = m.number_plate || tx.matatu_id || '';
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${plate}</td><td>${fmtKES(tx.fare_amount_kes)}</td><td>${new Date(tx.created_at).toLocaleTimeString()}</td>`;
      T.appendChild(tr);
    });
  }

  function renderDueList(tbodyId, paidSet, kind, defAmount){
    const T = $(tbodyId); if(!T) return;
    T.innerHTML='';
    const q = ($('search').value||'').trim().toUpperCase();
    const due = MATATUS.filter(m => (!q || (m.number_plate||'').toUpperCase().includes(q)) && !paidSet.has(m.id));
    due.forEach(m=>{
      const tr=document.createElement('tr');
      const amtId = `${tbodyId}_amt_${m.id}`;
      tr.innerHTML = `<td>${m.number_plate||''}</td><td class='mono'>${m.id}</td>`+
        `<td><input id='${amtId}' type='number' placeholder='${defAmount||""}' class='amount'/></td>`+
        `<td><button data-kind='${kind}' data-id='${m.id}'>Collect</button></td>`;
      T.appendChild(tr);
    });
    T.onclick = (e)=>{
      const btn = e.target.closest('button'); if(!btn) return;
      const id = btn.getAttribute('data-id'); const k=btn.getAttribute('data-kind');
      const amt = Number((document.getElementById(`${tbodyId}_amt_${id}`)?.value)||0);
      if(!amt || amt<=0) { toast('Enter amount'); return; }
      btn.disabled = true; quickCollect(k, id, amt).finally(()=>{ btn.disabled=false; });
    };
  }

  async function renderAll(){

    if(!SACCO_ID) return;
    const res = await g(`/u/sacco/${SACCO_ID}/transactions?limit=1000`);
    const items = res.items||[];

    function paidForKinds(kinds){
      return items.filter(tx => kinds.includes(tx.kind) && tx.status==='SUCCESS' && isToday(tx.created_at));
    }

    // DAILY FEE
    const dfPaid = paidForKinds(['SACCO_FEE','DAILY_FEE']);
    const dfSet = new Set(dfPaid.map(x=>x.matatu_id));
    renderPaidList('df_paid', dfPaid);
    renderDueList('df_due', dfSet, 'DAILY_FEE', '');
    $('df_counts').textContent = `${dfPaid.length} paid � ${(MATATUS.length - dfSet.size)} due`;

    // LOANS
    const lnPaid = paidForKinds(['LOAN_REPAY']);
    const lnSet = new Set(lnPaid.map(x=>x.matatu_id));
    renderPaidList('ln_paid', lnPaid);
    renderDueList('ln_due', lnSet, 'LOAN_REPAY', '');
    $('ln_counts').textContent = `${lnPaid.length} paid � ${(MATATUS.length - lnSet.size)} due`;

    // SAVINGS
    const svPaid = paidForKinds(['SAVINGS']);
    const svSet = new Set(svPaid.map(x=>x.matatu_id));
    renderPaidList('sv_paid', svPaid);
    renderDueList('sv_due', svSet, 'SAVINGS', '');
    $1
  }

  async function loadRecentTx(){
    if(!SACCO_ID) return;
    const res=await g(`/u/sacco/${SACCO_ID}/transactions?limit=50`);
    const T=$('tbody'); T.innerHTML='';
    (res.items||[]).sort((a,b)=> new Date(b.created_at)-new Date(a.created_at)).forEach(tx=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${new Date(tx.created_at).toLocaleString()}</td>`+
        `<td class='mono'>${tx.matatu_id||''}</td>`+
        `<td class='mono'>${tx.passenger_msisdn||''}</td>`+
        `<td>${tx.kind||''}</td>`+
        `<td>${fmtKES(tx.fare_amount_kes)}</td>`+
        `<td>${tx.status||''}</td>`+
        `<td class='mono'>${tx.id}</td>`;
      T.appendChild(tr);
    });
  }

  // Simple self-tests (console-only)
  (function runSelfTests(){
    try{
      console.group('SACCO Staff � self-tests');
      const now = new Date();
      const yesterday = new Date(Date.now()-24*3600*1000);
      console.assert(isToday(now) === true, 'isToday(now) should be true');
      console.assert(isToday(yesterday) === false, 'isToday(yesterday) should be false');
      const sample = [
        {kind:'SAVINGS', status:'SUCCESS', created_at: now.toISOString(), matatu_id:'M1', fare_amount_kes:100},
        {kind:'SAVINGS', status:'FAILED',  created_at: now.toISOString(), matatu_id:'M2', fare_amount_kes:100},
        {kind:'SAVINGS', status:'SUCCESS', created_at: yesterday.toISOString(), matatu_id:'M3', fare_amount_kes:100},
        {kind:'LOAN_REPAY', status:'SUCCESS', created_at: now.toISOString(), matatu_id:'M4', fare_amount_kes:100}
      ];
      const paidSav = sample.filter(tx=>tx.kind==='SAVINGS' && tx.status==='SUCCESS' && isToday(tx.created_at));
      console.assert(paidSav.length === 1 && paidSav[0].matatu_id==='M1', 'Paid savings filter sanity');
      console.assert(document.querySelectorAll('.tab').length===3, 'tabs exist');
      console.groupEnd();
    }catch(e){ console.error('Self-tests failed', e); }
  })();

  // Events
  // Tabs like System Admin
  document.querySelectorAll('.tab').forEach(t=>{
    t.onclick=()=>{
      document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
      document.querySelectorAll('.panel').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      const p = document.getElementById(t.dataset.panel);
      if (p) p.classList.add('active');
    };
  });

  $('sacco').onchange = async ()=>{ SACCO_ID=$('sacco').value; await loadMatatus(); await renderAll(); await loadRecentTx(); };
  $('reload').onclick = async ()=>{ await loadSaccos(); await loadMatatus(); await renderAll(); await loadRecentTx(); };
  $('reloadTx').onclick = loadRecentTx;
  $('search').oninput = ()=>{ clearTimeout(window._srch); window._srch = setTimeout(renderAll, 200); };
  

  // manual collection buttons
  const manual = (prefix, kind) => {
    const idEl = document.getElementById(prefix+'_matatu');
    const amtEl = document.getElementById(prefix+'_amount');
    const nameEl = document.getElementById(prefix+'_name');
    const phoneEl = document.getElementById(prefix+'_phone');
    const id = idEl && idEl.value; const amt = Number(amtEl && amtEl.value || 0);
    if(!id || !amt){ toast('Pick matatu & amount'); return; }
    const body = { sacco_id:SACCO_ID, matatu_id:id, kind, amount:amt, payer_name:(nameEl?nameEl.value.trim():''), payer_phone:(phoneEl?phoneEl.value.trim():'') };
    post('/api/staff/cash', body).then(()=>{ toast('Recorded ?'); if(amtEl) amtEl.value=''; renderAll(); loadRecentTx(); }).catch(e=>toast(e.message||'Error'));
  };
  document.getElementById('df_collect')?.addEventListener('click', ()=> manual('df','DAILY_FEE'));
  document.getElementById('ln_collect')?.addEventListener('click', ()=> manual('ln','LOAN_REPAY'));
  document.getElementById('sv_collect')?.addEventListener('click', ()=> manual('sv','SAVINGS'));

  // init
  await loadSaccos();
  await loadMatatus();
  await renderAll();
  await loadRecentTx();
})();
</script>

<script>
const friendlyName = (user)=>{
  if(!user) return 'SACCO Staff';
  const meta = user.user_metadata || {};
  const email = user.email || '';
  return meta.full_name || meta.name || meta.display_name || meta.displayName || (email ? email.split('@')[0] : 'SACCO Staff');
};
function startCornerClock(){
  const el = document.getElementById('dateTimeLine');
  if(!el) return;
  const update = ()=>{ el.textContent = new Date().toLocaleString(); };
  update();
  setInterval(update, 1000);
}
startCornerClock();

// Auth pill
(async function(){
  try{
    if(window.TT && window.TT.getSupabase){
      const supa = await window.TT.getSupabase();
      const {data:{session}} = await supa.auth.getSession();
      const el = document.getElementById('auth_state');
      if(el) el.textContent = session?.user?.email ? (`Signed in as ${session.user.email}`) : 'Not signed in';
      const welcome = document.getElementById('welcomeLine');
      if (welcome) welcome.textContent = `Hello, ${friendlyName(session?.user)}`;
      const b = document.getElementById('logoutBtn');
      b?.addEventListener('click', async ()=>{ try{ await supa.auth.signOut(); }catch(_){} localStorage.removeItem('auth_token'); localStorage.removeItem('tt_root_token'); localStorage.removeItem('tt_admin_token'); location.reload(); }, {passive:true});
    }
  }catch(_){ }
})();
</script>
</body>
</html>


