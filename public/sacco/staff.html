<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TekeTeke - SACCO Staff</title>

  <link rel="stylesheet" href="/public/css/dashboard-theme.css"/>
  <script src="/public/js/app-config.js"></script>
  <script src="/public/js/api.js"></script>
  <script src="/public/js/role-guard.js"></script>
</head>
<body>

<div class="hero-card">
  <div class="hero-stack">
    <p class="eyebrow">SACCO Staff</p>
    <div class="hello" id="welcomeLine">Hello!</div>
    <div class="timestamp" id="dateTimeLine">--</div>
    <div class="muted" id="saccoNameLine" style="margin-top:4px;font-size:13px;">SACCO: --</div>
  </div>
  <div class="hero-actions">
    <a class="btn ghost" href="/public/auth/role-select.html">Role Select</a>
    <span id="auth_state" class="pill">Checking sign-in...</span>
    <button id="logoutBtn" class="btn bad">Logout</button>
  </div>
</div>

<h2>SACCO Staff - Cash Desk</h2>

<!-- Top filters (hidden: SACCO select/search/reload now handled automatically) -->
<div class="card stack">
  <div class="row" style="display:none">
    <label>SACCO <select id="sacco"></select></label>
    <label>Search plate <input id="search" placeholder="KDA123A"/></label>
    <button id="reload" class="ghost">Reload</button>
    <span class="right muted" id="stat"></span>
  </div>
</div>

<!-- Tabs -->
<div class="tabs" role="tablist" aria-label="Collections">
  <div class="tab active" data-panel="p_daily" role="tab" aria-selected="true">Daily Fee</div>
  <div class="tab" data-panel="p_loans" role="tab">Loans</div>
  <div class="tab" data-panel="p_savings" role="tab">Savings</div>
  <!-- Note: removed extra link buttons per request -->
  </div>

<!-- Daily Fee Panel -->
<section id="p_daily" class="panel active" aria-labelledby="tab_daily">
  <div class="section-title"><h3 style="margin:0">Daily Fee</h3><span class="muted" id="df_counts"></span></div>
  <div class="card">
    <h4>Paid Today</h4>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Plate</th><th>Amount</th><th>Time</th></tr></thead>
        <tbody id="df_paid"></tbody>
      </table>
    </div>
  </div>
  <div class="card" style="margin-top:10px"><h4>Manual Collection</h4>
    <div class="row">
      <label>Matatu <select id="df_matatu"></select></label>
      <input id="df_amount" type="number" placeholder="Amount (KES)" class="amount"/>
      <input id="df_name" placeholder="Payer name"/>
      <input id="df_phone" placeholder="07XXXXXXXX"/>
      <button id="df_collect">Collect</button>
    </div>
  </div>
  <div class="card" style="margin-top:10px">
    <h4>Not Paid (to collect)</h4>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Plate</th><th class="mono">Matatu ID</th><th>Amount</th><th></th></tr></thead>
        <tbody id="df_due"></tbody>
      </table>
    </div>
  </div>
  </section>

<!-- Loans Panel (single table) -->
<section id="p_loans" class="panel" aria-labelledby="tab_loans">
  <div class="section-title"><h3 style="margin:0">Loan Table (Due Today)</h3><span class="muted" id="ln_counts"></span></div>
  <div class="card">
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Matatu</th>
            <th>Loan Amount</th>
            <th>Loan Balance</th>
            <th>To Pay Today</th>
            <th>Amount</th>
            <th>Collect</th>
          </tr>
        </thead>
        <tbody id="ln_table"></tbody>
      </table>
    </div>
  </div>
</section>

<!-- Savings Panel -->
<section id="p_savings" class="panel" aria-labelledby="tab_savings">
  <div class="section-title"><h3 style="margin:0">Savings</h3><span class="muted" id="sv_counts"></span></div>
  <div class="card">
    <h4>Paid Today</h4>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Plate</th><th>Amount</th><th>Time</th></tr></thead>
        <tbody id="sv_paid"></tbody>
      </table>
    </div>
  </div>
  <div class="card" style="margin-top:10px"><h4>Manual Collection</h4>
    <div class="row">
      <label>Matatu <select id="sv_matatu"></select></label>
      <input id="sv_amount" type="number" placeholder="Amount (KES)" class="amount"/>
      <input id="sv_name" placeholder="Payer name"/>
      <input id="sv_phone" placeholder="07XXXXXXXX"/>
      <button id="sv_collect">Collect</button>
    </div>
  </div>
  <div class="card" style="margin-top:10px">
    <h4>Not Paid (to collect)</h4>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Plate</th><th class="mono">Matatu ID</th><th>Amount</th><th></th></tr></thead>
        <tbody id="sv_due"></tbody>
      </table>
    </div>
  </div>
</section>

<div class="card" style="margin:24px auto;max-width:640px;background:#eef2ff;border:1px dashed #c7d2fe">
  <div class="row" style="align-items:center;gap:12px">
    <div style="flex:1">
      <strong>Need offline mode?</strong>
      <div class="muted">Download the SACCO Staff Android app for better offline recording.</div>
    </div>
    <a class="btn" href="/public/downloads/teketeke-go-sacco-staff.apk" download>Download APK</a>
  </div>
</div>

<div id="toast" role="status" aria-live="polite"></div>

<script>
(async function(){
  try{ await requireRole('SACCO_STAFF', { statusEl:'auth_state', roleLabel:'SACCO Staff' }); }catch(_){ return; }
  const $ = id => document.getElementById(id);
  const todayIso = d => new Date(d).toISOString().slice(0,10);
  const isToday = (ts) => todayIso(ts) === todayIso(new Date());
  const fmtKES = n => Number(n||0).toLocaleString('en-KE',{minimumFractionDigits:2,maximumFractionDigits:2});
  const toast = (msg)=>{ const t=$('toast'); t.textContent=msg; t.classList.add('show'); clearTimeout(window._t); window._t=setTimeout(()=>t.classList.remove('show'),1800); };

  async function parse(r){ const t=await r.text(); let j={}; try{ j=t?JSON.parse(t):{} }catch{ j={error:t||r.statusText} } if(!r.ok) throw new Error(j.error||j.message||r.statusText); return j; }
  async function g(p){ return parse(await fetch(p)); }
  async function post(p,b){ return parse(await fetch(p,{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(b)})); }

  let SACCO_ID=null; let MATATUS=[]; let MAT_BY_ID=new Map();
  let DAILY_FEE_BY_TYPE = new Map();

  async function loadSaccos(){
    const res=await g('/u/my-saccos');
    const sel=$('sacco'); sel.innerHTML='';
    const items = res.items||[];
    items.forEach(s=>{ const o=document.createElement('option'); o.value=s.sacco_id; o.textContent=s.name||s.sacco_id; sel.appendChild(o); });
    if(items.length){
      sel.value=items[0].sacco_id;
      SACCO_ID = sel.value;
      const line = document.getElementById('saccoNameLine');
      if (line){
        const name = items[0].name || items[0].sacco_id || '';
        line.textContent = name ? `SACCO: ${name}` : 'SACCO: --';
      }
    }
  }
  async function loadMatatus(){
    if(!SACCO_ID) return;
    const res=await g(`/u/sacco/${SACCO_ID}/matatus`);
    MATATUS = res.items||[];
    MAT_BY_ID = new Map(MATATUS.map(m=>[m.id,m]));
    $('stat').textContent = `${MATATUS.length} matatu(s)`;
    function fillSel(id){ const el=document.getElementById(id); if(!el) return; el.innerHTML=''; (MATATUS||[]).forEach(m=>{ const o=document.createElement('option'); o.value=m.id; o.textContent=m.number_plate; el.appendChild(o); }); }
    fillSel('df_matatu'); fillSel('sv_matatu');
  }

  async function loadDailyFeeConfig(){
    DAILY_FEE_BY_TYPE = new Map();
    if (!SACCO_ID) return;
    try{
      const res = await g(`/u/sacco/${SACCO_ID}/daily-fee-rates`);
      const items = res.items || [];
      DAILY_FEE_BY_TYPE = new Map(items.map(r=>[(r.vehicle_type||'').toString().toUpperCase(), Number(r.daily_fee_kes||0)]));
    }catch(_){ DAILY_FEE_BY_TYPE = new Map(); }
  }

  async function quickCollect(kind, matatu_id, amount){
    const body = { sacco_id:SACCO_ID, matatu_id, kind, amount:Number(amount||0), payer_name:'Cash desk', payer_phone:'' };
    await post('/api/staff/cash', body);
    toast('Recorded');
    await renderAll();
  }

  function renderPaidList(tbodyId, list){
    const T=$(tbodyId); if(!T) return; T.innerHTML='';
    list.sort((a,b)=> new Date(b.created_at)-new Date(a.created_at)).forEach(tx=>{
      const m = MAT_BY_ID.get(tx.matatu_id) || {}; const plate = m.number_plate || tx.matatu_id || '';
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${plate}</td><td>${fmtKES(tx.fare_amount_kes)}</td><td>${new Date(tx.created_at).toLocaleTimeString()}</td>`;
      T.appendChild(tr);
    });
  }
  function dailyFeeForMatatu(m){
    if (!m) return 0;
    const vt = (m.vehicle_type||'').toString().toUpperCase();
    const v = DAILY_FEE_BY_TYPE.get(vt);
    return Number.isFinite(v) && v>0 ? v : 0;
  }

  function renderDueList(tbodyId, paidSet, kind){
    const T=$(tbodyId); if(!T) return; T.innerHTML='';
    const q = ($('search').value||'').trim().toUpperCase();
    const due = MATATUS.filter(m => (!q || (m.number_plate||'').toUpperCase().includes(q)) && !paidSet.has(m.id));
    due.forEach(m=>{
      const tr=document.createElement('tr'); const amtId = `${tbodyId}_amt_${m.id}`;
      const autoAmt = kind==='DAILY_FEE' ? dailyFeeForMatatu(m) : 0;
      tr.innerHTML = `<td>${m.number_plate||''}</td><td class='mono'>${m.id}</td>`+
        `<td><input id='${amtId}' type='number' class='amount' placeholder='Amount'`+ (autoAmt?` value='${autoAmt}'`:'') +`/></td>`+
        `<td><button data-kind='${kind}' data-id='${m.id}'>Collect</button></td>`;
      T.appendChild(tr);
    });
    T.onclick=(e)=>{ const btn=e.target.closest('button'); if(!btn) return; const id=btn.getAttribute('data-id'); const k=btn.getAttribute('data-kind'); const v=Number((document.getElementById(`${tbodyId}_amt_${id}`)?.value)||0); if(!v) return toast('Enter amount'); btn.disabled=true; quickCollect(k,id,v).finally(()=>{ btn.disabled=false; }); };
  }

  function addMonths(d, m){ const x=new Date(d); x.setMonth(x.getMonth()+m); return x; }
  function startOfDay(d){ const x=new Date(d); x.setHours(0,0,0,0); return x; }
  function countWeekdaysInclusive(start, end){ try{ let c=0, d=startOfDay(start), e=startOfDay(end); while(d<=e){ const w=d.getDay(); if(w>=1 && w<=5) c++; d.setDate(d.getDate()+1);} return Math.max(1,c);}catch(_){ return 1; } }
  function weeksInRange(start, end){ try{ const ms = startOfDay(end).getTime() - startOfDay(start).getTime(); return Math.max(1, Math.ceil(ms/(7*24*3600*1000))); }catch(_){ return 1; } }

  async function renderAll(){
    if(!SACCO_ID) return;
    const res = await g(`/u/sacco/${SACCO_ID}/transactions?limit=1000`);
    const items = res.items||[];

    const dfPaid = items.filter(tx => ['SACCO_FEE','DAILY_FEE'].includes(tx.kind) && tx.status==='SUCCESS' && isToday(tx.created_at));
    const dfSet = new Set(dfPaid.map(x=>x.matatu_id));
    renderPaidList('df_paid', dfPaid);
    renderDueList('df_due', dfSet, 'DAILY_FEE');
    $('df_counts').textContent = `${dfPaid.length} paid · ${(MATATUS.length - dfSet.size)} due`;

    // Loans: single simple table
    const lnPaid = items.filter(tx => tx.kind==='LOAN_REPAY' && tx.status==='SUCCESS' && isToday(tx.created_at));
    const paidSum = new Map(); lnPaid.forEach(t=>{ const id=t.matatu_id; paidSum.set(id,(paidSum.get(id)||0)+Number(t.fare_amount_kes||0)); });

    let loans = { items: [] };
    try{ loans = await g(`/u/sacco/${SACCO_ID}/loans`); }catch(_){ loans = { items: [] }; }
    const allLoans = (loans.items||[]);
    const LT = $('ln_table'); if (LT){ LT.innerHTML=''; }
    // All-time successful repayments for quick balance calc
    const loanRepaysAll = items.filter(tx => tx.kind==='LOAN_REPAY' && tx.status==='SUCCESS');

    const msDay = 24*3600*1000; const today = startOfDay(new Date());
    let dueCount = 0;
    allLoans.forEach(l=>{
      const m = MAT_BY_ID.get(l.matatu_id)||{}; const plate = m.number_plate || (l.matatu_id||'');
      const id = l.matatu_id || '';
      const principal = Number(l.principal_kes||0);
      const ratePct = Number(l.interest_rate_pct||0);
      const total = principal * (1 + ratePct/100);
      const model = String(l.collection_model||'MONTHLY');
      const term = Math.max(1, Number(l.term_months||1));
      const start = l.start_date ? new Date(l.start_date) : new Date();
      const end = addMonths(start, term);
      let installments = term; if (model==='DAILY') installments = countWeekdaysInclusive(start, end); else if (model==='WEEKLY') installments = weeksInRange(start, end);
      const installmentAmt = installments>0 ? (total/installments) : total;
      // Determine if today is a payable day
      let isPayDay = false;
      if (model === 'DAILY') { isPayDay = true; }
      else if (model === 'WEEKLY') {
        const days = Math.floor((today.getTime() - startOfDay(start).getTime())/msDay);
        isPayDay = (days >= 0) && (days % 7 === 0) && (today <= end);
      } else { isPayDay = false; }
      const dueToday = isPayDay ? installmentAmt : 0;
      if (isPayDay) dueCount++;
      const repaidAll = loanRepaysAll
        .filter(t => String(t.matatu_id)===String(id) && (!l.start_date || new Date(t.created_at) >= new Date(l.start_date)))
        .reduce((s,t)=> s + Number(t.fare_amount_kes||0), 0);
      const loanBalance = Math.max(0, total - repaidAll);
      const balToday = Math.max(0, dueToday - Number(paidSum.get(id)||0));
      const amtId = `ln_amt_${id}`;
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${plate}</td>`+
        `<td>${fmtKES(principal)}</td>`+
        `<td>${fmtKES(loanBalance)}</td>`+
        `<td>${fmtKES(dueToday)}</td>`+
        `<td><input id='${amtId}' type='number' class='amount' placeholder='Amount' value='${balToday.toFixed(2)}'/></td>`+
        `<td><button data-id='${id}'>Collect</button></td>`;
      LT.appendChild(tr);
    });
    LT.onclick = (e)=>{ const btn=e.target.closest('button'); if(!btn) return; const id=btn.getAttribute('data-id'); const v=Number((document.getElementById(`ln_amt_${id}`)?.value)||0); if(!v) return toast('Enter amount'); btn.disabled=true; quickCollect('LOAN_REPAY', id, v).finally(()=>{ btn.disabled=false; }); };
    $('ln_counts').textContent = `${lnPaid.length} collected today · ${dueCount} due today (${allLoans.length} loans)`;

    // Savings
    const svPaid = items.filter(tx => tx.kind==='SAVINGS' && tx.status==='SUCCESS' && isToday(tx.created_at));
    const svSet = new Set(svPaid.map(x=>x.matatu_id));
    renderPaidList('sv_paid', svPaid);
    renderDueList('sv_due', svSet, 'SAVINGS');
  }

  // Tabs
  document.querySelectorAll('.tab').forEach(t=>{
    t.onclick=()=>{
      document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
      document.querySelectorAll('.panel').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      const p=document.getElementById(t.dataset.panel); if(p) p.classList.add('active');
    };
  });

  $('sacco').onchange = async ()=>{ SACCO_ID=$('sacco').value; await loadMatatus(); await loadDailyFeeConfig(); await renderAll(); };
  $('reload').onclick = async ()=>{ await loadSaccos(); await loadMatatus(); await loadDailyFeeConfig(); await renderAll(); };
  $('search').oninput = ()=>{ clearTimeout(window._srch); window._srch = setTimeout(renderAll, 200); };
  const dfMatSel = document.getElementById('df_matatu');
  if (dfMatSel){
    dfMatSel.onchange = ()=>{
      const id = dfMatSel.value;
      const m = MAT_BY_ID.get(id) || null;
      const autoAmt = dailyFeeForMatatu(m);
      const amtEl = document.getElementById('df_amount');
      if (amtEl && autoAmt){
        amtEl.value = autoAmt;
      }
    };
  }
  $('df_collect').onclick = ()=>{ const id=$('df_matatu').value; const amt=Number($('df_amount').value||0); if(!id||!amt) return toast('Pick matatu & amount'); quickCollect('DAILY_FEE', id, amt).then(()=>{$('df_amount').value='';}); };
  $('sv_collect').onclick = ()=>{ const id=$('sv_matatu').value; const amt=Number($('sv_amount').value||0); if(!id||!amt) return toast('Pick matatu & amount'); quickCollect('SAVINGS', id, amt).then(()=>{$('sv_amount').value='';}); };

  await loadSaccos();
  await loadMatatus();
  await loadDailyFeeConfig();
  await renderAll();
})();
</script>

<script>
// Session UI
const friendlyName = (user)=>{
  if(!user) return 'SACCO Staff';
  const meta = user.user_metadata || {};
  const email = user.email || '';
  return meta.full_name || meta.name || meta.display_name || meta.displayName || (email ? email.split('@')[0] : 'SACCO Staff');
};
function startCornerClock(){ const el=document.getElementById('dateTimeLine'); if(!el) return; const update=()=>{ el.textContent=new Date().toLocaleString(); }; update(); setInterval(update,1000); }
startCornerClock();
(async function(){ try{ if(window.TT && window.TT.getSupabase){ const supa = await window.TT.getSupabase(); const {data:{session}}=await supa.auth.getSession(); const el=document.getElementById('auth_state'); if(el) el.textContent = session?.user?.email ? (`Signed in as ${session.user.email}`) : 'Not signed in'; const welcome=document.getElementById('welcomeLine'); if(welcome) welcome.textContent = `Hello, ${friendlyName(session?.user)}`; const b=document.getElementById('logoutBtn'); b?.addEventListener('click', async ()=>{ try{ await supa.auth.signOut(); }catch(_){} localStorage.removeItem('auth_token'); localStorage.removeItem('tt_root_token'); localStorage.removeItem('tt_admin_token'); location.reload(); }); } }catch(_){ } })();
</script>

</body>
</html>
