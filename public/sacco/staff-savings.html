<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TekeTeke — SACCO Staff • Savings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/public/css/dashboard-theme.css"/>
  <link rel="icon" href="/public/mobile/shared/icons/icon-192.png"/>
  <script src="/public/js/app-config.js"></script>
  <script src="/public/js/api.js"></script>
  <script src="/public/js/role-guard.js"></script>
</head>
<body>
  <div class="top-meta hero-card">
    <div class="hero-stack">
      <h2>Savings</h2>
      <div class="muted">Record and view today's savings</div>
    </div>
    <div class="hero-actions">
      <a class="btn ghost" href="/public/sacco/staff-daily.html">Daily Fee</a>
      <a class="btn ghost" href="/public/sacco/staff-loans.html">Loans</a>
      <a class="btn" href="/public/auth/role-select.html">Role Select</a>
      <span id="auth_state" class="pill">Checking sign-in…</span>
    </div>
  </div>

  <div class="bar">
    <label>SACCO <select id="sacco"></select></label>
    <button id="reload" class="ghost">Reload</button>
    <span class="right muted" id="stat"></span>
  </div>

  <section class="panel">
    <div class="card">
      <div class="table-wrap">
        <table>
          <thead><tr><th>Plate</th><th class="mono">Matatu ID</th><th>Save (KES)</th><th></th></tr></thead>
          <tbody id="sv_due"></tbody>
        </table>
      </div>
    </div>
  </section>

  <section class="panel">
    <div class="card"><h3>Saved Today</h3>
      <div class="table-wrap">
        <table>
          <thead><tr><th>Time</th><th>Matatu</th><th>Amount</th></tr></thead>
          <tbody id="sv_paid"></tbody>
        </table>
      </div>
    </div>
  </section>

  <div id="toast" role="status" aria-live="polite"></div>

  <script>
  (async function(){
    try{ await requireRole('SACCO_STAFF', { statusEl:'auth_state', roleLabel:'SACCO Staff' }); }catch(_){ return; }
    const $ = (id)=>document.getElementById(id);
    const iso = (d)=> new Date(d).toISOString().slice(0,10);
    const today = iso(new Date());
    const fmt = (n)=> Number(n||0).toLocaleString('en-KE',{minimumFractionDigits:2,maximumFractionDigits:2});
    const toast = (t)=>{ const el=$('toast'); el.textContent=t; el.classList.add('show'); clearTimeout(window._tt); window._tt=setTimeout(()=>el.classList.remove('show'),1500); };

    let SACCO_ID = null; let MATATUS=[]; let MAT_BY_ID=new Map();

    async function jget(p){ const r = await fetch(p,{ headers:{ Accept:'application/json' }}); const t = await r.text(); try{ const j=t?JSON.parse(t):{}; if(!r.ok) throw new Error(j.error||j.message||r.statusText); return j; }catch(e){ throw new Error(e.message||t||r.statusText); } }
    async function post(p,b){ const r = await fetch(p,{ method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(b)}); const t=await r.text(); try{ const j=t?JSON.parse(t):{}; if(!r.ok) throw new Error(j.error||j.message||r.statusText); return j; }catch(e){ throw new Error(e.message||t||r.statusText); } }

    async function loadSaccos(){ const sel=$('sacco'); sel.innerHTML=''; const res=await jget('/u/my-saccos'); (res.items||[]).forEach(s=>{ const o=document.createElement('option'); o.value=s.sacco_id; o.textContent=s.name||s.sacco_id; sel.appendChild(o); }); if(res.items?.length){ sel.value=res.items[0].sacco_id; SACCO_ID=sel.value; } }
    async function loadMatatus(){ if(!SACCO_ID) return; const res=await jget(`/u/sacco/${SACCO_ID}/matatus`); MATATUS=res.items||[]; MAT_BY_ID=new Map(MATATUS.map(m=>[m.id,m])); $('stat').textContent = `${MATATUS.length} matatu(s)`; }

    function isToday(ts){ return iso(ts) === today; }

    async function render(){
      if(!SACCO_ID) return;
      const tx = await jget(`/u/sacco/${SACCO_ID}/transactions?limit=1000`);
      const paid = (tx.items||[]).filter(t=>t.kind==='SAVINGS' && t.status==='SUCCESS' && isToday(t.created_at));
      const P = $('sv_paid'); P.innerHTML='';
      paid.sort((a,b)=> new Date(b.created_at)-new Date(a.created_at)).forEach(t=>{
        const plate = (MAT_BY_ID.get(t.matatu_id)||{}).number_plate || (t.matatu_id||'');
        const tr=document.createElement('tr'); tr.innerHTML = `<td>${new Date(t.created_at).toLocaleTimeString()}</td><td>${plate}</td><td>${fmt(t.fare_amount_kes)}</td>`; P.appendChild(tr);
      });

      const D = $('sv_due'); D.innerHTML='';
      MATATUS.forEach(m=>{
        const id=m.id; const amtId=`sv_amt_${id}`;
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${m.number_plate||''}</td><td class="mono">${id}</td>`+
          `<td><input id="${amtId}" type="number" placeholder="Amount" style="width:120px"/></td>`+
          `<td><button data-id="${id}">Collect</button></td>`;
        D.appendChild(tr);
      });
      D.onclick = async (e)=>{
        const btn=e.target.closest('button'); if(!btn) return; const id=btn.getAttribute('data-id'); const v=Number((document.getElementById(`sv_amt_${id}`)?.value)||0); if(!v) return toast('Enter amount'); btn.disabled=true; try{ await post('/api/staff/cash',{ sacco_id:SACCO_ID, matatu_id:id, kind:'SAVINGS', amount:v, payer_name:'Savings', payer_phone:''}); toast('Recorded'); await render(); }catch(err){ toast(err.message||'Error'); } finally{ btn.disabled=false; }
      };
    }

    $('sacco').onchange = async ()=>{ SACCO_ID=$('sacco').value; await loadMatatus(); await render(); };
    $('reload').onclick = async ()=>{ await loadSaccos(); await loadMatatus(); await render(); };

    await loadSaccos(); await loadMatatus(); await render();
  })();
  </script>
</body>
</html>

