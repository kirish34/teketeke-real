<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TekeTeke — SACCO Staff • Loan Repayment</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/public/css/dashboard-theme.css"/>
  <link rel="icon" href="/public/mobile/shared/icons/icon-192.png"/>
  <script src="/public/js/app-config.js"></script>
  <script src="/public/js/api.js"></script>
  <script src="/public/js/role-guard.js"></script>
</head>
<body>
  <div class="top-meta hero-card">
    <div class="hero-stack">
      <h2>Loan Repayment</h2>
      <div class="muted">Collect and track today's repayments</div>
    </div>
    <div class="hero-actions">
      <a class="btn ghost" href="/public/sacco/staff-daily.html">Daily Fee</a>
      <a class="btn ghost" href="/public/sacco/staff-savings.html">Savings</a>
      <a class="btn" href="/public/auth/role-select.html">Role Select</a>
      <span id="auth_state" class="pill">Checking sign-in…</span>
    </div>
  </div>

  <div class="bar">
    <label>SACCO <select id="sacco"></select></label>
    <button id="reload" class="ghost">Reload</button>
    <span class="right muted" id="stat"></span>
  </div>

  <section class="panel">
    <div class="section-title"><h3 style="margin:0">Due Today</h3><span class="muted" id="ln_today_counts"></span></div>
    <div class="card">
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Matatu</th>
              <th>Borrower</th>
              <th>Principal</th>
              <th>Model</th>
              <th>Term (m)</th>
              <th>Rate %</th>
              <th>Total</th>
              <th>Due today</th>
              <th>Collected</th>
              <th>Bal today</th>
              <th>Amount</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="ln_today"></tbody>
        </table>
      </div>
    </div>
  </section>

  <section class="panel">
    <div class="section-title"><h3 style="margin:0">Pending (Overdue)</h3><span class="muted" id="ln_overdue_counts"></span></div>
    <div class="card">
      <div class="table-wrap">
        <table>
          <thead><tr><th>Matatu</th><th>Borrower</th><th>Principal</th><th>Next due</th></tr></thead>
          <tbody id="ln_overdue"></tbody>
        </table>
      </div>
    </div>
  </section>

  <section class="panel">
    <div class="card"><h3>Collected Today</h3>
      <div class="table-wrap">
        <table>
          <thead><tr><th>Time</th><th>Matatu</th><th>Amount</th></tr></thead>
          <tbody id="ln_paid"></tbody>
        </table>
      </div>
    </div>
  </section>

  <div id="toast" role="status" aria-live="polite"></div>

  <script>
  (async function(){
    try{ await requireRole('SACCO_STAFF', { statusEl:'auth_state', roleLabel:'SACCO Staff' }); }catch(_){ return; }
    const $ = (id)=>document.getElementById(id);
    const iso = (d)=> new Date(d).toISOString().slice(0,10);
    const today = iso(new Date());
    const fmt = (n)=> Number(n||0).toLocaleString('en-KE',{minimumFractionDigits:2,maximumFractionDigits:2});
    const toast = (t)=>{ const el=$('toast'); el.textContent=t; el.classList.add('show'); clearTimeout(window._tt); window._tt=setTimeout(()=>el.classList.remove('show'),1500); };

    let SACCO_ID = null; let MATATUS=[]; let MAT_BY_ID=new Map();

    async function jget(p){ const r = await fetch(p,{ headers:{ Accept:'application/json' }}); const t = await r.text(); try{ const j=t?JSON.parse(t):{}; if(!r.ok) throw new Error(j.error||j.message||r.statusText); return j; }catch(e){ throw new Error(e.message||t||r.statusText); } }
    async function post(p,b){ const r = await fetch(p,{ method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(b)}); const t=await r.text(); try{ const j=t?JSON.parse(t):{}; if(!r.ok) throw new Error(j.error||j.message||r.statusText); return j; }catch(e){ throw new Error(e.message||t||r.statusText); } }

    async function loadSaccos(){ const sel=$('sacco'); sel.innerHTML=''; const res=await jget('/u/my-saccos'); (res.items||[]).forEach(s=>{ const o=document.createElement('option'); o.value=s.sacco_id; o.textContent=s.name||s.sacco_id; sel.appendChild(o); }); if(res.items?.length){ const qs=new URLSearchParams(location.search); const want=qs.get('sacco'); if (want && (res.items||[]).some(x=>String(x.sacco_id)===String(want))){ sel.value=want; } else { sel.value=res.items[0].sacco_id; } SACCO_ID = sel.value; } }
    async function loadMatatus(){ if(!SACCO_ID) return; const res=await jget(`/u/sacco/${SACCO_ID}/matatus`); MATATUS=res.items||[]; MAT_BY_ID=new Map(MATATUS.map(m=>[m.id,m])); $('stat').textContent = `${MATATUS.length} matatu(s)`; }

    function isToday(ts){ return iso(ts) === today; }

    // Balance helpers
    function addMonths(d, m){ const x=new Date(d); x.setMonth(x.getMonth()+m); return x; }
    function startOfDay(d){ const x=new Date(d); x.setHours(0,0,0,0); return x; }
    function countWeekdaysInclusive(start, end){ try{ let c=0, d=startOfDay(start), e=startOfDay(end); while(d<=e){ const w=d.getDay(); if(w>=1 && w<=5) c++; d.setDate(d.getDate()+1);} return Math.max(1,c);}catch(_){ return 1; } }
    function weeksInRange(start, end){ try{ const ms = startOfDay(end).getTime() - startOfDay(start).getTime(); return Math.max(1, Math.ceil(ms/(7*24*3600*1000))); }catch(_){ return 1; } }

    async function render(){
      if(!SACCO_ID) return;
      const [tx, loans] = await Promise.all([
        jget(`/u/sacco/${SACCO_ID}/transactions?limit=1000`),
        jget(`/u/sacco/${SACCO_ID}/loans/due-today`)
      ]);
      const paid = (tx.items||[]).filter(t=>t.kind==='LOAN_REPAY' && t.status==='SUCCESS' && isToday(t.created_at));
      const P = $('ln_paid'); P.innerHTML='';
      paid.sort((a,b)=> new Date(b.created_at)-new Date(a.created_at)).forEach(t=>{
        const plate = (MAT_BY_ID.get(t.matatu_id)||{}).number_plate || (t.matatu_id||'');
        const tr=document.createElement('tr'); tr.innerHTML = `<td>${new Date(t.created_at).toLocaleTimeString()}</td><td>${plate}</td><td>${fmt(t.fare_amount_kes)}</td>`; P.appendChild(tr);
      });

      // Collected today per matatu
      const paidSum = new Map();
      paid.forEach(t=>{ const id=t.matatu_id; const v=Number(t.fare_amount_kes||0); paidSum.set(id, (paidSum.get(id)||0)+v); });

      const paidTodayByMatatu = new Set(paid.map(t=>t.matatu_id));
      const D1 = $('ln_today'); const D2 = $('ln_overdue'); D1.innerHTML=''; D2.innerHTML='';
      (loans.items||[]).filter(x=>x.due_status==='TODAY').forEach(l=>{
        const plate = (MAT_BY_ID.get(l.matatu_id)||{}).number_plate || (l.matatu_id||'');
        const id = l.matatu_id || '';
        const amtId = `ln_amt_${id}`;

        const principal = Number(l.principal_kes||0);
        const ratePct = Number(l.interest_rate_pct||0);
        const total = principal * (1 + ratePct/100);
        const model = String(l.collection_model||'MONTHLY');
        const term = Math.max(1, Number(l.term_months||1));
        const start = l.start_date ? new Date(l.start_date) : new Date();
        const end = addMonths(start, term);
        let installments = term;
        if (model === 'DAILY') installments = countWeekdaysInclusive(start, end);
        else if (model === 'WEEKLY') installments = weeksInRange(start, end);
        const dueToday = installments>0 ? (total/installments) : total;
        const collectedToday = Number(paidSum.get(id)||0);
        const balToday = Math.max(0, dueToday - collectedToday);

        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${plate}</td><td>${l.borrower_name||''}</td>`+
          `<td>${fmt(principal)}</td>`+
          `<td>${model}</td>`+
          `<td>${term}</td>`+
          `<td>${ratePct}</td>`+
          `<td>${fmt(total)}</td>`+
          `<td>${fmt(dueToday)}</td>`+
          `<td>${fmt(collectedToday)}</td>`+
          `<td>${fmt(balToday)}</td>`+
          `<td><input id="${amtId}" type="number" placeholder="Amount" style="width:120px" value="${balToday.toFixed(2)}"/></td>`+
          `<td><button data-id="${id}">Collect</button></td>`;
        D1.appendChild(tr);
        if (paidTodayByMatatu.has(id)) tr.style.opacity = 0.7;
      });
      D1.onclick = async (e)=>{
        const btn=e.target.closest('button'); if(!btn) return; const id=btn.getAttribute('data-id'); const v=Number((document.getElementById(`ln_amt_${id}`)?.value)||0); if(!v) return toast('Enter amount'); btn.disabled=true; try{ await post('/api/staff/cash',{ sacco_id:SACCO_ID, matatu_id:id, kind:'LOAN_REPAY', amount:v, payer_name:'Loan repay', payer_phone:''}); toast('Recorded'); await render(); }catch(err){ toast(err.message||'Error'); } finally{ btn.disabled=false; }
      };

      // Render overdue into the Pending table
      try{
        (loans.items||[]).filter(x=>x.due_status==='OVERDUE').forEach(l=>{
          const plate = (MAT_BY_ID.get(l.matatu_id)||{}).number_plate || (l.matatu_id||'');
          const tr=document.createElement('tr');
          tr.innerHTML = `<td>${plate}</td><td>${l.borrower_name||''}</td>`+
            `<td>${fmt(l.principal_kes||0)}</td>`+
            `<td>${l.next_due_date||''}</td>`;
          D2.appendChild(tr);
        });
      }catch(_){ }

      // Update counts
      const c1 = document.getElementById('ln_today_counts'); if (c1) c1.textContent = `${(loans.items||[]).filter(x=>x.due_status==='TODAY').length} loan(s) due today, ${paid.length} collected today`;
      const c2 = document.getElementById('ln_overdue_counts'); if (c2) c2.textContent = `${(loans.items||[]).filter(x=>x.due_status==='OVERDUE').length} pending (overdue)`;

    }

    $('sacco').onchange = async ()=>{ SACCO_ID=$('sacco').value; await loadMatatus(); await render(); };
    $('reload').onclick = async ()=>{ await loadSaccos(); await loadMatatus(); await render(); };

    await loadSaccos(); await loadMatatus(); await render();
  })();
  </script>
</body>
</html>

